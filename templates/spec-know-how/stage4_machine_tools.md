# DD-{番号}: 機械ツール設計

| 作成日 | 更新日 | ステータス | ステージ |
|--------|--------|------------|----------|
| {日付} | {日付} | 進行中 | Stage 4 |

## 前提 DD

- Stage 2: 分析スコープ（完了必須）

## スキップ判定

### 判定条件
以下のいずれかに該当する場合:
- コードベースが小規模（総 LOC 500 未満 or モジュール 5 未満）
- 対象言語に適した AST/解析ツールが存在しない
- Stage 2 で機械ツール設計が「スキップ」と判定された

### 判定方法
Stage 2 の「Stage 4 DD のスキップ判定」テーブルを確認。

### スキップ時の記録
このDDをスキップする場合:
1. ステータスを「スキップ」に変更
2. スキップ理由を「決定事項」セクションに記録
3. ポートフォリオインデックス DD の該当行を更新
4. **注意**: Stage 4 スキップ時、Stage 5 も自動的にスキップとなる。
   Stage 3 の成果物が最終仕様となるが、信頼度は Medium が上限。

## 目的

Stage 3 の仕様を機械的に検証するためのツールを設計・作成する。
AST 解析、SQL 解析、正規表現抽出等で事実データを自動抽出する。

## 背景・課題

LLM による仕様抽出だけでは根拠が不十分。
機械的に検証可能なデータと突合することで、信頼度を High に引き上げる。

## 検討内容

### 抽出ツール候補

| ツール | 対象 | 出力 | 実現可能性 |
|--------|------|------|-----------|
| AST 解析 | Python/JS/TS のソースコード | 関数一覧、型情報、呼出関係 | |
| SQL 解析 | マイグレーション/クエリ | テーブル定義、リレーション | |
| 正規表現 | 定型パターン | 定数、設定値、URL 等 | |
| モデル解析 | ORM 定義 | フィールド一覧、バリデーション | |

## 決定事項

（設計・実装完了後に記入）

## 成果物

| 成果物 | 配置先 | 状態 |
|--------|--------|------|
| 抽出ツール群 | `tools/verify/` | 未作成 |
| ツール検証レポート | 本 DD 内 | 未作成 |
| 既知の制限事項 | 本 DD 内 | 未作成 |
| 機械抽出結果（JSON/CSV） | `doc/spec/machine-facts/` | 未作成 |

## タスク一覧

### Phase 0: 事前精査
- [ ] 📋 各 Phase のタスク精査・詳細化
- [ ] 📋 Stage 2 で選定された抽出戦略の確認
- [ ] 📋 対象言語で利用可能な解析ライブラリの調査
- [ ] 😈 **Devil's Advocate調査**

### Phase 1: ツール設計
- [ ] 各ツールの入力/出力仕様を定義
- [ ] 出力フォーマットの統一（JSON スキーマ）
- [ ] ツール間の連携方法を設計
- [ ] 😈 **DA批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: ツール実装
- [ ] 各ツールの実装
- [ ] 単体テスト（ゴールデンケースで検証）
- [ ] エラーハンドリング（解析失敗時の graceful degradation）
- [ ] 😈 **DA批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 3: 検証と制限事項
- [ ] サンプルデータでの動作検証
- [ ] 既知の制限事項の文書化（解析できないパターン）
- [ ] 偽陽性/偽陰性の評価
- [ ] 😈 **DA批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 4: 全体抽出の実行
- [ ] 対象コードベース全体に対してツールを実行
- [ ] 結果を `doc/spec/machine-facts/` に出力
- [ ] 抽出結果のサマリーを作成
- [ ] 😈 **DA批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

## ログ

### {日付}
- DD作成（spec-know-how 起動時に自動生成）

---

## DA批判レビュー記録

### Phase N DA批判レビュー

**DA観点:** （このPhaseで最も壊れやすいポイントは何か？）

| # | 発見した問題/改善点 | 重要度 | 再現手順（高/中は必須） | DA観点 | 対応 |
|---|-------------------|--------|----------------------|--------|------|
| 1 | (具体的に記述) | 高/中/低 | (高/中: 操作→結果) | (どのDA観点で発見したか) | ✅修正済/⏭️別DD/❌不要 |
