---
name: spec-know-how
description: レガシーコードベースから仕様を抽出・検証し、信頼度付きの知識基盤を構築するオーケストレーター
---

# spec-know-how スキル

レガシーシステムのソースコードから**仕様を抽出・検証し、信頼度付きの知識基盤を構築する**ためのオーケストレーションスキルです。

## 前提条件

> **dd-know-how（Level 2 以上）が必須です。**
>
> このスキルは DD（Design Document）を起票・管理するオーケストレーターです。
> DD の実体管理（作成・参照・一覧・アーカイブ）と DA 批判レビューは **dd-know-how** が担います。
> 導入先プロジェクトに `/dd` と `/workflow` スキルが存在しない場合、Phase 1 以降の DD 起票指示が機能しません。
>
> 導入手順は [IMPORT.md](IMPORT.md) を参照してください。

## 1. 中核思想

### 1.1 抽出情報 + 機械検証 + 信頼度

- LLM 解釈のみで仕様化しない
- 機械抽出ツール（AST解析、SQL抽出、モデル抽出等）の結果と突合し、信頼度を付与する
- 出力は「回答・根拠・信頼度」をワンセットで扱う

### 1.2 QA は中核機能

- 「この仕様どうだっけ？」への即応が価値
- 回答時に該当箇所（仕様書/コード行）を示す
- 根拠不足時は断定しない

### 1.3 FR/NFR の二軸で抽出する

- 個別機能（FR）だけを追うと非機能要件（NFR）が抜ける
- NFR（ログ/セキュリティ/監査/運用）を独立トラックで管理する
- UI 操作モデル（グリッド操作等）は個別画面仕様と別に管理する

---

## 2. 責務

### このスキルが担うこと

- 抽出のオーケストレーション（Phase 制御）
- 質問による前提確定
- DD への起票指示（FR/NFR/UI操作モデル/抽出実行）
- 突合結果に基づく信頼度付与
- QA 向けインデックス化
- 改善課題の収束管理

### 非責務

- 新システム実装 DD の自動生成・自動実行
- 人間主導の実装計画の代行

---

## 3. フェーズ定義

### Phase 0: システム確認ヒアリング（必須）

**目的**: 抽出対象、抽出難易度、抽出方式を確定する。

**最低限の質問**:

1. 移行元: 言語/Fレームワーク/DB/構成
2. 移行先: 言語/フレームワーク/DB/構成
3. 主対象ドメイン（例: 勤怠管理、受発注、在庫管理 等）
4. 重要 NFR（ログ/セキュリティ/監査/性能/運用）
5. 既存ドキュメントの所在
6. コードアクセス範囲
7. 信頼性要件（どこまで機械裏付けが必要か）
8. 法務/機密/PII 制約（持ち出し可否、匿名化要否、監査証跡要件）

**成果物**:

- `project-profile` — 対象システムの概要
- `extraction-scope` — 抽出対象と除外対象
- `extraction-strategy-draft` — 抽出戦略案
- `compliance-constraints` — 法務・機密制約

---

### Phase 1: 抽出計画の分割（FR/NFR）

**目的**: 機能偏重を防ぎ、非機能要件を独立管理する。

**オーケストレーター指示**:

- FR 抽出 DD を起票
- NFR 抽出 DD を起票
- UI 操作モデル抽出 DD を起票（該当する場合）

**DD カテゴリ例**:

- `DD-FR-*` — 機能要件
- `DD-NFR-*` — 非機能要件
- `DD-UXM-*` — UI 操作モデル

---

### Phase 2: 機械抽出戦略の確定（可変型）

**目的**: 移行元システムの構造差に応じた抽出方式を選定する。

**選定観点**:

| 層 | 抽出候補 |
|----|---------|
| 言語構造 | AST 解析 / パターンマッチ / 正規表現 |
| データ層 | ORM 定義抽出 / SQL 文抽出 / マイグレーション解析 |
| UI 層 | 画面定義 / コンポーネント構造 / イベントハンドラ |
| NFR 層 | ログ出力 / 認可チェック / 例外経路 |

**オーケストレーター指示**:

1. 候補モジュールを提示
2. 人間に有効化モジュールを選択してもらう
3. 選択を実行 DD に落とす

---

### Phase 2.5: 抽出器妥当性検証（必須）

**目的**: 抽出器の誤りを `High` 信頼度に持ち込まないため、抽出器自体の品質を先に確認する。

**実施内容**:

- サンプルケースでの期待値比較（ゴールデンケース）
- 既知パターンの回帰テスト
- 抽出対象外/失敗条件の明示
- **NFR 項目の要件適合性サンプルチェック** — 「コードが存在する」と「要件を満たしている」は別。機械抽出がログ出力コードを発見しても監査要件を完全に満たすとは限らない

**成果物**:

- `extractor-validation-report`
- `extractor-known-limitations`

---

### Phase 3: 機械抽出実行と証拠化

**目的**: LLM 解釈と独立した事実データを得る。

**実行内容（DD 側）**:

- 関数/型/SQL/状態遷移/認可条件/ログポイント等の抽出
- 構造化出力（JSON 等）
- 実行ログと再現手順の保存

**成果物**:

- `machine-facts` — 機械抽出の事実データ
- `extraction-evidence` — 実行証拠

---

### Phase 4: 仕様生成と突合

**目的**: 仕様を生成し、機械抽出事実と突合する。

#### 信頼度ルール（4段階）

| 信頼度 | 定義 | 運用上のアクション |
|--------|------|-------------------|
| `High` | 妥当性検証済み抽出器で機械裏付けあり、参照明確 | そのまま利用可 |
| `Medium` | 一部裏付けあり、一部推論 | 注意付きで利用可、改善は任意 |
| `Low` | 根拠不足、未検証 | 利用前に調査が必要 |
| `Conflicting` | 根拠が存在するが相互に矛盾 | **解消するまで利用不可（ブロッキング）** |

> **設計根拠**: `Low` と `Conflicting` は質的に異なる。矛盾は「止まれ」を意味し、分離しないと既知の矛盾を無視して実装に進むリスクがある。

#### 信頼度の降格ルール

- 根拠参照先のコードが変更された場合、当該仕様項目を `stale` にマークし再評価を要求する
- 一度 `High` と判定された項目も、根拠が無効化されれば降格対象
- 降格トリガーは Phase 5 の stale フラグ方式と共通の仕組みで運用する

#### 最小出力

- 仕様項目
- 根拠参照（仕様書/コード行/抽出物）
- 信頼度（4段階）
- 未解消事項

---

### Phase 5: QA インデックス化

**目的**: 仕様問い合わせに即答できる状態を作る。

#### QA 応答要件

1. 回答
2. 信頼度（4段階）
3. 根拠（該当ドキュメント/コード行）
4. 対象コミット SHA（短縮7桁）
5. 生成日時（UTC, ISO 8601）

#### 信頼度の横断整合性ルール

- **QA 回答の信頼度 ≦ 元仕様項目の信頼度** — 仕様項目が `Medium` なら QA 回答も最大 `Medium`
- 仕様項目が `Conflicting` の場合、QA 回答は矛盾を明示し断定しない

#### 表示フォーマット

インライン回答時（コンパクトフッター）:

```
[回答本文]

---
信頼度: High | 根拠: path/to/source.py:42-58 | 生成: 2025-01-15T10:30Z @ abc1234
```

監査レベルのメタ情報（フルSHA、抽出器バージョン、抽出手法名）は別ファイル/別セクションの監査ログに記録する。

#### QA インデックス鮮度管理（stale フラグ方式）

即時再生成ではなくマーキング優先で運用する。

| トリガー | 優先度 | アクション |
|---------|--------|-----------|
| 根拠参照先ファイルのコード変更 | 最高 | 該当 QA エントリを `stale` にマーク |
| 仕様書の更新 | 高 | 関連 QA エントリを `stale` にマーク |
| 抽出器の更新 | 中 | 全 QA エントリを `potentially_stale` にマーク |
| リリース前チェック | 定期 | 全 `stale` エントリの再生成を強制 |

**運用ルール**:

- `stale` マークされた QA を参照する場合、回答に `stale（要再検証）` を自動付記
- リリース前 Gate で `stale` が 0 件であることを完了条件とする
- 最終生成時刻と直近生成元コミット SHA を保持する

---

### Phase 6: 問題発見と継続ブラッシュアップ（反復）

**目的**: 「既知の課題対応」だけでなく、生成 AI にも問題発見を担わせ、解決条件を満たすまで改善を反復する。

**実施内容**:

- **問題発見**:
  - 仕様、抽出結果、QA 応答を入力に blind spot を探索
  - 新規課題を問題発見バックログに記録
- **外部 AI 評価**:
  - 複数 LLM へ課題を投下し意見収集
  - 比較・統合して改善案を収束
- **収束管理**:
  - 各課題に「解決条件（Acceptance Criteria）」を定義
  - 条件達成まで DD 起票 → 修正 → 再評価をループ

#### ポートフォリオ完了基準

- `Conflicting` 信頼度の仕様項目が 0 件
- 高重要度の未解決課題に全て対応方針（DD or 保留理由）がある
- 中重要度以下は未解決でも完了可（バックログに残す）

**成果物**:

- 問題発見バックログ
- 外部 AI 評価記録
- 改善ログ（解決条件ベース）

---

## 4. 責務境界

### ワークフロー（このスキル）が担うこと

- フェーズ制御
- 質問での前提確定
- DD 起票指示
- 信頼度判定ルールの適用
- 鮮度判定と再生成トリガー管理
- 改善課題の収束管理（解決条件の達成確認）

### DD / 抽出タスクが担うこと

- 抽出と解析の実行
- 証拠の記録
- 修正・再実行

---

## 5. Gate 定義（フェーズ完了判定）

### Gate 0（ヒアリング完了）

- 移行元/移行先/対象ドメイン/NFR 優先度が明記されている
- 抽出対象と除外対象が定義されている
- 法務/機密/PII 制約が記録されている

### Gate 1（抽出計画完了）

- FR 抽出 DD、NFR 抽出 DD、UX 操作モデル DD が起票されている

### Gate 2（機械抽出完了）

- 抽出結果と実行証拠が保存されている
- 抽出漏れ・失敗が記録されている

### Gate 2.5（抽出器妥当性確認完了）

- 抽出器検証レポートがある
- 既知制約が明文化されている

### Gate 3（仕様完了）

- 各仕様項目に根拠参照がある
- 各仕様項目に信頼度（4段階）がある
- `Conflicting` 項目が残っている場合は次フェーズに進めない（ブロッキング）

### Gate 4（QA 化完了）

- QA 回答テンプレートで回答可能
- 根拠行に遷移できる
- 対象コミット SHA と生成日時が回答メタ情報として出力される

### Gate 5（継続改善完了）

- `Conflicting` 信頼度の仕様項目が 0 件
- 各重要課題に解決条件が定義されている
- 高重要度の未解決課題に全て対応方針（DD or 保留理由）がある
- 中重要度以下は未解決でも完了可（バックログに残す）

---

## 6. 受入条件（Definition of Done）

以下を満たしたら、仕様抽出フェーズを完了とする。

1. FR/NFR/UXM の 3 領域が抽出済み
2. 未解消事項が一覧化されている
3. QA 応答が根拠付きで再現可能
4. 実装チームへ引き渡す入力一式が揃っている
5. QA インデックス鮮度（最終更新時刻・生成元コミット）が記録されている
6. 問題発見と改善ログが記録されている

---

## 7. 参照資料

| ディレクトリ | 内容 |
|-------------|------|
| `references/design/` | 設計書（ベース思想、ワークフロー、DD連携、チェックリスト、実行手順） |
| `references/examples/` | 実行例（DD-002: ドキュメント棚卸し、DD-003: 業務ロジック仕様抽出） |
| `references/methodology/` | 方法論・教訓（5ステップ抽出プロセス、44DD以上の経験からの教訓） |
| `references/skills/` | 実装済みスキル例（verify, qa, workflow, dd, review, review-spec） |
| `references/background/` | 背景・思想（意思決定記録、Document-First/Verify-First の根拠、DDテンプレート） |
