---
name: spec-know-how
description: レガシーコードベースから仕様を抽出・検証し、信頼度付きの知識基盤を構築するオーケストレーター
---

# spec-know-how スキル (v0.2)

レガシーシステムのソースコードから**仕様を抽出・検証し、信頼度付きの知識基盤を構築する**ためのオーケストレーションスキルです。

**v0.2 の方針**: 起動したら問答無用で DD を一括作成し、DD の中で考える。会話ベースの Phase 進行は廃止。

## 前提条件

> **dd-know-how（Level 2 以上）が必須です。**
>
> このスキルは DD（Design Document）を起票・管理するオーケストレーターです。
> DD の実体管理（作成・参照・一覧・アーカイブ）と DA 批判レビューは **dd-know-how** が担います。
> 導入先プロジェクトに `/dd` と `/workflow` スキルが存在しない場合、DD 起票が機能しません。
>
> 導入手順は [IMPORT.md](IMPORT.md) を参照してください。

---

## 1. 中核思想

### 1.1 抽出情報 + 機械検証 + 信頼度

- LLM 解釈のみで仕様化しない
- 機械抽出ツール（AST解析、SQL抽出、モデル抽出等）の結果と突合し、信頼度を付与する
- 出力は「回答・根拠・信頼度」をワンセットで扱う

### 1.2 QA は中核機能

- 「この仕様どうだっけ？」への即応が価値
- 回答時に該当箇所（仕様書/コード行）を示す
- 根拠不足時は断定しない

### 1.3 FR/NFR の二軸で抽出する

- 個別機能（FR）だけを追うと非機能要件（NFR）が抜ける
- NFR（ログ/セキュリティ/監査/運用）を独立トラックで管理する
- UI 操作モデル（グリッド操作等）は個別画面仕様と別に管理する

### 1.4 構造の中で判断する

- 会話で段階的に発見するのではなく、あらかじめ全ての DD を作成する
- 各 DD の中で「実行するか/スキップするか」を判断し、記録する
- スキップも意思決定であり、判断の痕跡を残す

---

## 2. 責務

### このスキルが担うこと

- DD ポートフォリオの一括作成（起動プロトコル）
- DD 間の依存関係管理
- 信頼度判定ルールの適用
- QA 向けインデックス化
- スキップ判定の記録管理

### DD が担うこと

- 各 DD 内のタスク実行
- 抽出と解析の実行
- 証拠の記録
- DA 批判レビュー

### 非責務

- 新システム実装 DD の自動生成・自動実行
- 人間主導の実装計画の代行

---

## 3. 起動プロトコル

spec-know-how が起動されたら、以下を **会話なしで即座に実行** する。

### Step 1: コードベースの確認

- ユーザーから対象コードベースのパスを受け取る
- パスの存在確認
- 技術スタックの自動検出（package.json, requirements.txt, go.mod, Gemfile 等）

### Step 2: DD ポートフォリオの一括作成

`templates/spec-know-how/` の全テンプレートから DD を一括作成する。
DD 番号は `/dd new` の連番ルールに従う。

作成する DD（12 件）:

| 順番 | テンプレート | DD タイトル |
|------|------------|-----------|
| 1 | `portfolio_index.md` | 仕様抽出ポートフォリオインデックス |
| 2 | `stage1_quantitative_inventory.md` | 定量棚卸し |
| 3 | `stage2_analysis_scope.md` | 分析スコープ |
| 4 | `stage3_fr_extraction.md` | FR 仕様抽出 |
| 5 | `stage3_dataflow_extraction.md` | データフロー抽出 |
| 6 | `stage3_state_management.md` | 状態管理抽出 |
| 7 | `stage3_error_handling.md` | エラー処理抽出 |
| 8 | `stage4_machine_tools.md` | 機械ツール設計 |
| 9 | `stage5_final_spec.md` | 最終仕様 |
| 10 | `post_migration_design.md` | 移行先設計 |
| 11 | `post_nfr_review.md` | NFR 総合レビュー |
| 12 | `post_ui_requirements.md` | UI 要件 |

### Step 3: ポートフォリオインデックスの初期化

- 全 DD の番号をポートフォリオインデックス DD に記入
- 依存関係を記入
- 対象システム情報欄にコードベースパスを記入

### Step 4: Stage 1 の即時実行開始

- DD 作成完了後、即座に Stage 1（定量棚卸し）の実行を開始する
- ユーザーへの確認は不要

---

## 4. DD ポートフォリオ定義

### 4.1 Stage 1: 定量棚卸し

コードベースの全体像を定量的に把握する。ファイル数、関数数、モジュール構造、依存マップを作成。
**スキップ不可**。全ての後続 DD の基盤。

### 4.2 Stage 2: 分析スコープ

Stage 1 のデータに基づき、広さと深さを決定する。
各モジュールを「深い/浅い/スキップ」に分類し、Stage 3〜Post の全スキップ判定を行う。
**スキップ不可**。

### 4.3 Stage 3: 仕様抽出 DD 群（4 種）

| DD | 対象 | スキップ条件 |
|----|------|-------------|
| FR 仕様抽出 | 業務ロジック・ビジネスルール | Stage 2 で不要判定 |
| データフロー抽出 | データの流れ・DB・外部連携 | Stage 2 で不要判定 |
| 状態管理抽出 | 画面状態・セッション・権限 | Stage 2 で不要判定 |
| エラー処理抽出 | バリデーション・例外・エラーハンドリング | Stage 2 で不要判定 |

Stage 3 の DD 群は互いに依存しないため、**並列実行可能**。

### 4.4 Stage 4: 機械ツール設計

機械的検証ツール（AST/SQL/正規表現等）を設計・作成する。
Stage 2 に依存し、Stage 3 と**並列実行可能**。
**スキップ条件**: 小規模（LOC 500 未満 or モジュール 5 未満）、またはツール不適合。

### 4.5 Stage 5: 最終仕様

Stage 3 の人的仕様と Stage 4 の機械結果を突合し、信頼度付き最終仕様を生成する。
**スキップ条件**: Stage 4 がスキップされた場合（Stage 3 が最終仕様となるが、信頼度上限は Medium）。

### 4.6 Post DD 群（3 種）

| DD | 対象 | スキップ条件 |
|----|------|-------------|
| 移行先設計 | 移行先アーキテクチャ | 移行予定なし |
| NFR 総合レビュー | 非機能要件の横断レビュー | **スキップ不可** |
| UI 要件 | 業務アプリ UI パターン | UI なしシステム |

Post DD 群は互いに依存しないため、**並列実行可能**。

### 実行順序（依存関係）

```
Stage 1 → Stage 2 → Stage 3 群（並列可）
                   → Stage 4（Stage 3 と並列可）
                        ↓
                   Stage 5（Stage 3 + 4 完了後）
                        ↓
                   Post 群（並列可）
```

---

## 5. DD 実行プロトコル

### 5.1 依存関係ベースの実行

各 DD の「前提 DD」セクションに記載された DD が完了するまで、その DD の実行を開始しない。
v0.1 の Gate 方式は廃止。完了判定は各 DD 内のタスクリストで管理する。

### 5.2 スキップ判定（2 パス方式）

1. **作成時評価**: 技術スタック自動検出の結果から明らかなスキップ候補をマーク
   - 例: フロントエンドファイルがない → UI 要件 DD を「スキップ候補」に
2. **実行時評価**: 前提 DD の完了後、スキップ条件を再評価して最終判定
   - 例: Stage 2 完了 → Stage 3 各 DD の実行/スキップを確定

### 5.3 スキップの記録

DD をスキップする場合:
1. DD のステータスを「スキップ」に変更
2. スキップ理由を「決定事項」セクションに記録
3. ポートフォリオインデックス DD の該当行を更新

**DD は削除しない**。スキップも意思決定であり、痕跡を残す。

### 5.4 ポートフォリオインデックスの更新

各 DD の完了/スキップ時に、ポートフォリオインデックス DD のテーブルを更新する。
ポートフォリオインデックスは全体の進捗ダッシュボードとして機能する。

---

## 6. 信頼度モデル（4 段階）

| 信頼度 | 定義 | アクション |
|--------|------|-----------|
| `High` | 妥当性検証済み抽出器で機械裏付けあり、参照明確 | そのまま利用可 |
| `Medium` | 一部裏付けあり、一部推論 | 注意付きで利用可 |
| `Low` | 根拠不足、未検証 | 利用前に調査が必要 |
| `Conflicting` | 根拠が存在するが相互に矛盾 | **解消するまで利用不可（ブロッキング）** |

### 降格ルール

- 根拠参照先のコードが変更された場合、当該仕様項目を `stale` にマークし再評価を要求
- 一度 `High` と判定された項目も、根拠が無効化されれば降格対象

### Stage 4 スキップ時の制約

Stage 4（機械ツール設計）がスキップされた場合、機械裏付けがないため:
- 全仕様項目の信頼度上限は `Medium`
- `High` への昇格には機械検証が必要

---

## 7. QA 応答要件

### 必須メタ情報

1. 回答
2. 信頼度（4段階）
3. 根拠（該当ドキュメント/コード行）
4. 対象コミット SHA（短縮7桁）
5. 生成日時（UTC, ISO 8601）

### 横断整合性ルール

- **QA 回答の信頼度 ≦ 元仕様項目の信頼度**
- 仕様項目が `Conflicting` の場合、QA 回答は矛盾を明示し断定しない

### 表示フォーマット

```
[回答本文]

---
信頼度: High | 根拠: path/to/source.py:42-58 | 生成: 2025-01-15T10:30Z @ abc1234
```

### 鮮度管理（stale フラグ方式）

| トリガー | アクション |
|---------|-----------|
| 根拠参照先ファイルのコード変更 | 該当 QA エントリを `stale` にマーク |
| 仕様書の更新 | 関連 QA エントリを `stale` にマーク |
| 抽出器の更新 | 全 QA エントリを `potentially_stale` にマーク |

---

## 8. 受入条件（Definition of Done）

以下を満たしたら、仕様抽出を完了とする。

1. ポートフォリオインデックス DD の全 DD が「完了」または「スキップ」
2. `Conflicting` 信頼度の仕様項目が 0 件
3. スキップされた DD に全てスキップ理由が記録されている
4. 実行された Stage 3 DD に信頼度サマリーが記入されている
5. QA 応答が根拠付きで再現可能（Stage 5 完了時）
6. 未解消事項が一覧化されている

---

## 9. 参照資料

| ディレクトリ | 内容 |
|-------------|------|
| `templates/spec-know-how/` | DD テンプレート群（12 種、起動時に一括使用） |
| `references/design/` | 設計書（ベース思想、ワークフロー、DD連携、チェックリスト） |
| `references/examples/` | 実行例（DD-002: ドキュメント棚卸し、DD-003: 業務ロジック仕様抽出） |
| `references/methodology/` | 方法論・教訓（5ステップ抽出プロセス、44DD以上の経験からの教訓） |
| `references/skills/` | 実装済みスキル例（verify, qa, workflow, dd, review, review-spec） |
| `references/background/` | 背景・思想（意思決定記録、DDテンプレート） |
