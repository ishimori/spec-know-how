# DD-002: SP-001 テンプレート設計（初回調査）

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-24 | 2026-02-24 | 人間が確認中 |

## 目的

SP-001（初回調査）の親チケットテンプレートを設計・作成する。

## 背景・課題

既存の `sample_prompts/01_初回調査.md` は環境差異に対応できず、
Claude が意図しない動作をすることがある（例: 存在しないサブシステムを調査しようとする）。

SP-001 では SP-000 の環境プロファイルを参照し、
ユーザーに確認してから環境に適した子チケットを動的生成する設計にする。

## 検討内容

`sample_prompts/01_初回調査.md` のポイント：
- コードベースの定量把握（ディレクトリ構造・技術スタック・LOC）
- 既存ドキュメントの棚卸し
- ファイル数300以上またはサブシステム複数時に 2〜3 DD への分割推奨

SP-001 として再設計する際の論点：
- SP-000 のどの情報を参照して確認するか
- 子チケット（SP-001-01, SP-001-02）の分割トリガーをどう定義するか

## 決定事項

### 環境確認フロー（SP-001 冒頭の手順）

1. **SP-000 完了確認**: SP-000 のステータスが「完了」でなければ先に SP-000 を実施するよう促す
2. **SP-000 参照**: Q3（コードベースのパス/URL）・Q5（既存ドキュメント有無）を取得
3. **計測（Claude 実行）**: ファイル数・LOC・サブシステム数を計測してユーザーに提示
4. **分割要否の確認**: ファイル数 300 以上 or サブシステム複数の場合、分割を提案してユーザーが判断

### 調査方針の分岐

| SP-000 Q5 | 調査方針 |
|-----------|---------|
| ドキュメントあり | 棚卸しから開始。信頼度ラベル（VERIFIED/DRAFT/UNVERIFIED）を付与しながら進む |
| ドキュメントなし | コードから直接調査 |
| 一部あり | 棚卸し + コード直接調査を併用 |

### 子チケット動的生成

- **分割トリガー**: ファイル数 300 以上 または サブシステムが複数混在
- **分割パターン例**: サブシステム別（SP-001-01 フロントエンド / SP-001-02 バックエンド）、ドメイン別
- **統合フロー**: 子チケットは並行実行可能。親 SP-001 の完了条件 = 全子チケット完了 + コンテキストファイル設計完了。横断分析は親チケットが担当

### GUIDE.md Step 1 との対応

完全対応（コードベースの定量把握・既存ドキュメント棚卸し・CLAUDE.md 索引登録の 3 点すべてが SP-001 の作業に対応）

## 成果物

| Phase | ファイル | 説明 |
|-------|---------|------|
| Phase 2 | [doc/SP/SP-001.md](doc/SP/SP-001.md) | SP-001 親チケットテンプレート |
| Phase 2 | [doc/SP/SP-001-01〜03.md, context, gate](doc/SP/) | SP-001 子チケット群 |
| Phase 3 | （本 DD 末尾の申し送りセクション） | SP-002〜006 設計基準 |

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各 Phase のタスク精査・詳細化**
- [x] `sample_prompts/01_初回調査.md` を読んで SP 形式への転換ポイントを整理する
- [x] 😈 **Devil's Advocate 調査**
  - SP-000 参照で初回調査が環境対応できるか？→ Q5（既存ドキュメント）は対応可。ファイル数/サブシステム数は SP-000 にないため SP-001 実行時に計測が必要
  - 子チケット分割トリガーは明確か？→ 300ファイル/複数サブシステム基準は継承可。分割後の子チケット統合フローは未定義 → Phase 1 で設計

### Phase 1: 設計
- [x] SP-001 の「環境確認フロー」を設計する
  - SP-000 Q5（既存ドキュメント有無）を参照して調査方針を分岐させる
  - SP-001 冒頭で Claude がファイル数・LOC を計測するステップを追加する（SP-000 にはない情報のため）
- [x] 子チケット動的生成の条件・分割パターンを定義する
  - 分割トリガー: ファイル数 300 以上 or サブシステム複数
  - 分割後の統合フロー（並行 or 順次、親 SP-001 の完了条件）を定義する
- [x] GUIDE.md Step 1 との対応を確認する（完全対応）
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: 実装
- [x] SP-001 テンプレートファイルを作成する（`doc/SP/SP-001.md`）
- [x] テンプレートで環境確認フロー・子チケット生成指示が機能するか確認する
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 3: SP-001 設計パターンの SP-002〜006 への展開

> SP-001 で確立した設計原則を DD-003〜007 に引き継ぐための申し送りフェーズ。

- [x] SP-001 で確立した設計パターン一覧を整理し、末尾「申し送り」に記録した
- [x] DD-003（SP-002）以降の担当者がこの申し送りを参照できることを確認した

## ログ

### 2026-02-24
- DD 作成（DD-001 Phase 2 の切り出し）
- Phase 0 完了: `sample_prompts/01_初回調査.md` 精査、DA 批判レビュー実施、Phase 1・2 タスク詳細化
- Phase 1 完了: 環境確認フロー・調査方針分岐・子チケット統合フロー設計、GUIDE.md Step 1 対応確認、DA 批判レビュー実施
- Phase 2 完了: `doc/SP/SP-001.md` 作成、動作確認、DA 批判レビュー実施
- 追加修正: SP-001 を親管理チケット化（常に SP-001-01 を作成、追加タスク発覚時に SP-001-02 以降を動的追加する設計に変更）
- 追加修正: SP-001-01〜03、context、gate の子チケットを個別ファイルとして分離
- 追加修正: 各子チケットに DA 分析・コンテキスト回収・発覚した追加タスクを追加
- 追加修正: SP-000 にグループF（機械処理言語 Q14）を追加
- 追加修正: Gate チェックを子チケット化（機械検証 + LLM 検証 + DA + サマリー）
- Phase 3 追加: SP-001 設計パターン横断展開の申し送りフェーズを追記

---

## DA 批判レビュー記録

### Phase 0 DA 批判レビュー

**DA 観点:** SP-000 参照で初回調査が環境対応できるか？分割トリガーは明確か？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | SP-000 に「ファイル数/サブシステム数」がない。分割トリガーの判断材料が SP-000 から取れない | Medium | SP-001 冒頭で Claude が計測するステップが必要 | Phase 1 の「環境確認フロー」に計測ステップを追加 |
| 2 | 子チケット分割後の統合フロー（並行/順次・親チケット完了条件）が未定義 | Medium | 分割した子チケットが完了しても親 SP-001 の完了判定が曖昧 | Phase 1 で統合フローを設計 → 対応済み |

### Phase 1 DA 批判レビュー

**DA 観点:** このフェーズの設計が実際に機能するか？何が壊れるか？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | SP-000 が未完了の状態で SP-001 を開始すると、コードベースのパスも既存ドキュメント情報も取得できず動作不能になる | High | SP-001 冒頭に SP-000 完了確認ステップがないと、ユーザーが気づかずに進んでしまう | SP-001 冒頭の「⚠️ 必読」セクションに「SP-000 完了を前提とする」と明記し、未完了時は先に SP-000 を実施するよう促す → 対応済み |

### Phase 2 DA 批判レビュー

**DA 観点:** 作成した SP-001.md が実際のプロジェクトで機能するか？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | 「一部あり」のとき、どの棚卸し項目をやってどの項目をスキップするかが不明確。Claude もユーザーも判断が必要 | Medium | 境界が曖昧だと調査漏れが生じる可能性がある | 許容範囲とする（過度な複雑化を避ける）。「一部あり」時は Claude が判断を都度ユーザーに確認することで対応 |

---

## SP-001 設計パターン申し送り（DD-003〜007 向け）

> SP-002〜006 を設計する DD では、以下のパターンを踏襲すること。
> SP-001 の設計過程で確立した原則をまとめたもの。

### 1. 親チケットの設計方針

- **親チケットは軽量管理チケットのみ**（Step 一覧 + 管理記録 + 子チケット一覧）
- 親チケットに作業内容・テンプレートを埋め込まない（肥大化防止）
- 目安: 親チケットは 80 行以内

### 2. 子チケットの命名規則

| ファイル名 | 役割 | 起票タイミング |
|-----------|------|-------------|
| `SP-{N}-01.md`, `SP-{N}-02.md`... | 標準作業チケット | 常に作成（SP に応じて内容設計） |
| `SP-{N}-context.md` | コンテキストファイル設計 | 常に作成・全作業チケット完了後 |
| `SP-{N}-gate.md` | Gate チェック | 常に作成・最後に実行 |
| `SP-{N}-04.md`... | 動的追加チケット | 追加タスク発覚時のみ |

動的追加の採番: context/gate を除く既存子チケットの最大番号 + 1

### 3. 各子チケットの末尾必須セクション

全ての子チケット（context・gate 含む）に以下を含めること：

```markdown
## DA 分析（このチケットのスコープ限定）

> 「このチケットの作業で何を見落としているか？」の観点で確認する。
> 問題がなければ「なし」と記録すること。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| - | なし | - | - |

---

## コンテキスト回収

- [ ] コンテキストにしか残っていない重要な情報がないか確認した

---

## 完了時の確認

- [ ] SP-{N} の子チケット一覧の本チケットを「完了」に更新した
```

**重要ルール:** DA 分析の「問題がなければ『なし』と記録すること」は必須。
LLM が問題を無理に作り出す誤検出を防ぐため。

### 4. Gate チェック子チケット（`SP-{N}-gate.md`）の構成

| # | セクション | 禁止事項 |
|---|-----------|---------|
| 1 | 前提確認（LLM）: 全先行子チケットのステータス確認 | - |
| 2 | 機械検証: 実コマンドを実行して結果を記録 | 推測・記憶に頼った記入禁止 |
| 3 | LLM 検証: 先行子チケットのファイルを実際に読んで確認 | 「たぶん書いてあった」禁止 |
| 4 | DA 分析（全体横断）: 各子チケットスコープを超えた横断確認 | - |
| 5 | コンテキスト最終回収: 会話コンテキストにしか残っていない情報を全回収 | - |
| 6 | Gate 判定サマリー（Claude 生成）: 検証結果一覧 + 推奨判定 + 懸念事項 | - |
| 7 | Gate 宣言 DD 起票プロンプト | gate チケット末尾に配置（親チケットには置かない） |

人間の作業は「サマリーを読んで Go/No-Go を宣言する DD を起票する」のみ。

### 5. 調査方針の分岐（SP-000 のドキュメント有無参照）

| SP-000 回答 | 棚卸し作業 |
|------------|----------|
| ドキュメントあり | 実施 |
| ドキュメントなし | **スキップ**（子チケットにスキップ条件を明記） |
| 一部あり | 実施（存在するものを対象に） |

### 6. セクション呼称の統一ルール（命名規則）

SP ファイル内のセクションは以下の2語のみで呼称する。新たな語（Step, ステップ等）を増やさない。

| 呼称 | 使う場所 | 会話例 |
|------|---------|-------|
| `#N`（#1, #2, #4a...） | **親チケット**（SP-001.md 等）の実行フロー番号 | 「#3 まで終わった」「#4a を開いて」 |
| `Phase N`（Phase 1, Phase 2...） | **子チケット・DD ファイル**内のセクション番号 | 「SP-001-01 の Phase 2 終わった」「DD-002 の Phase 3」 |

**補足:** 親チケットの #1〜#3 は転記・確認などの軽い準備作業を含む場合があるが、
「Phase を持つほどの重みではない」と判断し #N で統一する（過剰な分割を避ける）。
