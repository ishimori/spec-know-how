# SP-004-02: フラグ・ステータスのライフサイクル確認

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 4（業務ロジックを抽出する）完了を目指す — バリデーション・計算ロジック・状態遷移・主要フローを仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 4「業務ロジックを抽出する」**（GUIDE_SPEC.md Step 4 セクション参照）

**目的**: 複数の値が存在する、または複数箇所から書き込まれるフラグ・ステータス列について、各値の業務的意味・書き込みパス・遷移条件（設計バグの可能性を含む）を記録する

> ⚠️ **LLM の限界**: LLM のコード読み取りは「想定値」であり、実際の書き込みパスと乖離する場合がある。可能であれば実 DB のデータ分布（`flag_distribution.py` 等）で検証すること。

**最終的な使われ方**: SP-004-context で状態遷移仕様書ファイルを作成する際の根拠となる。「対象フラグ・ステータスがない場合」は「なし」と記録して完了。

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（対象特定） |
| Phase 2 | 対象が存在する場合のみ実行（詳細確認） |

---

## Phase 1: 対象フラグ・ステータスの特定

- [x] DB スキーマ（SP-002 の成果物）またはコードのモデル定義から、対象候補列を洗い出した
  - 対象基準: **複数の値が存在する** または **コードの複数箇所から書き込まれる** 列
- [x] 対象が存在しない場合: 「なし」と記録して本チケットを完了する
- [x] 対象が存在する場合: Phase 2 へ進む

> 注: このシステムは DB なし（CSV ファイルベース）。「テーブル」= CSV ファイル、「カラム」= CSV 列として扱う。

### 対象候補一覧

| テーブル名（ファイル） | カラム名 | 値の種類（概算） | 優先度 |
|----------------------|---------|----------------|--------|
| `mixture_*_components.csv` | `Type` | 3値: "Meta" / "Component" / "Property" | 高 |
| インメモリ（UI状態） | `PolymericDefRowWidget.is_locked` | 2値: False / True | 中 |
| インメモリ（UI状態） | `App.registry_view_mode` | 2値: "used" / "all_structures" | 低（永続化なし） |

---

## Phase 2: ライフサイクル詳細確認

> 実際のコードを読んで確認すること。推測での記入禁止。

- [x] 各対象列について以下を確認した:
  - 各値の業務的意味
  - その値になるコードパス（どの関数・メソッドが書き込むか）
  - 遷移条件（遷移しない場合・更新すべきだが更新されない設計バグを含む）

### 調査記録（Phase 2）

#### mixture_*_components.csv: Type 列

| テーブル名 | カラム名 | 値 | 業務的意味 | 書き込む関数（ファイルパス:行番号） | 遷移条件・備考 | 信頼度 |
|-----------|---------|-----|----------|--------------------------------|-------------|--------|
| `mixture_*_components.csv` | `Type` | `"Meta"` | メタデータ行（Label名定義 / Memo / Solvent比率JSON） | `App._create_records_from_ui()` `ui.py:1008,1016,1018` | Save 時のみ書き込み。Label行・Memo行・Solvent_Ratios行が対象 | High |
| `mixture_*_components.csv` | `Type` | `"Component"` | 成分行（各配合成分の PHR 値） | `App._create_records_from_ui()` `ui.py:1013` | Save 時のみ書き込み。Polymer/PAG/PDB/Solvent/Additive の各成分 | High |
| `mixture_*_components.csv` | `Type` | `"Property"` | 物性値行（計算済み物性・カスタム入力値） | `App._create_records_from_ui()` `ui.py:1014,1021` | Save 時のみ書き込み。custom{n} 入力値と計算済み k/logp/op/p_p/tsc | High |

> **注**: Type 列は状態遷移なし。1回の Save で確定的に書き込まれ、後から変更されない（CSV 追記なし、新規ファイル生成）。

#### インメモリ状態: PolymericDefRowWidget.is_locked

| テーブル名 | カラム名 | 値 | 業務的意味 | 書き込む関数（ファイルパス:行番号） | 遷移条件・備考 | 信頼度 |
|-----------|---------|-----|----------|--------------------------------|-------------|--------|
| インメモリ（UI） | `is_locked` | `False` | 編集可能状態（新規行） | `__init__()` `ui.py:167` | 初期値 False（新規作成時） | High |
| インメモリ（UI） | `is_locked` | `True` | 登録済み・編集不可状態 | `lock()` `ui.py:245-248` | Register ボタン押下後に `on_click_register` → `lock()` を呼び出し。または `load_all()` でのロード時に `from_data()` → `lock()` を呼び出し | High |

> **注**: `is_locked` は **False → True の一方向遷移のみ**。True から False への戻し処理は存在しない（ロック解除不可）。これは意図的な設計（登録済みのポリマー定義は変更不可）と判断。

#### インメモリ状態: App.registry_view_mode

| テーブル名 | カラム名 | 値 | 業務的意味 | 書き込む関数（ファイルパス:行番号） | 遷移条件・備考 | 信頼度 |
|-----------|---------|-----|----------|--------------------------------|-------------|--------|
| インメモリ（UI） | `registry_view_mode` | `"used"` | 「使用中のみ」表示モード（phr>0 の構造のみ一覧表示） | `_set_registry_mode("used")` `ui.py:789-798` | 初期値 "used"。「使用中のみ」ボタン押下で遷移 | High |
| インメモリ（UI） | `registry_view_mode` | `"all_structures"` | 「全構造」表示モード（登録済み全構造を一覧表示） | `_set_registry_mode("all_structures")` `ui.py:789-798` | 「全構造」ボタン押下で遷移。注: コードは `"all_structures"` だが、ボタンは `"all"` → `_set_registry_mode("all_structures")` と渡しており、設定と呼び出しが一致している | High |

> **注**: `registry_view_mode` は永続化されない（セッションリセットで初期値 `"used"` に戻る）。

---

**設計バグ候補（「更新すべきだが更新されない」パターン）:**

| # | テーブル.カラム | 問題の概要 | 重要度 |
|---|--------------|---------|--------|
| 1 | `PolymericDefRowWidget.is_locked` | ロック解除処理が存在しない。一度 Register したポリマー定義のモノマー組成・比率は UI 上で変更不可。Mw / Mw_Mn のみ `Save Mw` ボタンで後から変更できる（lock 後も mw_input / pd_input は disabled にしていない） → ロック後も Mw 変更はできるが、組成変更はできない（仕様か設計バグかは不明）| Medium |

---

## DA 分析（このチケットのスコープ限定）

> 「対象フラグ・ステータスを全て特定できたか？設計バグを見落としていないか？」の観点で批判的に確認する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | `PolymericDefRowWidget.is_locked` はメモリ上のみで、セッション再起動後は `load_all()` で再ロードされロック状態が復元される。しかし `load_all()` が失敗した場合（ファイル破損等）、登録済みポリマーが「新規行」として表示される可能性 | Low | SP-005（非機能要件）で検討 |

---

## コンテキスト回収

- [x] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| ロック後も Mw 変更可能な仕様の確認（意図的か設計バグか） | 暗黙ルール確認（ドメインエキスパート確認項目として business_rules.md に明記） | Medium |

---

## 完了時の確認

- [x] SP-004 の子チケット一覧の本チケットを「完了」に更新した
