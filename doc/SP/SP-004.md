# SP-004: 業務ロジック抽出

> ⚠️ **前提確認（必読）**
> SP-002（DB・データモデル）および SP-003（画面・UI）の完了状態を確認すること。
> SP-003 をスキップした場合（フロントエンドなし）は、その旨を管理記録に記録して #2 へ進む。

---

## Claude への指示

以下の手順を順番に実行してください。

### [ ] #1: 前提確認

SP-002・SP-003 の完了状態と SP-003-03 の引き継ぎリストを確認する。

- SP-002 の完了状態を確認する
  - 完了している → DB 仕様書ファイルパスを管理記録テーブルに記録する
  - スキップした（DB なし）→ その旨を管理記録テーブルに記録する
- SP-003 の完了状態を確認する
  - SP-003 を実施した → SP-003-03 の「SP-004 への引き継ぎリスト」を読み、管理記録テーブルに記録する
  - SP-003 をスキップした（フロントエンドなし）→ **引き継ぎリスト不要** としてその旨を記録する（SP-004-01 でフォールバック探索を実施する）
- 確認した情報を下の管理記録テーブルに転記する

### [ ] #2: 主要フロー数の概算

コードベースのルーティング・サービス層・ユースケースから主要業務フロー数を概算する。

- 主要業務フロー数を概算し、ユーザーに提示する
- **フロー数が 5 以上の場合**: フロー・機能ドメイン別への分割を提案し、ユーザーが判断する
  - 分割する場合: SP-004-04 以降を動的追加し、SP-004-01 のスコープを調整する
  - 分割しない場合: SP-004-01 で全フローを扱う
- 概算結果を下の管理記録テーブルに記録する

### [ ] #3: 外部システム連携の有無確認

コードベースから外部 API 呼び出し・ファイル I/O・メッセージキュー等の外部連携の有無を確認する。

- 外部連携の有無を確認し、ユーザーに提示する
  - **なし** → SP-004-03 はスキップする（管理記録に「なし」と記録）
  - **あり（5 件未満）** → SP-004-03 を実行する
  - **あり（5 件以上）** → 外部システムごとに SP-004-03-xx を動的追加することを提案する
- 確認結果を下の管理記録テーブルに記録する

### [ ] #4: 子チケット順次実行

以下の順番で子チケットを実行する。

| # | チケット | 内容 | 実行条件 |
|---|---------|------|---------|
| 1 | [SP-004-01.md](SP-004-01.md) | 業務ロジック抽出（フロー・バリデーション・計算・状態遷移） | 常に実行 |
| 2 | [SP-004-02.md](SP-004-02.md) | フラグ・ステータスのライフサイクル確認 | 常に実行（対象なしなら「なし」と記録して完了） |
| 3 | [SP-004-03.md](SP-004-03.md) | 外部システム連携 | #3 で「あり」と確認した場合のみ |
| 4 | [SP-004-context.md](SP-004-context.md) | 業務ロジック仕様書ファイル構成設計 | 上記完了後 |
| 5 | [SP-004-gate.md](SP-004-gate.md) | Gate 4 チェック | 最後に実行 |

> 動的追加チケット（SP-004-04〜、SP-004-03-xx）がある場合は上記の間に適宜挿入する。

### [ ] #5: Gate 4 宣言

SP-004-gate の Gate 判定サマリーをユーザーに提示し、Go/No-Go 宣言の DD を起票する。

---

## 管理記録

| 項目 | 値 |
|------|-----|
| SP-002 完了確認（または DB なしの記録） | 完了（ファイルベースパスで実行） |
| SP-002 DB 仕様書ファイルパス | `doc/context/data_schema.md`（SP-002-context で作成済み） |
| SP-003 スキップ有無（UIなし / あり） | 実施済み（フロントエンドあり: ipywidgets） |
| SP-003-03 引き継ぎリスト件数（またはスキップ理由） | **5件**（下記「SP-003-03 引き継ぎリスト」参照） |
| 主要フロー数概算 | - |
| 動的追加チケット（フロー分割） | - |
| 外部システム連携有無・件数 | - |
| 動的追加チケット（外部連携分割） | - |

### SP-002 からの引き継ぎ事項（データ層調査で判明した未解決事項）

> 出典: [SP-002-gate.md](SP-002-gate.md) Phase 4 DA 分析 / [SP-002-03.md](SP-002-03.md) DA 分析 / [doc/context/data_schema.md](../context/data_schema.md) §5

| # | 確認事項 | 重要度 | 詳細 |
|---|---------|--------|------|
| 1 | **入力 CDXML マスタに未使用材料が存在する** — 業務上の扱いを確認 | High | `Solvent.cdxml` に GBL（γ-ブチロラクトン）が登録されているが id_registry.json 未登録（一度も使われていない）。`PDB.cdxml` も4分子定義のうち B-1 のみ使用。「候補として登録した」のか「削除忘れ」かを SP-004-01 または SP-004 前提確認で明確化する |
| 2 | **`Additive.cdxml` に PGME の化学構造が混入している** | Medium | Additive（添加剤）マスタファイルに溶剤の PGME 構造が含まれており ID 未付与。意図的（比較用途）か誤り（コピーミス）かを SP-004 で確認する |
| 3 | **`mixture_*_components.csv` の `Type` / `Category` 列にコード定数（Enum）が存在しない** | Medium | `"Meta"` / `"Component"` / `"Property"` 等の値が文字列リテラルで管理されており、スペルミスがデータ欠落として現れる。SP-004-01 でリテラル使用箇所を全列挙し仕様書に明記する |

---

### SP-003-03 引き継ぎリスト（SP-003 完了時に転記）

> 詳細: [SP-003-03.md](SP-003-03.md) の「SP-004 への引き継ぎリスト」セクション参照
> 関連仕様書: [doc/context/screen_spec.md](../context/screen_spec.md) Section 5

| # | 関数名 | ファイル:行 | 仕様化内容 | 優先度 |
|---|-------|-----------|----------|--------|
| 1 | `ResistRowWidget._recalc_solvent()` | `app_core/ui.py:618` | Solvent PHR 自動計算: TSC% と固形分合計から総溶剤量を逆算し、比率で各溶剤に配分。`total_sol = solid_mass × (100 - tsc) / tsc` | High |
| 2 | `_update_balance()`（クロージャ） | `app_core/ui.py:497` | Polymer PHR 補完: `rem = max(0, polymer_total_phr - sub_sum)` で主成分 PHR を自動決定 | High |
| 3 | `compute_properties()` | `app_core/properties.py:146` | 全物性計算: k（吸光係数）/ LogP（疎水性）/ OP・MOP（光学物性）/ PDB-PAG モル比 / TSC の計算ロジック | High |
| 4 | `_resolve_composition()` | `app_core/properties.py:33` | Polymer→モノマー分解・mol比→重量比変換・PHR スケーリング（UI 入力値 ≠ 実計算 PHR） | High |
| 5 | `PolymericDefBuilder.register_row()` | `app_core/ui.py:329` | ID付与ルール・ポリマーシグネチャ形式（`"MonA=70/MonB=30"` 形式）・モノマー連番管理 | High |

**追加の確認事項（SP-004 で整理すること）:**
- 化合物命名規則: `_2pag` / `_1pdb` 等の suffix が PAG/PDB 係数に影響する（`properties.py:12` の `_SUFFIX_RE`）
- TSC 計算の二重化: `_recalc_solvent()`（UI 層）と `compute_properties()` の TSC 計算の整合確認が必要

---

## 子チケット一覧

| チケット | ステータス |
|---------|----------|
| [SP-004-01.md](SP-004-01.md) 業務ロジック抽出 | 未着手 |
| [SP-004-02.md](SP-004-02.md) フラグ・ステータスのライフサイクル確認 | 未着手 |
| [SP-004-03.md](SP-004-03.md) 外部システム連携 | 未着手 |
| [SP-004-context.md](SP-004-context.md) 業務ロジック仕様書ファイル構成設計 | 未着手 |
| [SP-004-gate.md](SP-004-gate.md) Gate 4 チェック | 未着手 |
