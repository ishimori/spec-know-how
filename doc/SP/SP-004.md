# SP-004: 業務ロジック抽出

> ⚠️ **前提確認（必読）**
> SP-002（DB・データモデル）および SP-003（画面・UI）の完了状態を確認すること。
> SP-003 をスキップした場合（フロントエンドなし）は、その旨を管理記録に記録して #2 へ進む。

---

## Claude への指示

以下の手順を順番に実行してください。

### [ ] #1: 前提確認

SP-002・SP-003 の完了状態と SP-003-03 の引き継ぎリストを確認する。

- SP-002 の完了状態を確認する
  - 完了している → DB 仕様書ファイルパスを管理記録テーブルに記録する
  - スキップした（DB なし）→ その旨を管理記録テーブルに記録する
- SP-003 の完了状態を確認する
  - SP-003 を実施した → SP-003-03 の「SP-004 への引き継ぎリスト」を読み、管理記録テーブルに記録する
  - SP-003 をスキップした（フロントエンドなし）→ **引き継ぎリスト不要** としてその旨を記録する（SP-004-01 でフォールバック探索を実施する）
- 確認した情報を下の管理記録テーブルに転記する

### [ ] #2: 主要フロー数の概算

コードベースのルーティング・サービス層・ユースケースから主要業務フロー数を概算する。

- 主要業務フロー数を概算し、ユーザーに提示する
- **フロー数が 5 以上の場合**: フロー・機能ドメイン別への分割を提案し、ユーザーが判断する
  - 分割する場合: SP-004-04 以降を動的追加し、SP-004-01 のスコープを調整する
  - 分割しない場合: SP-004-01 で全フローを扱う
- 概算結果を下の管理記録テーブルに記録する

### [ ] #3: 外部システム連携の有無確認

コードベースから外部 API 呼び出し・ファイル I/O・メッセージキュー等の外部連携の有無を確認する。

- 外部連携の有無を確認し、ユーザーに提示する
  - **なし** → SP-004-03 はスキップする（管理記録に「なし」と記録）
  - **あり（5 件未満）** → SP-004-03 を実行する
  - **あり（5 件以上）** → 外部システムごとに SP-004-03-xx を動的追加することを提案する
- 確認結果を下の管理記録テーブルに記録する

### [ ] #4: 子チケット順次実行

以下の順番で子チケットを実行する。

| # | チケット | 内容 | 実行条件 |
|---|---------|------|---------|
| 1 | [SP-004-01.md](SP-004-01.md) | 業務ロジック抽出（フロー・バリデーション・計算・状態遷移） | 常に実行 |
| 2 | [SP-004-02.md](SP-004-02.md) | フラグ・ステータスのライフサイクル確認 | 常に実行（対象なしなら「なし」と記録して完了） |
| 3 | [SP-004-03.md](SP-004-03.md) | 外部システム連携 | #3 で「あり」と確認した場合のみ |
| 4 | [SP-004-context.md](SP-004-context.md) | 業務ロジック仕様書ファイル構成設計 | 上記完了後 |
| 5 | [SP-004-gate.md](SP-004-gate.md) | Gate 4 チェック | 最後に実行 |

> 動的追加チケット（SP-004-04〜、SP-004-03-xx）がある場合は上記の間に適宜挿入する。

### [ ] #5: Gate 4 宣言

SP-004-gate の Gate 判定サマリーをユーザーに提示し、Go/No-Go 宣言の DD を起票する。

---

## 管理記録

| 項目 | 値 |
|------|-----|
| SP-002 完了確認（または DB なしの記録） | - |
| SP-002 DB 仕様書ファイルパス | - |
| SP-003 スキップ有無（UIなし / あり） | - |
| SP-003-03 引き継ぎリスト件数（またはスキップ理由） | - |
| 主要フロー数概算 | - |
| 動的追加チケット（フロー分割） | - |
| 外部システム連携有無・件数 | - |
| 動的追加チケット（外部連携分割） | - |

---

## 子チケット一覧

| チケット | ステータス |
|---------|----------|
| [SP-004-01.md](SP-004-01.md) 業務ロジック抽出 | 未着手 |
| [SP-004-02.md](SP-004-02.md) フラグ・ステータスのライフサイクル確認 | 未着手 |
| [SP-004-03.md](SP-004-03.md) 外部システム連携 | 未着手 |
| [SP-004-context.md](SP-004-context.md) 業務ロジック仕様書ファイル構成設計 | 未着手 |
| [SP-004-gate.md](SP-004-gate.md) Gate 4 チェック | 未着手 |
