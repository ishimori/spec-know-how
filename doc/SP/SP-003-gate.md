# SP-003-gate: Gate 3 チェック

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 3（画面・UI を把握する）完了を目指す — 画面構成・遷移・操作フローを把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Gate 3「画面把握チェックリスト」**

**目的**: SP-003 の全子チケット（および動的追加分）が完了したことを機械検証・LLM 検証・DA 分析の3段階で確認し、Gate 3 通過可否のサマリーを生成する

**最終的な使われ方**: Claude が Gate 判定サマリーを提示し、人間が Go/No-Go 宣言の DD を起票する

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1〜6 | 常に実行（SP-003-context 完了後） |

---

## Phase 1: 前提確認（LLM）

SP-003 の全子チケットのステータスを確認する。

- [x] SP-003-01 が「完了」であることを確認した
- [x] SP-003-02 が「完了」であることを確認した
- [x] SP-003-03 が「完了」であることを確認した
- [x] SP-003-context が「完了」であることを確認した
- [x] 動的追加チケット（SP-003-04〜）がある場合、すべて「完了」であることを確認した → 動的追加なし

---

## Phase 2: 機械検証

- [x] SP-003-context で設計した画面仕様書ファイルが実際に存在することを確認した
- [x] `CLAUDE.md` の仕様書マップに画面仕様書ファイルが追記されていることを確認した（→ CLAUDE.md の仕様書マップに `screen_spec.md` を追記済み）

### 機械検証記録

```
# 実行コマンド
ls C:/repo/spec-know-how/doc/context/

# 実行結果
data_schema.md
screen_spec.md
```

`doc/context/screen_spec.md` の存在を確認。

---

## Phase 3: LLM 検証

- [x] SP-003-01 を読み、画面一覧・API エンドポイント対応・操作フロー・画面遷移が記録されていることを確認した
- [x] SP-003-02 を読み、権限・ロール制御の有無（権限なしの記録）が記録されていることを確認した
- [x] SP-003-03 を読み、UI 層ビジネスロジックの在処確認結果が記録されていることを確認した
- [x] SP-003-context を読み、画面仕様書ファイルの構成と作成記録があることを確認した

### 検証記録

| チェック項目 | 確認結果 | 備考 |
|-----------|---------|------|
| 画面一覧・API エンドポイント対応 | OK | トップ3タブ・サブタブ・機能・対応関数をすべて記録済み（SP-003-01 Phase 1） |
| 操作フロー・画面遷移 | OK | 5つの Happy Path フロー・タブ遷移図を記録済み（SP-003-01 Phase 2） |
| 権限・ロール制御（または「なし」の記録） | OK | 「権限制御なし」を根拠付きで記録済み（SP-003-02 Phase 1） |
| UI 層ビジネスロジック在処確認 | OK | `_recalc_solvent()` / `_update_balance()` / `register_row()` 等を特定・記録済み（SP-003-03） |
| 画面仕様書ファイル構成・作成 | OK | `doc/context/screen_spec.md` を作成・存在確認済み（SP-003-context） |

---

## Phase 4: DA 分析（全体横断）

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | `_recalc_solvent()` と `properties.py` の TSC 計算が二重に存在しており、値の一致が保証されているか未確認（SP-003-03 でも指摘済み） | Medium | SP-004 で両者の計算フローを比較・整合確認 |
| 2 | `render_registry()` で生成される動的サブタブのカテゴリ数がカタログ依存で可変。現在 7〜8 カテゴリだが将来変動し得る | Low | 旧システムの仕様として「動的生成」と記録済み。新システム設計時に固定カテゴリ数を検討する |

---

## Phase 5: コンテキスト最終回収

- [x] 全子チケット・全調査を通じてコンテキストにしか残っていない情報がないか確認し、あれば該当チケットまたは画面仕様書ファイルに追記した

**回収した知見（screen_spec.md に追記済み）:**
- 永続化ファイルと画面操作の対応表（Section 6）
- UI 層ビジネスロジック一覧（Section 5）

---

## Phase 6: Gate 判定サマリー（Claude が生成）

### Gate 3 判定サマリー

| 検証項目 | 結果 | 備考 |
|---------|------|------|
| 全子チケット完了確認（Phase 1） | ✅ OK | SP-003-01〜03, SP-003-context すべて完了 |
| 画面仕様書ファイル存在確認（Phase 2） | ✅ OK | `doc/context/screen_spec.md` 存在確認済み |
| 画面一覧・API対応・遷移（Phase 3） | ✅ OK | 3層タブ構造・5フロー・画面遷移図を記録 |
| 権限・ロール制御（Phase 3） | ✅ OK | 権限制御なし・根拠付きで記録 |
| UI 層ビジネスロジック在処（Phase 3） | ✅ OK | 5関数を特定・SP-004 引き継ぎリスト整備済み |
| 横断 DA 分析（Phase 4） | ✅ 軽微な懸念のみ | TSC 二重計算の整合確認は SP-004 で実施 |

**推奨判定**: **通過**

**懸念事項**:
- TSC 計算の二重化（`_recalc_solvent()` vs `properties.py`）の整合確認 → SP-004 で解消

---

## 完了時の確認

- [x] SP-003 の子チケット一覧の本チケットを「完了」に更新した
- [x] 上の Gate 判定サマリーをユーザーに提示した

---

## Gate 宣言

> Gate 判定サマリーを確認後、[SP-003-gate-decl.md](SP-003-gate-decl.md) に判断を記録してください。
