# SP-002-gate: Gate 2 チェック

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 2（データ層を取得する）完了を目指す — DB構造またはデータファイル構造を把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Gate 2「データ層情報取得チェックリスト」**

**目的**: SP-002 の全子チケット（および動的追加分）が完了したことを機械検証・LLM 検証・DA 分析の3段階で確認し、Gate 2 通過可否のサマリーを生成する。DB パス・ファイルベースパス両方に対応する。

**最終的な使われ方**: Claude が Gate 判定サマリーを提示し、人間が Go/No-Go 宣言の DD を起票する

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1〜6 | 常に実行（SP-002-context 完了後） |

---

## Phase 1: 前提確認（LLM）

SP-002 の全子チケットのステータスと実行パスを確認する。

- [x] SP-002 親チケットの管理記録を読み、実行パス（DB / ファイルベース）を確認した
- [x] SP-002-01 が「完了」であることを確認した
- [x] SP-002-02 が「完了」であることを確認した
- [x] SP-002-03 が「完了」または「アクセス不可のためスキップ済み」であることを確認した
- [x] SP-002-context が「完了」であることを確認した
- [x] 動的追加チケット（SP-002-04〜）がある場合、すべて「完了」であることを確認した（動的追加なし）

**実行パス:** ファイルベースパス（DB なし + CSV/CDXML/JSON データファイルあり）

---

## Phase 2: 機械検証

> 実コマンドを実行して結果を記録すること。推測・記憶に頼った記入禁止。

**DB パスの場合:**
- [ ] SP-002-context で設計した DB 仕様書ファイル（`doc/spec/db/` 配下）が実際に存在することを確認した
- [ ] `CLAUDE.md` または `document_map.md` に DB 仕様書ファイルが追記されていることを確認した

**ファイルベースパスの場合:**
- [x] SP-002-context で作成した `doc/context/data_schema.md` が実際に存在することを確認した
- [x] `CLAUDE.md` の仕様書マップに `data_schema.md` が登録されていることを確認した

### 機械検証記録

```
# 実行コマンド
test -f "c:/repo/spec-know-how/doc/context/data_schema.md" && echo "EXISTS"
grep "data_schema.md" c:/repo/spec-know-how/CLAUDE.md
# 実行結果
EXISTS
| `doc/context/data_schema.md` | CSVファイル構造・CDXML役割・中間データ形式（旧システム事実） | 新システムDB設計は書かない |
```

---

## Phase 3: LLM 検証

> 先行子チケットのファイルを実際に読んで確認すること。「たぶん書いてあった」禁止。

**DB パスの場合:**
- [ ] SP-002-01 を読み、テーブル一覧・外部キー関係が記録されていることを確認した
- [ ] SP-002-01 を読み、論理削除カラム・ビュー・インデックスの確認結果が記録されていることを確認した
- [ ] SP-002-02 を読み、マスタテーブル一覧と具体値（または確認できない理由）が記録されていることを確認した
- [ ] SP-002-03 を読み、照合結果または実DBアクセス不可の理由が記録されていることを確認した
- [ ] SP-002-context を読み、DB仕様書ファイルの構成と作成記録があることを確認した

**ファイルベースパスの場合:**
- [x] SP-002-01 を読み、CSV / CDXML / JSON 各ファイルの構造（カラム・要素・フィールド構成）が記録されていることを確認した
- [x] SP-002-01 を読み、ファイル間のキー関係・中間データの役割が記録されていることを確認した
- [x] SP-002-02 を読み、マスタファイル一覧とコード値（または確認できない理由）が記録されていることを確認した
- [x] SP-002-03 を読み、実ファイル照合結果（行数・型・サンプル値）またはアクセス不可の理由が記録されていることを確認した
- [x] SP-002-context を読み、`data_schema.md` の構成と作成記録があることを確認した

### 検証記録

**DB パス用:**

| チェック項目 | 確認結果 | 備考 |
|-----------|---------|------|
| テーブル一覧・外部キー関係 | OK / NG / 部分的 / 該当なし | - |
| テーブル詳細（論理削除・ビュー・インデックス） | OK / NG / 部分的 / 該当なし | - |
| マスタデータ具体値（または理由記録） | OK / NG / 部分的 / 該当なし | - |
| 実DB照合結果（または理由記録） | OK / NG / スキップ済み / 該当なし | - |
| DB仕様書ファイル構成・作成 | OK / NG / 部分的 / 該当なし | - |

**ファイルベースパス用:**

| チェック項目 | 確認結果 | 備考 |
|-----------|---------|------|
| CSV / CDXML / JSON 構造記録 | OK | 全8CSV・10CDXML・1JSONのカラム/要素/フィールド構成を記録 |
| ファイル間キー関係・中間データ役割 | OK | Resist_ID・化合物IDによるファイル間関係を記録 |
| マスタファイル・コード値記録 | OK | ID_PREFIX_MAP・CDXML材料マスタ・コード値一覧を記録 |
| 実ファイル照合結果（または理由記録） | OK | Python実行で行数・型・サンプル値を照合。CDXML要素数も確認 |
| data_schema.md 構成・作成 | OK | `doc/context/data_schema.md` 作成済み・CLAUDE.md 登録済み |

---

## Phase 4: DA 分析（全体横断）

> 各子チケットのスコープを超えた横断的な確認を行う。
> 「個別調査では見えなかったパターン・矛盾・見落とし」を発見する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | 入力 CDXML マスタに未使用材料が複数存在（GBL, PDB3種等）。SP-001-01 ではマスタ内容を把握していなかったため、個別チケット調査で初めて判明 | High | data_schema.md §5 に記録済み。SP-004 で業務上の扱いを確認 |
| 2 | `Additive.cdxml` に PGME 構造が混入。ファイル単体では気づかず、CDXML要素数の照合で発見 | Medium | data_schema.md §5 に記録済み |
| 3 | mixture_*.csv の Type/Category 列のコード値に定数管理が存在しない（SP-002-01 と SP-002-02 の両方で気づいた横断的懸念） | Medium | data_schema.md §2-2 に明記済み |

---

## Phase 5: コンテキスト最終回収

> SP-002 全子チケットの作業を通じて会話コンテキストにのみ残っている情報を最後にすべて回収する。

- [x] 全子チケット・全調査を通じてコンテキストにしか残っていない情報がないか確認し、
      あれば該当チケットまたはデータ層仕様書ファイルに追記した（追加なし。すべて記録済み）

---

## Phase 6: Gate 判定サマリー（Claude が生成）

> Claude が Phase 1〜5 の結果を基にサマリーを生成し、ユーザーに提示する。

### Gate 2 判定サマリー

| 検証項目 | 結果 | 備考 |
|---------|------|------|
| 全子チケット完了確認（Phase 1） | **OK** | 01〜03・context すべて完了。動的追加なし |
| 実行パス（DB / ファイルベース）（Phase 1） | **ファイルベースパス** | DBなし・CSV/CDXML/JSON 19ファイル |
| 仕様書ファイル存在確認（Phase 2） | **OK** | `doc/context/data_schema.md` 存在確認 |
| CLAUDE.md 登録確認（Phase 2） | **OK** | 仕様書マップに登録済み |
| データ構造記録（Phase 3） | **OK** | 全ファイルのカラム・要素・フィールド構成・キー関係を記録 |
| マスタデータ・コード値記録（Phase 3） | **OK** | ID_PREFIX_MAP・CDXML材料マスタ・コード値一覧・具体値を記録 |
| 実データ照合結果（Phase 3） | **OK** | Python実行で行数・dtype・要素数を照合。差異発見あり（記録済み）|
| 横断 DA 分析（Phase 4） | **OK** | 未使用材料・混入・コード値定数なし の3件を記録 |

**推奨判定**: **通過**

**懸念事項**（後続SP での確認事項）:
- 入力 CDXML マスタの未使用材料（GBL, PDB3種等）の業務上の扱い → SP-004 で確認
- Additive.cdxml への PGME 構造混入の意図 → SP-004 で確認
- mixture_*.csv の Type/Category コード値の定数管理不在 → SP-004 で確認

---

## 完了時の確認

- [x] SP-002 の子チケット一覧の本チケットを「完了」に更新した
- [x] 上の Gate 判定サマリーをユーザーに提示した

---

## Gate 宣言

> Gate 判定サマリーを確認後、[SP-002-gate-decl.md](SP-002-gate-decl.md) に判断を記録してください。
