# SP-004-context: 業務ロジック仕様書ファイル構成設計

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 4（業務ロジックを抽出する）完了を目指す — バリデーション・計算ロジック・状態遷移・主要フローを仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: 特定の Step に非対応（全工程を横断）— SP-004-01〜03（および動的追加チケット）の成果物を集約し、永続的な業務ロジック仕様書ファイルの構成を設計する

**目的**: SP-004-01〜03（および動的追加チケットを含む全子チケット）の調査結果を統合し、後続の SP が参照する業務ロジック仕様書ファイルの構成・ファイル名・BR 採番ルール・記述内容を設計して実際に作成する

**最終的な使われ方**: ここで設計したファイル構成に従って業務ロジック仕様書を作成する（実際のファイル作成はこのチケット内で行う）。作成したファイルは `CLAUDE.md` または `document_map.md` に **キーワード → ファイルパス** のマッピング形式で追記し、SP-005 以降・QA スキルから参照可能にする

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（SP-004-01〜03 および動的追加チケット完了後） |

---

## Phase 1: 業務ロジック仕様書ファイル構成設計・作成

- [x] SP-004-01〜03（および動的追加チケット）の調査記録をすべて読んだ
  - SP-004-01: 業務ロジック抽出 完了（BR-001〜018）
  - SP-004-02: フラグ・ステータス確認 完了（Type列・is_locked・registry_view_mode）
  - SP-004-03: スキップ（外部連携なし）
- [x] BR 採番ルールを設計した（BR-{3桁連番} 形式、カテゴリ: 計算/バリデーション/フロー制御）
- [x] 業務ロジック仕様書として作成すべきファイルの構成を設計した
- [x] 設計したファイルを作成した
- [x] 作成したファイルを CLAUDE.md に **キーワード → ファイルパス** のマッピング形式で追記した
- [x] SP-003-03 で記録された UI 層ビジネスロジックの引き継ぎリスト（5件）が、SP-004-01 で全項目仕様化されていることを確認した（BR-001, BR-002, BR-004〜007 に対応）

### 設計記録

| ファイル名 | 役割（何を書くか） | 書かないもの | 対応する調査元 | CLAUDE.md キーワード例 |
|-----------|---------------|------------|-------------|---------------------|
| `doc/context/business_rules.md` | バリデーション・業務ルール・計算式（BR-ID付き） | 実装の詳細・フラグ遷移 | SP-004-01 | 計算, バリデーション, 業務ルール, BR-001 |
| `doc/context/state_transitions.md` | フラグ・ステータスのライフサイクル | ビジネスルールの意味説明 | SP-004-02 | ステータス, フラグ, 遷移, is_locked |
| ~~`doc/context/integrations.md`~~ | ~~外部システム連携仕様~~ | — | SP-004-03 スキップ（外部連携なし） | — |

**BR-ID と仕様書ファイルのマッピング**:
- BR-001〜BR-016: `doc/context/business_rules.md`
- Type列・is_locked・registry_view_mode: `doc/context/state_transitions.md`

**SP-003-03 引き継ぎリストの解決状況**:

| 引き継ぎ # | 関数名 | 対応 BR |
|-----------|-------|---------|
| 1 | `_recalc_solvent()` | BR-001 |
| 2 | `_update_balance()`（クロージャ） | BR-002 |
| 3 | `compute_properties()` | BR-004〜007 |
| 4 | `_resolve_composition()` | BR-003 |
| 5 | `PolymericDefBuilder.register_row()` | BR-008, BR-009 |

### CLAUDE.md への追記（記録）

```markdown
| `doc/context/business_rules.md` | 業務ルール・計算式・フロー制御（BR-001〜016）（旧システム事実） | 新システムの実装判断は書かない |
| `doc/context/state_transitions.md` | フラグ・ステータスのライフサイクル（Type列・is_locked・registry_view_mode）（旧システム事実） | 新システムの設計は書かない |
```

---

## DA 分析（このチケットのスコープ限定）

> 「提案した業務ロジック仕様書ファイル構成で、重要な情報が漏れるケースはないか？QA スキルが必要なキーワードで引けるか？SP-005 が必要な情報を参照できるか？」の観点で批判的に確認する。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | `mol_calculator.py` の詳細（SMILES → 物性値の計算式）を調査していない。`calculate_descriptors_for_apply()` の内部ロジック（RDKit 関数群）が未確認。SP-004-01 の BR-004〜007 では「DescriptorStore 経由で取得」と記録しており、SP-005（非機能要件）以降で確認可能 | Low | SP-005 で追加確認 |

---

## コンテキスト回収

- [x] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| `mol_calculator.py` の計算式詳細確認 | SP-005 | Low |

---

## 完了時の確認

- [x] SP-004 の子チケット一覧の本チケットを「完了」に更新した
