# SP-004-gate: Gate 4 チェック

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 4（業務ロジックを抽出する）完了を目指す — バリデーション・計算ロジック・状態遷移・主要フローを仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Gate 4「業務ロジック抽出チェックリスト」**

**目的**: SP-004 の全子チケット（および動的追加分）が完了したことを機械検証・LLM 検証・DA 分析の 3 段階で確認し、Gate 4 通過可否のサマリーを生成する

**最終的な使われ方**: Claude が Gate 判定サマリーを提示し、人間が Go/No-Go 宣言の DD を起票する

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1〜6 | 常に実行（SP-004-context 完了後） |

---

## Phase 1: 前提確認（LLM）

SP-004 の全子チケットのステータスを確認する。

- [x] SP-004-01 が「完了」であることを確認した
- [x] SP-004-02 が「完了」であることを確認した
- [x] SP-004-03 が「完了」または「スキップ（外部連携なし）」であることを確認した → **スキップ（外部連携なし）**
- [x] SP-004-context が「完了」であることを確認した
- [x] 動的追加チケット（SP-004-04〜、SP-004-03-xx）がある場合、すべて「完了」であることを確認した → **動的追加チケットなし**

---

## Phase 2: 機械検証

- [x] SP-004-context で設計した業務ロジック仕様書ファイルが実際に存在することを確認した
- [x] `CLAUDE.md` に業務ロジック仕様書ファイルが追記されていることを確認した

### 機械検証記録

```
# 実行コマンド
ls "c:/repo/spec-know-how/doc/context/"

# 実行結果
business_rules.md
data_schema.md
screen_spec.md
state_transitions.md
```

```
# 実行コマンド
grep "business_rules|state_transitions" "c:/repo/spec-know-how/CLAUDE.md"

# 実行結果
| `doc/context/business_rules.md` | 業務ルール・計算式・フロー制御（BR-001〜016）（旧システム事実） | 新システムの実装判断は書かない |
| `doc/context/state_transitions.md` | フラグ・ステータスのライフサイクル（Type列・is_locked・registry_view_mode）（旧システム事実） | 新システムの設計は書かない |
```

---

## Phase 3: LLM 検証

- [x] SP-004-01 を読み、業務ロジック（バリデーション・計算・状態遷移・フロー）が BR-ID 付きで記録されていることを確認した
  - BR-001〜BR-018 が記録済み（Phase 1: BR-001〜005、Phase 2: BR-006〜018）
- [x] SP-004-01 を読み、SP-003-03 引き継ぎリストの全項目が仕様化されていることを確認した
  - 引き継ぎ1→BR-001, 引き継ぎ2→BR-002, 引き継ぎ3→BR-004〜007, 引き継ぎ4→BR-003, 引き継ぎ5→BR-008/009（全5件対応完了）
- [x] SP-004-01 を読み、暗黙ルール候補の一覧が記録されていることを確認した
  - 5件の暗黙ルール候補を記録済み
- [x] SP-004-02 を読み、フラグ・ステータスの調査結果があることを確認した
  - Type列（3値）・is_locked（2値・一方向遷移）・registry_view_mode（2値・双方向）の3種類を調査済み
- [x] SP-004-03 を読み、外部連携の仕様（スキップ・なし）の記録があることを確認した
  - SP-004.md 管理記録に「なし（ローカルファイルI/Oのみ）」と記録済み
- [x] SP-004-context を読み、業務ロジック仕様書ファイルの構成・作成記録があることを確認した
  - 2ファイル（business_rules.md, state_transitions.md）の設計・作成記録あり

### 検証記録

| チェック項目 | 確認結果 | 備考 |
|-----------|---------|------|
| 業務ロジック（BR-ID付き記録） | OK | BR-001〜018 記録済み |
| SP-003-03 引き継ぎリスト全項目仕様化 | OK | 5件全て対応完了 |
| 暗黙ルール候補の記録 | OK | 5件記録済み（ドメインエキスパート確認待ち） |
| フラグ・ステータス調査 | OK | 3種類の対象を調査済み |
| 外部連携仕様（スキップ・なし） | OK | SP-004-03 スキップ（外部連携なし） |
| 業務ロジック仕様書ファイル構成・作成 | OK | 2ファイル作成済み・CLAUDE.md 追記済み |

---

## Phase 4: DA 分析（全体横断）

> 各子チケットのスコープを超えた横断的な確認を行う。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | **TSC 計算の二重化**（BR-001 vs BR-007）: `_recalc_solvent()` は TSC入力→溶剤量逆算、`compute_properties()` は PHR状態→TSC算出。10の倍数丸め（BR-001）で両者のTSC値が厳密に一致しない可能性。UI上の TSC 入力値と計算表示値がずれる場合あり | Medium | business_rules.md の BR-007 に警告注釈として記録済み。新システムで解決すべき設計課題 |
| 2 | **Type/Category 列のリテラル管理**（BR-018）: SP-002 引き継ぎ事項#3 がコードで確認された。スペルミスがサイレントにデータ欠落を引き起こす。business_rules.md の BR-015 に警告注釈として記録済み | Medium | 新システムでは Enum 管理を推奨（新システム設計書に記載すべき事項） |
| 3 | **SP-002 引き継ぎ事項#1・2**（未使用CDXML材料・PGME混入）: SP-004-01 の暗黙ルール候補として記録されたが、コード調査では業務上の扱いを確定できない（ドメインエキスパート確認が必要） | High | 暗黙ルール候補 #3・#4 として記録済み。Gate 通過後のアクションとして確認必須 |

---

## Phase 5: コンテキスト最終回収

- [x] 全子チケット・全調査を通じてコンテキストにしか残っていない情報がないか確認し、あれば該当チケットまたは業務ロジック仕様書ファイルに追記した

**回収事項**:
- `mol_calculator.py` の詳細未調査（SP-004-01 DA 分析・SP-004-context 追加タスクに記録済み → SP-005 で追加確認）

---

## Phase 6: Gate 判定サマリー

### Gate 4 判定サマリー

| 検証項目 | 結果 | 備考 |
|---------|------|------|
| 全子チケット完了確認（Phase 1） | ✅ OK | SP-004-01/02 完了・SP-004-03 スキップ（なし）・SP-004-context 完了 |
| 業務ロジック仕様書ファイル存在確認（Phase 2） | ✅ OK | business_rules.md / state_transitions.md を確認 |
| 業務ロジック BR-ID 付き記録（Phase 3） | ✅ OK | BR-001〜018 記録済み |
| SP-003-03 引き継ぎ全項目仕様化（Phase 3） | ✅ OK | 5件全件対応完了 |
| フラグ・ステータス調査（Phase 3） | ✅ OK | 3種類調査済み（状態遷移なし・一方向・双方向） |
| 外部連携仕様（Phase 3） | ✅ OK（スキップ） | 外部連携なし（完全ローカル） |
| 横断 DA 分析（Phase 4） | ⚠️ 条件付き | TSC 二重化・Type列リテラル・未使用材料の業務的確認が残る |

**推奨判定**: **条件付き通過**

**懸念事項**:
1. **暗黙ルール確認（High）**: 未使用CDXML材料（GBL、PDB B-1 以外）・Additive.cdxml の PGME 混入の業務上の扱いを、ドメインエキスパートに確認すること（Gate 通過後のアクション）
2. **TSC 二重化（Medium）**: UI 入力 TSC と計算表示 TSC のずれを新システム設計で解消すること
3. **Type/Category リテラル（Medium）**: 新システムでは Enum 管理を採用すること

> ⚠️ **暗黙ルール確認の促し**: SP-004-01 に記録された暗黙ルール候補 6 件について、ドメインエキスパートへの確認がまだ。Gate 通過後、新システム設計着手前に確認を行うこと。

---

## 完了時の確認

- [x] SP-004 の子チケット一覧の本チケットを「完了」に更新した
- [x] 上の Gate 判定サマリーをユーザーに提示した

---

## Gate 宣言

> Gate 判定サマリーを確認後、[SP-004-gate-decl.md](SP-004-gate-decl.md) に判断を記録してください。
