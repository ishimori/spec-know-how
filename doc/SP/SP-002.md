# SP-002: データ層取得（DB / ファイルベース）

> ⚠️ **前提確認（必読）**
> SP-000 GroupC の回答を確認すること。
> **「DB なし」でも即スキップしない。** まず SP-001 の調査でデータファイル（CSV / CDXML / JSON 等）の有無を確認する。
> - **DB あり** → #2（テーブル数概算）へ進む
> - **DB なし + データファイルあり** → #2'（データファイル種別確認）へ進む
> - **DB なし + データファイルもなし** → この SP 全体をスキップして SP-003 へ進む
> SP-001（初回調査）が完了していることを確認すること。

---

## Claude への指示

以下の手順を順番に実行してください。

### [ ] #1: 前提確認

SP-001 の完了状態と SP-000 GroupC の回答、SP-001-01 の調査結果を確認する。

- SP-001 の子チケット一覧を開き、全チケットが「完了」であることを確認する
- SP-000 を開き、GroupC「DB 有無」の回答を確認する
- SP-001-01.md の調査記録を開き、データファイル（CSV / CDXML / JSON 等）の有無を確認する
- 以下の分岐で次のステップを決定する:
  - **「DB あり」** → #2（テーブル数概算）へ進む
  - **「DB なし」かつ SP-001-01 の調査にデータファイルあり** → #2'（データファイル種別確認）へ進む
  - **「DB なし」かつデータファイルもなし** → この SP をスキップし SP-003 へ進む旨をユーザーに伝える
- 確認した情報を下の管理記録テーブルに転記する

---

### [ ] #2: テーブル数概算計測（DB パスのみ）

> **実行条件**: #1 で「DB あり」と確認した場合のみ実行。ファイルベースパスの場合は #2' へ。

コードベースのモデル定義・マイグレーションファイル・DDL から主要テーブル数を概算する。

- テーブル数を計測し、ユーザーに提示する
- **テーブル数 30 以上の場合**: ドメイン別 / サブシステム別への分割を提案し、ユーザーが判断する
  - 分割する場合: SP-002-04 以降を動的追加し、SP-002-01 のスコープを調整する
- 計測結果を下の管理記録テーブルに記録する

---

### [ ] #2': データファイル種別・数の確認（ファイルベースパスのみ）

> **実行条件**: #1 で「DB なし + データファイルあり」と確認した場合のみ実行。

SP-001-01・SP-001-02 の調査結果から、データファイルの全体像を把握する。

- データファイルを種別ごとにリストアップし、ユーザーに提示する（例: CSV × 8、CDXML × 10、JSON × 1）
- 各ファイルのおおよその役割（入力 / 出力 / 中間 / マスタ）を確認する
- **ファイル数が多い場合（目安: CSV + その他合計 20 ファイル以上）**: 役割カテゴリ別への分割を提案し、ユーザーが判断する
  - 分割する場合: SP-002-04 以降を動的追加し、SP-002-01 のスコープを調整する
- 確認結果を下の管理記録テーブルに記録する

---

### [ ] #3: 実DB / 実ファイルアクセス可否の確認

実 DB またはデータファイルへのアクセス可否を確認する。

- **DB パスの場合**: 「実DBにアクセスできますか？（本番 / ステージング / ローカルのいずれか）」とユーザーに確認する
  - 「可能」→ SP-002-03 を実行する
  - 「不可」→ SP-002-03 の Phase 1 で理由を記録し、確認が必要な項目をリストアップして完了とする
- **ファイルベースパスの場合**: データファイルへの直接アクセスが可能か確認する（通常は常に可能）
  - 「可能」→ SP-002-03 を実行する（実ファイル照合）
  - 「不可」（ファイルが別環境等）→ SP-002-03 の Phase 1 で理由を記録して完了とする
- 回答を下の管理記録テーブルに記録する

---

### [ ] #4: 子チケット順次実行

以下の順番で子チケットを実行する。

| # | チケット | 内容 | DB パス | ファイルベースパス |
|---|---------|------|---------|-----------------|
| 1 | [SP-002-01.md](SP-002-01.md) | スキーマ取得・データ構造詳細 | 実行（RDB スキーマ） | 実行（CSV / CDXML / JSON 構造） |
| 2 | [SP-002-02.md](SP-002-02.md) | マスタデータ確認 | 実行（マスタテーブル） | 実行（CDXML マスタ / CSV コード値） |
| 3 | [SP-002-03.md](SP-002-03.md) | 実DB / 実ファイル照合 | #3 で「可能」の場合のみ | #3 で「可能」の場合のみ |
| 4 | [SP-002-context.md](SP-002-context.md) | データ層仕様書ファイル構成設計 | 上記完了後 | 上記完了後 |
| 5 | [SP-002-gate.md](SP-002-gate.md) | Gate 2 チェック | 最後に実行 | 最後に実行 |

> 動的追加チケット（SP-002-04 以降）がある場合は上記の間に適宜挿入する。

---

### [ ] #5: Gate 2 宣言

SP-002-gate の Gate 判定サマリーをユーザーに提示し、Go/No-Go 宣言の DD を起票する。

---

## 管理記録

| 項目 | 値 |
|------|-----|
| SP-001 完了確認 | - |
| SP-000 GroupC（DB 有無） | - |
| 実行パス（DB / ファイルベース / スキップ） | - |
| データファイル種別・ファイル数（ファイルベースパスのみ） | - |
| テーブル数概算（DB パスのみ） | - |
| 実DB / 実ファイルアクセス可否 | - |
| 動的追加チケット | - |

---

## 子チケット一覧

| チケット | ステータス |
|---------|----------|
| [SP-002-01.md](SP-002-01.md) スキーマ取得・データ構造詳細 | 未着手 |
| [SP-002-02.md](SP-002-02.md) マスタデータ確認 | 未着手 |
| [SP-002-03.md](SP-002-03.md) 実DB / 実ファイル照合 | 未着手 |
| [SP-002-context.md](SP-002-context.md) データ層仕様書ファイル構成設計 | 未着手 |
| [SP-002-gate.md](SP-002-gate.md) Gate 2 チェック | 未着手 |
