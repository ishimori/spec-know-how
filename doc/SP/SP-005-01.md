# SP-005-01: 認証・認可

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 5（非機能要件を確認する）完了を目指す — 認証・認可・セキュリティ・ログ・運用を仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 5「非機能要件を確認する」**（GUIDE_SPEC.md Step 5 セクション参照）

**目的**: 認証の仕組みを確認し、認可を画面・操作・データの3層で確認する。未認証時の挙動も把握する

> ⚠️ **認証方式複数混在の場合**: SP-005 親チケット #2 の指示に従い、このチケットを認証方式別に分割すること。

> ⚠️ **SP-003-02 認可マトリクスが存在する場合**: Phase 2 では「画面レベル認可は確認済み」として、操作レベル・データレベルの追加確認に集中する。

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（認証の仕組み確認） |
| Phase 2 | 常に実行（認可の3層確認） |
| Phase 3 | 常に実行（未認証時の挙動確認） |

---

## Phase 1: 認証の仕組み確認

> SP-000 Q13 の回答（認証方式）を起点にコードを確認すること。

- [ ] 認証方式を確認した（セッション / JWT / OAuth / SAML / 認証なし / 複合）
- [ ] 認証フローの主要ロジックを把握した（ログイン処理・トークン発行・セッション管理等）
- [ ] 認証情報の保存場所・有効期限を確認した（Cookie / LocalStorage / DB 等）
- [ ] リフレッシュトークン・セッション延長の仕組みがあるか確認した

### 調査記録（Phase 1）

| 項目 | 確認結果 | コード根拠（ファイルパス:行番号） | 信頼度 |
|------|---------|-------------------------------|--------|
| 認証方式 | - | - | High / Medium / Low |
| 認証フロー概要 | - | - | High / Medium / Low |
| 認証情報の保存場所 | - | - | High / Medium / Low |
| 有効期限 | - | - | High / Medium / Low |
| リフレッシュ / セッション延長 | あり / なし / 未確認 | - | High / Medium / Low |

---

## Phase 2: 認可の3層確認

> 認可の確認は以下の3層で行う。漏れなく確認すること。
> **SP-003-02 認可マトリクスが存在する場合、層1は「確認済み（SP-003-02 参照）」として記録し、層2・3に集中する。**

- **層1（画面レベル）**: どのロールがどの画面・エンドポイントにアクセスできるか
- **層2（操作レベル）**: 同じ画面内でロールによって操作できるアクションが変わるか（編集可/閲覧のみ等）
- **層3（データレベル）**: ロールや所属によってアクセスできるデータが絞られるか（自部門のみ/自分のデータのみ等）

- [ ] **層1** 画面レベル認可を確認した
- [ ] **層2** 操作レベル認可（条件付きアクション）を確認した
- [ ] **層3** データレベル認可（データフィルタリング条件）を確認した
  - データレベル認可がない場合: 「なし」と明記する
- [ ] 複数ロールを持つユーザー（兼務・ゲスト等）の挙動を確認した（ある場合）

### 調査記録（Phase 2）

**層1: 画面レベル認可**

| 確認方法 | 結果 |
|---------|------|
| SP-003-02 認可マトリクス参照 | あり（参照済み）/ なし（SP-003 スキップ） |
| 独自確認が必要な項目 | - |

**層2: 操作レベル認可**

| 画面 / エンドポイント | ロール | 条件付きアクション | コード根拠（ファイルパス:行番号） | 信頼度 |
|--------------------|--------|-----------------|-------------------------------|--------|
| - | - | - | - | High / Medium / Low |

**層3: データレベル認可**

| 対象データ / テーブル | フィルタリング条件 | コード根拠（ファイルパス:行番号） | 信頼度 |
|-------------------|----------------|-------------------------------|--------|
| - | - | - | High / Medium / Low |

> データレベル認可なし → 「なし（全ロールが全データにアクセス可能）」と記録する。

---

## Phase 3: 未認証時の挙動確認

- [ ] 未認証でのアクセス時の挙動を確認した（リダイレクト先 / エラー応答コード 等）
- [ ] 認証チェックの実装箇所（ミドルウェア / デコレータ / ガード等）を把握した

### 調査記録（Phase 3）

| 項目 | 確認結果 | コード根拠（ファイルパス:行番号） | 信頼度 |
|------|---------|-------------------------------|--------|
| 未認証時の挙動 | - | - | High / Medium / Low |
| 認証チェック実装箇所 | - | - | High / Medium / Low |

---

## DA 分析（このチケットのスコープ限定）

> 「データレベルの認可を見落としていないか？認証バイパスが可能なエンドポイントはないか？」の観点で批判的に確認する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| - | なし | - | - |

---

## コンテキスト回収

> この作業中に会話コンテキストにのみ存在する知見・気づきがあれば、
> 上の作業セクションまたは下の「追加タスク」に追記する。

- [ ] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| - | - | - |

---

## 完了時の確認

- [ ] SP-005 の子チケット一覧の本チケットを「完了」に更新した
