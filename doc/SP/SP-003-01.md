# SP-003-01: 画面一覧・画面遷移

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 3（画面・UI を把握する）完了を目指す — 画面構成・遷移・操作フローを把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 3「画面・UI を把握する」**（GUIDE_SPEC.md Step 3 セクション参照）

**目的**: 全画面の一覧化・API エンドポイント対応・主要操作フロー・画面遷移を把握する。「画面の機能（何ができるか）」を調査対象とし、「UIの構成（どう見せるか）」は記録しない（GUIDE_SPEC.md 気付き #8）

**最終的な使われ方**: SP-003-context で画面仕様書ファイルの構成を設計する際の根拠となる。画面に紐づく API エンドポイントは SP-004（業務ロジック抽出）の調査起点としても使用される

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（画面一覧・API対応） |
| Phase 2 | 常に実行（操作フロー・画面遷移） |

> **画面数が 15 以上の場合**: SP-003 親チケット #2 の指示に従い、SP-003-01 のスコープを調整すること（機能ドメイン別・ロール別に分割して SP-003-04 以降へ委譲）。

> ⚠️ **記録ルール**: 「画面の機能（何ができるか）」のみ記録する。「UIの構成（どのライブラリを使うか・レイアウト詳細）」は記録しない。

---

## Phase 1: 画面一覧・API エンドポイント対応

- [x] 画面一覧を作成した（画面名・URL/パス・主な機能）
- [x] モーダル・ダイアログなど補助的な画面も含めて把握した
- [x] 画面に紐づく API エンドポイントを把握した
- [x] 作成した画面仕様書ファイルを `CLAUDE.md` または `document_map.md` に追記した（SP-003-context で実施）

### 前提：ipywidgets における「画面」の定義

このアプリは JupyterLab 上で動作する単一 Python プロセスであり、画面遷移（URLルーティング）は存在しない。
「画面」= **ユーザーが切り替えるタブ単位** として定義する。
「API エンドポイント」は存在しない（フロントエンドとバックエンドが同一プロセス内で動作）。
代わりに「主要な操作（ボタン/入力 → 処理関数）」の対応を記録する。

### 調査記録（Phase 1）

#### L0: トップレベルタブ（`self.tabs`、`app_core/ui.py:870`）

| 画面名 | タブ ID | 主な機能 | 対象ロール | 対応する主要関数 | 信頼度 |
|-------|---------|---------|----------|----------------|--------|
| **Formulation** | tabs[0] | 配合設計（ポリマー定義 + レジスト配合入力） | 全ユーザー（認証なし） | `PolymericDefBuilder`, `ResistRowWidget`, `App.save()` | High |
| **Table** | tabs[1] | 配合結果テーブルの閲覧・エクスポート | 全ユーザー | `App.render_all_tables()`, `App.export_tables()` | High |
| **Structures** | tabs[2] | 使用中 / 全構造の ID-構造一覧閲覧・CDXML エクスポート | 全ユーザー | `App.render_registry()`, `App.export_structures()` | High |

#### L1: Formulation タブ内サブタブ（`self.formulation_tabs`、`ui.py:862`）

| 画面名 | タブ ID | 主な機能 | 対応する主要関数 | 信頼度 |
|-------|---------|---------|----------------|--------|
| **Polymer** | formulation_tabs[0] | ポリマー定義の追加・編集・ID登録（Mw/Mw-Mn・モノマー配合） | `PolymericDefBuilder.__init__()`, `PolymericDefRowWidget.on_click_register()` | High |
| **F-Polymer** | formulation_tabs[1] | フッ素ポリマー定義の追加・編集・ID登録（同上） | `PolymericDefBuilder.__init__()` (CAT="FPolymer") | High |
| **Resist** | formulation_tabs[2] | レジスト配合行の追加・編集・物性計算・保存 | `App.add_resist_row()`, `ResistRowWidget`, `App.save()` | High |

#### L1: Table タブ内サブタブ（`self.bottom_tabs`、`ui.py:759`）

| 画面名 | タブ ID | 主な機能 | 対応する主要関数 | 信頼度 |
|-------|---------|---------|----------------|--------|
| **Resist Table** | bottom_tabs[0] | レジスト配合のサマリーテーブル表示 | `App.render_resist_table()` | High |
| **Performance Table** | bottom_tabs[1] | 物性値テーブル表示（k/LogP/OP/TSC 等） | `App.render_performance_table()` | High |
| **Polymer Table** | bottom_tabs[2] | 登録ポリマーの ID・定義一覧 | `App.render_poly_table()` | High |
| **F-Polymer Table** | bottom_tabs[3] | 登録 F-Polymer の ID・定義一覧 | `App.render_fpolymer_table()` | High |

#### L2: Structures タブ内動的サブタブ（`render_registry()` で生成、`ui.py:2310`）

| 画面名 | 生成タイミング | 主な機能 | 信頼度 |
|-------|------------|---------|--------|
| **PAG / PDB / Solvent / Additive / Monomer / FPolymer_Monomer / Polymer / FPolymer**（カテゴリ数分） | `render_registry()` 呼び出し時に動的生成 | 各カテゴリの ID-構造一覧（ID コード + 名前 + 構造画像） | High |

#### モーダル・ダイアログ

**なし**。確認ダイアログ・モーダルは一切使用していない。保存/エクスポートの結果は `w.HTML`（`msg_out`, `table_msg_out`, `structure_msg_out`）でインライン表示される。

---

## Phase 2: 操作フロー・画面遷移

- [x] 主要な操作フロー（Happy Path）を把握した
- [x] 画面遷移を図または文章で整理した

### 調査記録（Phase 2）

**主要操作フロー:**

| フロー名 | ステップ（画面の順序） | 備考 |
|---------|-----------------|------|
| **初回起動・ロード** | `launch_app()` → `App.__init__()` → `app.load_latest()` → Formulation > Resist 画面に最新 CSV の状態を復元 | `Intermediate/mixture_*_components.csv` の最新ファイルを自動ロード |
| **ポリマー定義 → ID 登録** | Formulation > Polymer（モノマー選択・mol% 入力・Mw 入力） → Register ボタン → ID 付与（`P-N` 形式） → `Intermediate/id_registry.json` に保存 | F-Polymer も同フロー（ID: `M-N` 共通連番） |
| **レジスト配合設計** | Formulation > Resist → Add Row → 各行で Polymer/PAG/PDB/Solvent/Additive 選択・PHR 入力 → 物性値リアルタイム計算（k/LogP/OP/TSC） → Save → `Intermediate/mixture_*_components.csv` 保存 | Save 時に `result_with_id.csv` も生成 |
| **テーブル確認・エクスポート** | Table > Resist Table / Performance Table → Refresh Tables → Export Tables → `Result_YYMMDD/` に 4 CSV 出力 | Refresh は Export 時に自動実行 |
| **構造 CDXML エクスポート** | Structures → 使用中のみ / 全構造 切り替え → Export Structures → `Result_YYMMDD/*_ID.cdxml` 出力（使用中構造の名称を ID に置換） | 未使用構造は CDXML から除去される |

**画面遷移（文章または図）:**

```
[JupyterLab 起動]
  └─ launch_app() 実行（Notebook セル）
       └─ App.__init__() → 単一アプリウィジェットを display()
            └─ load_latest() → 最新 CSV から状態復元
                 ↓
[トップレベル 3 タブ]
┌────────────────────────────────────────────────────┐
│ Formulation ←→ Table ←→ Structures                │
│ （タブクリックで切り替え、状態は App オブジェクトに保持） │
└────────────────────────────────────────────────────┘

Formulation タブ内サブタブ:
  Polymer ←→ F-Polymer ←→ Resist
  ↑                          ↓
  Register ボタン            Save ボタン
  （id_registry.json 更新）   （mixture_*.csv 保存）
                              ↓
                         Table タブ / Structures タブ
                         （Refresh / Export で更新）

※ 画面間の遷移はすべてタブクリックのみ。
  URLルーティング・ページ遷移・リダイレクトは存在しない。
  状態（配合行・ID レジストリ）は App オブジェクトがメモリに保持。
  永続化はボタン操作（Save/Export）によってのみ発生する。
```

---

## DA 分析（このチケットのスコープ限定）

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | `patent_support.ipynb` の Notebook 本体に UI 定義がほぼなく（76行）、全 UI が `app_core/ui.py` に集中している。Notebook の残り処理（launch_app 以外の処理）があるか未確認 | Low | SP-003-03 または SP-004 で Notebook セルを確認する |
| 2 | Structures タブの動的サブタブはカタログにあるカテゴリ数に依存して変動する。現在の canon_order は 5 カテゴリだが追加可能 | Low | 記録は「動的生成」として扱い、固定カテゴリ数に依存した仕様書を書かない |

---

## コンテキスト回収

- [x] コンテキストにしか残っていない重要な情報がないか確認した

**回収した知見:**
- `ResistRowWidget.controls_by_category` がカテゴリ別の入力コントロール（Dropdown + PHR）を保持する辞書構造。SP-004 での業務ロジック抽出の起点となる
- Solvent のみ特殊な計算ロジックあり（TSC% から自動 PHR 計算: `_recalc_solvent()`）→ SP-004 で仕様化必要
- Polymer の PHR は常に `polymer_total_phr`（デフォルト 100）固定で、サブ成分の PHR 合計で自動補完
- `_sync_polymer_definitions_from_ui()` が Save 時にポリマー定義 CSV を更新（Mw/Mw-Mn の差分のみ追記）

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| `patent_support.ipynb` の全セルを確認（`launch_app` 以外の処理があるか） | SP-003-03 または SP-004 | Low |
| Solvent TSC 計算ロジックの仕様化（`_recalc_solvent()`） | SP-004 | High |
| Polymer PHR 固定・自動補完ロジックの仕様化（`_make_polymeric_card()` 内の `_update_balance()`） | SP-004 | High |

---

## 完了時の確認

- [x] SP-003 の子チケット一覧の本チケットを「完了」に更新した
