# SP-002-03: 実DB / 実ファイル照合

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 2（データ層を取得する）完了を目指す — DB構造またはデータファイル構造を把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 2「DB・データモデルを取得する」**（GUIDE_SPEC.md Step 2 セクション参照）

**目的**: コードからの推測だけでは見えない「実データの実態」を機械的に確認する。DB パスではテーブル件数・フラグ分布・DBオブジェクトを照合する。ファイルベースパスでは実ファイルを直接読み取り、カラム名・実際の型・サンプル値・行数を記録して SP-002-01 の推測と照合する。

**最終的な使われ方**: 照合結果はデータ層仕様書の信頼度を High に引き上げる根拠となる。アクセスできなかった場合、後続フェーズでの確認タスクとして引き継ぐ

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（前提確認・アクセス可否の最終確認） |
| Phase 2（DB パス） | 実DBアクセス可能 かつ SP-002 親チケット #1 で「DB あり」の場合のみ |
| Phase 2'（ファイルベースパス） | ファイルアクセス可能 かつ SP-002 親チケット #1 で「DB なし + データファイルあり」の場合のみ |

> **このチケットは SP-002 親チケット #3 で「実DB / 実ファイルアクセス可能」と確認された場合のみ Phase 2 / 2' を実行する。**
> 「不可」の場合は Phase 1 で理由を記録し、完了とする。

---

## Phase 1: 前提確認（両パス共通）

**DB パスの場合:**
- [ ] SP-000 で `scripts/analyze/` が作成されているか確認した
  - 存在する場合: スクリプトのパスを記録し Phase 2 へ進む
  - 存在しない場合: 理由を記載し、手動照合またはスキップの方針を決定する
- [ ] 実DBへの接続情報・アクセス方法をユーザーに確認した

**ファイルベースパスの場合:**
- [ ] SP-002-01 で把握したデータファイルへの直接アクセスが可能か確認した（パス・権限）
  - 可能な場合: Phase 2' へ進む（通常は常に可能）
  - 不可の場合: 理由を記録し、完了とする

### 前提確認記録

**DB パス:**

| 項目 | 確認結果 |
|------|---------|
| `scripts/analyze/` の存在 | - |
| `table_stats.py` の存在 | - |
| `flag_distribution.py` の存在 | - |
| `db_objects.py` の存在 | - |
| 実DBアクセス方法 | - |

**ファイルベースパス:**

| 項目 | 確認結果 |
|------|---------|
| データファイルへのアクセス可否 | 可能（C:\tmp\260202_app_with_data に直接アクセス済み） |
| ファイルパス（代表） | C:\tmp\260202_app_with_data\Intermediate\, Result_260202\ |

**アクセス不可の場合（理由と引き継ぎ項目）:**

| 理由 | 後続フェーズで確認が必要な項目 |
|------|-------------------------|
| - | - |

---

## Phase 2: 実DB照合（DB パスのみ）

> **実行条件**: 「DB あり」かつ実DBアクセス可能な場合のみ実行。
>
> 貼り付けフォーマット（監査用）:
> ```
> # 実行コマンド
> <ここにコマンドを記載>
> # 実行結果
> <ここに出力を貼り付け>
> ```

- [ ] `table_stats.py` を実行し、主要テーブルの件数をコード推測値と照合した
- [ ] `flag_distribution.py` を実行し、フラグ・ステータス列の実際の値分布を確認した（予想外の値がないか）
- [ ] `db_objects.py` を実行し、ストアドプロシージャ・ビューの実存在を DB レベルで確認した

### 照合記録（Phase 2: DB パス）

| テーブル名 | コード推測件数 | 実DB件数 | 乖離・備考 |
|----------|-----------|---------|---------|
| - | - | - | - |

| フラグ/ステータス列 | 期待する値 | 実際の値分布 | 異常値・備考 |
|----------------|---------|-----------|---------|
| - | - | - | - |

| DBオブジェクト（SP/View） | コードで把握 | DBに実存在 | 備考 |
|----------------------|----------|----------|------|
| - | - | - | - |

---

## Phase 2': 実ファイル照合（ファイルベースパスのみ）

> **実行条件**: 「DB なし + データファイルあり」かつファイルアクセス可能な場合のみ実行。
> Python スクリプト（`uv run python -c "..."` 等）で実ファイルを読み取り、SP-002-01 の推測と照合する。
>
> 貼り付けフォーマット（監査用）:
> ```
> # 実行コマンド
> <ここにコマンドを記載>
> # 実行結果
> <ここに出力を貼り付け>
> ```

- [x] 各 CSV ファイルを読み取り、実際のカラム名・dtype・行数を記録した
- [x] CSV のカラム名・行数が SP-002-01 の推測と一致しているか照合した
- [x] CDXML ファイルの実要素数・主要要素の実存在を確認した
- [x] JSON ファイルの実フィールド構成を確認した
- [x] 中間データ（Intermediate/ 等）の実ファイルが SP-002-01 の記録と一致しているか確認した

### 照合記録（Phase 2': ファイルベースパス）

**実行コマンド（CSV）:**
```
# 実行コマンド
python -c "import pandas as pd; [print(f, len(df:=pd.read_csv(f)), list(df.columns)) for f in [...]]"
# 実行結果（概要）
各ファイルの行数・カラム数を取得
```

**CSV ファイル照合:**

| ファイル名 | 実カラム数 | 実行数 | カラム名（実測） | 乖離・異常値・備考 |
|----------|---------|------|--------------|---------------|
| `result_with_id.csv` | 18 | 3 | Resist_ID(str), LWR(float), Field 2〜4(float), Memo(float), k/OP/MOP/LogP/PDB/PAG/TSC(float), Polymer/PAG/PDB/Solvent/FPolymer/Additive(str) | SP-002-01 と一致。Memo列はfloat（空値がNaN化） |
| `Intermediate/polymer_definitions.csv` | 5 | 2 | Category/ID/Signature(str), Mw/Mw_Mn(float) | SP-002-01 と一致 |
| `Intermediate/mixture_20260202_073645_components.csv` | 5 | 42 | Resist_ID/Type/Category/Name/Value(str) | SP-002-01 と一致。2レジスト分（R-1, R-2）の展開データ |
| `Intermediate/mixture_20260202_073719_components.csv` | 5 | 61 | 同上 | SP-002-01 と一致。3レジスト分（R-1, R-2, R-3）の展開データ |
| `Result_260202/resist_table.csv` | 13 | 3 | レジスト種/ポリマー種/ポリマー質量/PAG種/PAG量/PDB種/PDB量/溶剤種/溶剤量/フッ素ポリマー種/フッ素ポリマー量/添加剤種/添加剤量 | SP-002-01 と一致 |
| `Result_260202/polymer_table.csv` | 7 | 1 | ポリマー種/モノマー種1/モノマー割合1/モノマー種2/モノマー割合2/Mw/Mw/Mn | SP-002-01 と一致 |
| `Result_260202/fpolymer_table.csv` | 5 | 1 | フッ素ポリマー種/モノマー種1/モノマー割合1/Mw/Mw/Mn | SP-002-01 と一致 |
| `Result_260202/performance_table.csv` | 2 | 3 | レジスト種/LWR | SP-002-01 と一致 |

**CDXML ファイル照合:**

| ファイル名 | 実グループ数（分子数） | 確認したラベル | SP-002-01 との差異 |
|----------|----------------|------------|----------------|
| `Solvent.cdxml` | **3** | PGME, PGMEA, GBL | **差異あり** — GBL（γ-ブチロラクトン）が3つ目の分子として存在。id_registry.json・Result_260202 には未登録 |
| `Additive.cdxml` | 2 | PGME（構造）, Acetic acid | **差異あり** — PGME構造がAdditive.cdxmlに存在するが、ID未付与。Acetic acid (D-1) のみ使用 |
| `Monomer.cdxml` | 2 | HydroxyStyrene, Styrene | 一致 |
| `PAG.cdxml` | **4** | GreatPAG_pag, GoodPAG_pag, BadPAG_pag + 1構造 | **差異あり** — 4分子定義だが id_registry.json は A-1〜A-3 の3件のみ |
| `PDB.cdxml` | **4** | GreatPDB_pag, GoodPDB_pag, BadPDB_pag + 1構造 | **差異あり** — 4分子定義だが id_registry.json は B-1 の1件のみ（他3種は未使用）|
| `Result_260202/Solvent_ID.cdxml` | 2 | S-1, S-2 | 一致（GBL は出力に含まれない） |
| `Result_260202/Additive_ID.cdxml` | 1 | D-1 | 一致 |
| `Result_260202/Monomer_ID.cdxml` | 2 | M-1, M-2 | 一致 |
| `Result_260202/PAG_ID.cdxml` | 3 | A-1, A-2（A-3 は非表示の可能性） | おおむね一致 |
| `Result_260202/PDB_ID.cdxml` | 2 | B-1 | 一致（使用済みのみ出力） |

**JSON ファイル照合:**

| ファイル名 | 実フィールド構成（代表） | SP-002-01 との差異 |
|----------|-------------------|----------------|
| `Intermediate/id_registry.json` | {カテゴリ7種: {SMILES/シグネチャ: ID}} — Polymer/Monomer/FPolymer/PAG/PDB/Solvent/Additive | なし |

---

## DA 分析（このチケットのスコープ限定）

> 「照合結果で何が不自然か？SP-002-01 の推測との乖離はないか？アクセスできなかった場合に何が見落とされるか？」の観点で批判的に確認する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | **入力 CDXML マスタに「未使用材料」が存在する**: Solvent.cdxml の GBL・PDB.cdxml の3種（B-1以外）等がマスタに定義されているが id_registry.json に未登録（＝レジスト配合で一度も使われていない）。新システム設計時にこれらを「候補材料」として扱うか要確認 | High | SP-002-context の data_schema.md に「未使用材料はマスタに存在するが ID 未付与」を明記。SP-004 で業務上の扱いを確認する |
| 2 | **Additive.cdxml に PGME の構造が混入**: Additive（添加剤）マスタに溶剤（PGME）の化学構造が含まれており、ID は付与されていない。意図的か誤りかが不明 | Medium | data_schema.md に「Additive.cdxml にはPGME構造が含まれるが未使用」を記録。SP-004 で確認する |
| 3 | **セッション毎に mixture_*.csv が累積生成される**: 新しいタイムスタンプのファイルが追加されるが、古いものは削除されない。新システムでは世代管理ポリシーの設計が必要 | Low | SP-004 でファイル管理ポリシーを確認 |

---

## コンテキスト回収

> この作業中に会話コンテキストにのみ存在する知見・気づきがあれば、
> 上の作業セクションまたは下の「追加タスク」に追記する。

- [x] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| - | - | - |

---

## 完了時の確認

- [x] SP-002 の子チケット一覧の本チケットを「完了」に更新した
