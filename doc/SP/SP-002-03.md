# SP-002-03: 実DB / 実ファイル照合

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 2（データ層を取得する）完了を目指す — DB構造またはデータファイル構造を把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 2「DB・データモデルを取得する」**（GUIDE_SPEC.md Step 2 セクション参照）

**目的**: コードからの推測だけでは見えない「実データの実態」を機械的に確認する。DB パスではテーブル件数・フラグ分布・DBオブジェクトを照合する。ファイルベースパスでは実ファイルを直接読み取り、カラム名・実際の型・サンプル値・行数を記録して SP-002-01 の推測と照合する。

**最終的な使われ方**: 照合結果はデータ層仕様書の信頼度を High に引き上げる根拠となる。アクセスできなかった場合、後続フェーズでの確認タスクとして引き継ぐ

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（前提確認・アクセス可否の最終確認） |
| Phase 2（DB パス） | 実DBアクセス可能 かつ SP-002 親チケット #1 で「DB あり」の場合のみ |
| Phase 2'（ファイルベースパス） | ファイルアクセス可能 かつ SP-002 親チケット #1 で「DB なし + データファイルあり」の場合のみ |

> **このチケットは SP-002 親チケット #3 で「実DB / 実ファイルアクセス可能」と確認された場合のみ Phase 2 / 2' を実行する。**
> 「不可」の場合は Phase 1 で理由を記録し、完了とする。

---

## Phase 1: 前提確認（両パス共通）

**DB パスの場合:**
- [ ] SP-000 で `scripts/analyze/` が作成されているか確認した
  - 存在する場合: スクリプトのパスを記録し Phase 2 へ進む
  - 存在しない場合: 理由を記載し、手動照合またはスキップの方針を決定する
- [ ] 実DBへの接続情報・アクセス方法をユーザーに確認した

**ファイルベースパスの場合:**
- [ ] SP-002-01 で把握したデータファイルへの直接アクセスが可能か確認した（パス・権限）
  - 可能な場合: Phase 2' へ進む（通常は常に可能）
  - 不可の場合: 理由を記録し、完了とする

### 前提確認記録

**DB パス:**

| 項目 | 確認結果 |
|------|---------|
| `scripts/analyze/` の存在 | - |
| `table_stats.py` の存在 | - |
| `flag_distribution.py` の存在 | - |
| `db_objects.py` の存在 | - |
| 実DBアクセス方法 | - |

**ファイルベースパス:**

| 項目 | 確認結果 |
|------|---------|
| データファイルへのアクセス可否 | - |
| ファイルパス（代表） | - |

**アクセス不可の場合（理由と引き継ぎ項目）:**

| 理由 | 後続フェーズで確認が必要な項目 |
|------|-------------------------|
| - | - |

---

## Phase 2: 実DB照合（DB パスのみ）

> **実行条件**: 「DB あり」かつ実DBアクセス可能な場合のみ実行。
>
> 貼り付けフォーマット（監査用）:
> ```
> # 実行コマンド
> <ここにコマンドを記載>
> # 実行結果
> <ここに出力を貼り付け>
> ```

- [ ] `table_stats.py` を実行し、主要テーブルの件数をコード推測値と照合した
- [ ] `flag_distribution.py` を実行し、フラグ・ステータス列の実際の値分布を確認した（予想外の値がないか）
- [ ] `db_objects.py` を実行し、ストアドプロシージャ・ビューの実存在を DB レベルで確認した

### 照合記録（Phase 2: DB パス）

| テーブル名 | コード推測件数 | 実DB件数 | 乖離・備考 |
|----------|-----------|---------|---------|
| - | - | - | - |

| フラグ/ステータス列 | 期待する値 | 実際の値分布 | 異常値・備考 |
|----------------|---------|-----------|---------|
| - | - | - | - |

| DBオブジェクト（SP/View） | コードで把握 | DBに実存在 | 備考 |
|----------------------|----------|----------|------|
| - | - | - | - |

---

## Phase 2': 実ファイル照合（ファイルベースパスのみ）

> **実行条件**: 「DB なし + データファイルあり」かつファイルアクセス可能な場合のみ実行。
> Python スクリプト（`uv run python -c "..."` 等）で実ファイルを読み取り、SP-002-01 の推測と照合する。
>
> 貼り付けフォーマット（監査用）:
> ```
> # 実行コマンド
> <ここにコマンドを記載>
> # 実行結果
> <ここに出力を貼り付け>
> ```

- [ ] 各 CSV ファイルを読み取り、実際のカラム名・dtype・行数を記録した
- [ ] CSV のカラム名・行数が SP-002-01 の推測と一致しているか照合した
- [ ] CDXML ファイルの実要素数・主要要素の実存在を確認した
- [ ] JSON ファイルの実フィールド構成を確認した
- [ ] 中間データ（Intermediate/ 等）の実ファイルが SP-002-01 の記録と一致しているか確認した

### 照合記録（Phase 2': ファイルベースパス）

**CSV ファイル照合:**

| ファイル名 | SP-002-01 推測カラム数 | 実カラム数 | 実行数 | 乖離・異常値・備考 |
|----------|------------------|---------|------|---------------|
| - | - | - | - | - |

**CDXML ファイル照合:**

| ファイル名 | 確認した主要要素 | SP-002-01 との差異 |
|----------|-------------|----------------|
| - | - | なし / あり（詳細:） |

**JSON ファイル照合:**

| ファイル名 | 実フィールド構成（代表） | SP-002-01 との差異 |
|----------|-------------------|----------------|
| - | - | なし / あり（詳細:） |

---

## DA 分析（このチケットのスコープ限定）

> 「照合結果で何が不自然か？SP-002-01 の推測との乖離はないか？アクセスできなかった場合に何が見落とされるか？」の観点で批判的に確認する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| - | なし | - | - |

---

## コンテキスト回収

> この作業中に会話コンテキストにのみ存在する知見・気づきがあれば、
> 上の作業セクションまたは下の「追加タスク」に追記する。

- [ ] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| - | - | - |

---

## 完了時の確認

- [ ] SP-002 の子チケット一覧の本チケットを「完了」に更新した
