# SP-004-01: 業務ロジック抽出

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 4（業務ロジックを抽出する）完了を目指す — バリデーション・計算ロジック・状態遷移・主要フローを仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 4「業務ロジックを抽出する」**（GUIDE_SPEC.md Step 4 セクション参照、気付き #7）

**目的**: SP-003-03 の UI 層引き継ぎリストを詳細化しつつ、それ以外のバリデーション・計算ロジック・状態遷移・主要フローを抽出して仕様化する

**最終的な使われ方**: SP-004-context で業務ロジック仕様書ファイルを設計・作成する際の根拠となる。BR-ID を付与した仕様が QA スキルの索引として機能する

> ⚠️ **SP-003 スキップ時（フロントエンドなし）**: SP-003-03 の引き継ぎリストは存在しない。Phase 1 では submit/save 相当の関数を独自に洗い出してから Phase 2 へ進む。

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（UI 層ロジックの引き継ぎ詳細化 / フォールバック探索） |
| Phase 2 | 常に実行（追加ロジック探索） |

> **フロー分割がある場合（SP-004-04〜）**: SP-004-01 のスコープを SP-004 親チケット #2 の指示に従って調整する。

---

## Phase 1: UI 層ロジックの引き継ぎ詳細化（または フォールバック探索）

### SP-003 あり（フロントエンドあり）の場合

- [ ] SP-003-03 の「SP-004 への引き継ぎリスト」を読んだ
- [ ] 引き継ぎリストの各行について、対象関数のコードを読んでバリデーション条件・業務ロジックを詳細化した
- [ ] 引き継ぎリスト外に業務ロジックが隠れていないか、submit/save 以外の関数（onChange ハンドラ・computed プロパティ等）も確認した

### SP-003 スキップ（フロントエンドなし / API のみ）の場合

- [ ] バリデーション・業務条件を持つ可能性がある関数を独自に洗い出した
  （例: バリデーター・サービス層・ユースケース・コントローラーの入力検証）
- [ ] 各関数のコードを読んで業務条件を詳細化した

### 調査記録（Phase 1）

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-001 | - | - | - | バリデーション / 計算 / 状態遷移 / フロー制御 | High / Medium / Low |

---

## Phase 2: 追加業務ロジックの探索

- [ ] 主要な業務フロー（Happy Path）を把握した（サービス層・ユースケース・ドメイン層）
- [ ] 計算ロジック（料金計算・集計処理・日付計算等）を抽出した
- [ ] バリデーションルール（入力制約・業務上の制約）を Phase 1 の記録に追加した
- [ ] 状態遷移（ワークフロー・ステータス管理）の全遷移を把握した
  - **フラグ・ステータス系は SP-004-02 で詳細化するため、ここでは「どのステータス値が存在するか（値の一覧と業務的意味）」のみ記録する。書き込みパス・遷移条件の詳細は SP-004-02 に委譲すること**
- [ ] 「コードに書かれていない暗黙のルール」の候補をメモした（ドメインエキスパート確認が必要な項目）

### 調査記録（Phase 2）

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| - | - | - | - | バリデーション / 計算 / 状態遷移 / フロー制御 | High / Medium / Low |

**暗黙ルール候補（ドメインエキスパート確認が必要）:**

| # | ルール概要 | なぜコードから確認できないか |
|---|----------|--------------------------|
| - | - | - |

---

## DA 分析（このチケットのスコープ限定）

> 「UI 層のバリデーション・submit 関数を見落としていないか？引き継ぎリスト以外の場所に業務条件が隠れていないか？Conflicting（矛盾）が発生していないか？」の観点で批判的に確認する。
> 問題がなければ「なし」と記録すること（無理に問題を作らない）。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| - | なし | - | - |

---

## コンテキスト回収

> この作業中に会話コンテキストにのみ存在する知見・気づきがあれば、
> 上の作業セクションまたは下の「追加タスク」に追記する。

- [ ] コンテキストにしか残っていない重要な情報がないか確認した

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| - | - | - |

---

## 完了時の確認

- [ ] SP-004 の子チケット一覧の本チケットを「完了」に更新した
