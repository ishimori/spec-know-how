# SP-004-01: 業務ロジック抽出

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 4（業務ロジックを抽出する）完了を目指す — バリデーション・計算ロジック・状態遷移・主要フローを仕様として文書化し、後続の QA スキル構築の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 4「業務ロジックを抽出する」**（GUIDE_SPEC.md Step 4 セクション参照、気付き #7）

**目的**: SP-003-03 の UI 層引き継ぎリストを詳細化しつつ、それ以外のバリデーション・計算ロジック・状態遷移・主要フローを抽出して仕様化する

**最終的な使われ方**: SP-004-context で業務ロジック仕様書ファイルを設計・作成する際の根拠となる。BR-ID を付与した仕様が QA スキルの索引として機能する

> ⚠️ **SP-003 スキップ時（フロントエンドなし）**: SP-003-03 の引き継ぎリストは存在しない。Phase 1 では submit/save 相当の関数を独自に洗い出してから Phase 2 へ進む。

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（UI 層ロジックの引き継ぎ詳細化 / フォールバック探索） |
| Phase 2 | 常に実行（追加ロジック探索） |

> **フロー分割がある場合（SP-004-04〜）**: SP-004-01 のスコープを SP-004 親チケット #2 の指示に従って調整する。
> 本チケットは分割なし（SP-004 #2 の判断）、全5フローを扱う。

---

## Phase 1: UI 層ロジックの引き継ぎ詳細化

### SP-003 あり（フロントエンドあり）の場合

- [x] SP-003-03 の「SP-004 への引き継ぎリスト」を読んだ
- [x] 引き継ぎリストの各行について、対象関数のコードを読んでバリデーション条件・業務ロジックを詳細化した
- [x] 引き継ぎリスト外に業務ロジックが隠れていないか、submit/save 以外の関数（onChange ハンドラ・computed プロパティ等）も確認した

### 調査記録（Phase 1）

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-001 | Solvent PHR 自動計算（TSC 逆算） | 固形分合計 `solid_mass = Σ(非Solvent PHR)`、TSC入力値（%）から総溶剤量を逆算: `total_sol = solid_mass × (100 - tsc) / tsc`。各溶剤へ比率配分: `amt_i = total_sol × (rat_i / r_sum)`。適用条件: `solid_mass > 0 かつ 0 < tsc < 100`。**丸め: 計算結果を10の倍数に丸める** `int(val/10 + 0.5) * 10` | `app_core/ui.py:618-636` | 計算 | High |
| BR-002 | Polymer PHR 補完（主成分自動決定） | Polymer スロット0のPHRは常に自動計算（手動編集不可）: `rem = max(0, polymer_total_phr - (slot1_phr + slot2_phr))`。`polymer_total_phr` デフォルト 100（起動パラメータで変更可）。スロット0の DD が空の場合: `rem = 0` | `app_core/ui.py:497-527` | 計算 | High |
| BR-003 | モノマー連番カードのスロット連鎖ロック | slot0 が空 → slot1 DD が disabled / slot1 が空 → slot2 DD が disabled（カスケード）。slot1/2 の PHR 入力は slot 選択後のみ有効。slot0 PHR は always disabled（自動計算） | `app_core/ui.py:504-527` | フロー制御 | High |
| BR-004 | ポリマーシグネチャ形式 | `polymer_signature(names, vals)` → `"MonA=50;MonB=50"` 形式。`;` 区切り、`名前=整数mol%`。旧データの `/` 区切りにもフォールバック対応。末尾の整数は `int(round(float))` | `app_core/ids.py:28-49` | フロー制御 | High |
| BR-005 | ポリマーID付与ルール | シグネチャ（`"MonA=50;MonB=50"` 形式）をキーに `id_registry.json` を照合。既存なら既存IDを返す。新規なら `{prefix}-{max_n+1}` を発番（P-1, P-2, ...）。同時に各モノマーも canonical SMILES をキーに M-{n} ID を発番 | `app_core/ids.py:89-125`, `app_core/ui.py:329-341` | フロー制御 | High |

---

## Phase 2: 追加業務ロジックの探索

- [x] 主要な業務フロー（Happy Path）を把握した（サービス層・ユースケース・ドメイン層）
- [x] 計算ロジック（料金計算・集計処理・日付計算等）を抽出した
- [x] バリデーションルール（入力制約・業務上の制約）を Phase 1 の記録に追加した
- [x] 状態遷移（ワークフロー・ステータス管理）の全遷移を把握した
  - **フラグ・ステータス系は SP-004-02 で詳細化するため、ここでは「どのステータス値が存在するか（値の一覧と業務的意味）」のみ記録する。書き込みパス・遷移条件の詳細は SP-004-02 に委譲すること**
- [x] 「コードに書かれていない暗黙のルール」の候補をメモした（ドメインエキスパート確認が必要な項目）

### 調査記録（Phase 2）

#### A. 物性計算ロジック（compute_properties / _resolve_composition）

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-006 | ポリマー→モノマー展開（mol比→重量比変換） | Polymer 総 PHR を `polymer_total_phr=100` に正規化: `poly_scale = 100 / Σ(Polymer PHR)`。各モノマーの重量比 `W_i = mol_ratio_i × Mw_i`、actual_phr を重量比に基づいて分配: `mon_phr = actual_phr × (W_i / Σ W)`。Mw=0 のモノマーが含まれると計算不能（phr=0 としてスキップ） | `app_core/properties.py:46-130` | 計算 | High |
| BR-007 | k（吸光係数）/ OP / MOP 計算（重量加重平均） | 固形分のみ対象（Solvent 除外）。`k = Σ(phr_i × k_i) / Σphr_i`（OP・MOP も同様）。固形分合計=0 の場合は `None` を返す | `app_core/properties.py:172-183` | 計算 | High |
| BR-008 | LogP 計算（体積加重平均） | 固形分のみ対象。`volume_i = moles_i × vdw_i`、`moles_i = phr_i / Mw_i`（Mw=0 なら moles=0）。`LogP = Σ(volume_i × logp_i) / Σvolume_i`。総体積=0 の場合は `None` を返す | `app_core/properties.py:185-194` | 計算 | High |
| BR-009 | PDB/PAG モル比計算（p_p 値） | 全成分（Solvent 含む）に対して判定。**名前ベース優先**: `_SUFFIX_RE = r'_(\d*)(pag\|pdb)(?=[_\-\s]\|$)'` でサフィックスを検出（例: `_2pag` → pag_factor=2; `_pag` → pag_factor=1; `_1pdb` → pdb_factor=1）。**カテゴリフォールバック**（名前判定が両方0の場合のみ）: category が `"pag"` → pag_factor=1; category が `"pdb"/"quencher"/"base"` → pdb_factor=1。`p_p = total_pdb_moles / total_pag_moles`（PAGゼロなら 0.0 を返す） | `app_core/properties.py:12,200-227` | 計算 | High |
| BR-010 | TSC 計算（固形分濃度） | `TSC = total_solid_phr / (total_solid_phr + total_solvent_phr)` → 0〜1 の比率で返す（UI では ×100 で%表示）。**BR-001 との二重化**: `_recalc_solvent()` は TSC を入力値として溶剤量を逆算するのに対し、`compute_properties()` は現在の PHR 状態から TSC を実計算する → 両者が整合している前提 | `app_core/properties.py:229-233` | 計算 | High |
| BR-011 | DescriptorStore グローバル検索フォールバック | 指定カテゴリで見つからない場合、全カテゴリを順次検索。それでも見つからず名前が SMILES 文字（`=` `#` `c` `C` 含む）の場合は名前そのものを SMILES として解釈 | `app_core/descriptors.py:43-74` | フロー制御 | High |

#### B. ID管理・永続化ロジック

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-012 | canonical SMILES 正規化 | RDKit `Chem.MolToSmiles(mol, isomericSmiles=True)` で正規化。無効 SMILES や空文字は元の文字列をそのまま返す（エラーで落とさない）。**Polymer/FPolymer のシグネチャには適用しない**（シグネチャ形式が SMILES でないため） | `app_core/util.py:31-43`, `app_core/ids.py:109` | フロー制御 | High |
| BR-013 | PolymerDefinitions CSV 追記ルール（重複抑制） | `Mw` / `Mw/Mn` が既存値と同一（浮動小数点比較）なら追記しない。追記方式で最新行優先（`load_latest_map()` は最後の行を採用。同一 ID が複数行ある場合は最後の行が有効） | `app_core/ids.py:163-191`, `app_core/ui.py:374-386` | フロー制御 | High |

#### C. カタログ構築ロジック

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-014 | カタログ構築（CDXML → カテゴリマッピング） | `*.cdxml` ファイル名に `canon_order` のキーワードが含まれるかどうかでカテゴリを決定（例: `monomer` → `"Monomer"`, `pag` → `"PAG"`）。一致しない場合はファイル stem をそのままカテゴリ名として使用。同一カテゴリの複数ファイルは concat して `Name` で dedup（first 優先） | `app_core/util.py:75-111` | フロー制御 | High |

#### D. 保存・エクスポートフロー

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-015 | Save 時のデータ構造（CSV Long 形式） | 1行 = 1成分。`Resist_ID` / `Type` / `Category` / `Name` / `Value` の5列。Type 値: `"Meta"`（Label/Memo/Solvent_Ratios）/ `"Component"`（各成分PHR）/ `"Property"`（計算物性・カスタム入力値）。ファイル名: `mixture_{YYYYMMDD_HHMMSS}_components.csv` | `app_core/ui.py:1005-1022` | フロー制御 | High |
| BR-016 | 構造エクスポートの使用中フィルタリング | `phr > 0` の成分のみ CDXML に残す。Polymer/FPolymer は `def_map` からシグネチャを逆引きしてモノマー名を特定。残す group の名称テキストを ID に置換（canonical SMILES → IdRegistry でルックアップ） | `app_core/ui.py:1052-` | フロー制御 | High |
| BR-017 | デバウンス付きテーブル自動更新 | 成分変更時に `threading.Timer(1.0, ...)` で 1秒デバウンス後に自動更新。Save / Refresh ボタン押下時は即時更新（force=True） | `app_core/ui.py:877-882` | フロー制御 | High |

#### E. SP-002 引き継ぎ事項の追加調査結果

| BR-ID | ルール名 | 詳細（条件・例外を含む） | コード根拠（ファイルパス:行番号） | カテゴリ | 信頼度 |
|-------|---------|----------------------|-------------------------------|---------|--------|
| BR-018 | Type / Category 列のリテラル値（SP-002 引き継ぎ#3） | `mixture_*_components.csv` の Type列に文字列リテラル `"Meta"` / `"Component"` / `"Property"` が直書き（Enum管理なし）。Category列の値はカテゴリ名そのまま（`"Polymer"` / `"PAG"` / `"PDB"` / `"Solvent"` / `"Additive"` / `"Custom"` / `"Memo"` / `"Solvent_Ratios"` / `"Label"` / `"Calculated"`）。スペルミスがデータ欠落として現れる設計 | `app_core/ui.py:1008-1021` | バリデーション | High |

---

**暗黙ルール候補（ドメインエキスパート確認が必要）:**

| # | ルール概要 | なぜコードから確認できないか |
|---|----------|--------------------------|
| 1 | Solvent PHR を 10 の倍数に丸める理由 | コードに `int(val/10 + 0.5) * 10` とあるが、化学的・実験的な根拠（試薬計量精度、天秤精度など）は不明 |
| 2 | `polymer_total_phr = 100` の物理的意味 | PHR（Per Hundred Resin）の定義上は Polymer 合計が 100 であることは自然だが、この値を変更するケースがあるかは不明 |
| 3 | 未使用 CDXML 材料の業務扱い（GBL、PDB B-1以外） | SP-002 引き継ぎ#1: 候補として登録したのか、削除忘れかが不明 |
| 4 | `Additive.cdxml` への PGME 混入の意図 | SP-002 引き継ぎ#2: 比較用途か誤りかが不明 |
| 5 | Polymer と FPolymer の業務上の区別 | 両方 Monomer ライブラリから構成されるが、なぜ別カテゴリとして管理するのかが不明（フォトレジスト化学における機能の違い？） |

---

## DA 分析（このチケットのスコープ限定）

> 「UI 層のバリデーション・submit 関数を見落としていないか？引き継ぎリスト以外の場所に業務条件が隠れていないか？Conflicting（矛盾）が発生していないか？」の観点で批判的に確認する。

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | **TSC の二重化（BR-001 vs BR-010）**: `_recalc_solvent()`（UI層）は TSC を入力として溶剤量を逆算するロジック、`compute_properties()`（計算層）は現在のPHR状態から TSC を算出するロジック。両者のTSCが一致するかどうかは「UIでTSC入力 → 溶剤PHRが更新 → compute_propertiesで再計算」の連鎖が正しく動作する前提。もし丸め誤差（10の倍数丸め）があると TSC 表示値が入力値とずれる可能性がある | Medium | 新システムでは TSC を Single Source of Truth として一元管理することを推奨。SP-004-context の business_rules.md に記載 |
| 2 | **入力バリデーション未実装**: Polymer PHR の合計が 0 の場合（スロットがすべて空）に `compute_properties` が空リストを返す（`None` 相当）。ユーザーへのエラー表示は `out_err` ウィジェットに任されているが、`compute_properties` 自体は `error` キーを返さない（`ui.py:666` の参照は空文字扱い）→ 計算失敗が無言で発生する可能性 | Low | 新システムでは計算失敗時の明示的エラー表示を設計に含める |

---

## コンテキスト回収

- [x] コンテキストにしか残っていない重要な情報がないか確認した

**追加メモ（コンテキストからの回収）:**
- `mol_calculator.py` の `calculate_descriptors_for_apply()` は物性値の計算源（SMILES → k, LogP, OP, MOP, Mw, vdw を返す）。このモジュールの詳細は SP-004-context で business_rules.md に記載する際に参照する
- `FPolymer` は Monomer と同じライブラリを参照するが ID プレフィックスは `F-*`（Monomer は `M-*`）。定義時は FPolymer カテゴリで登録されるが、シグネチャ内のモノマーは `Monomer` カテゴリに M-* として登録される（`ids.py` の FPolymer/Monomer 共有連番）

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| TSC 二重化の整合確認（BR-001 vs BR-010 の丸め誤差影響） | SP-004-context の business_rules.md に懸念点として明記 | Medium |
| `mol_calculator.py` の詳細確認（計算式・外部ライブラリ依存） | SP-004-context または SP-005（非機能要件）で追加確認 | Low |

---

## 完了時の確認

- [x] SP-004 の子チケット一覧の本チケットを「完了」に更新した
