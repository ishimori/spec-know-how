# SP-003-03: ビジネスロジックの在処確認

## このチケットの位置づけ

**全体目標**: このSPシリーズは [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) の Step 3（画面・UI を把握する）完了を目指す — 画面構成・遷移・操作フローを把握して後工程の仕様書作成の根拠とする

**マニュアル対応**: [manuals/01_仕様書作成マニュアル.md](../../manuals/01_仕様書作成マニュアル.md) — **Step 3「画面・UI を把握する」**（GUIDE_SPEC.md Step 3 セクション参照、気付き #7）

**目的**: submit/save 関数等の UI 層にビジネスロジック・バリデーション条件が埋まっていないかを確認し、その在処を記録する

**最終的な使われ方**: UI 層に発見したビジネスロジック・バリデーションは SP-004（業務ロジック抽出）で仕様化される。このチケットは「在処の確認と記録」のみを担う — **仕様化は SP-004 の責務**

> ⚠️ **このチケットの責務**: 「submit/save 関数にビジネスロジックが含まれているか」を確認し、**在処と概要を記録する**。詳細な仕様化（条件の網羅・整理）は SP-004 で行う。

**実行 Phase の判断**:

| Phase | 実行条件 |
|-------|---------|
| Phase 1 | 常に実行（submit/save 関数の確認） |

---

## Phase 1: submit/save 関数のビジネスロジック確認

- [x] 主要な submit/save 関数を特定した（SP-003-01 の画面一覧・API 対応表を参照）
- [x] 各 submit/save 関数にバリデーション・業務条件が含まれていないか確認した
- [x] ビジネスロジックが含まれる場合、その関数名・ファイルパス・概要を記録した
  - **詳細な仕様化は行わない（SP-004 へ委譲）**

### 調査記録（Phase 1）

#### 前提: Notebook の確認

`patent_support.ipynb` は 2 セルのみ。UI・業務ロジックは一切なし。
- セル 1: `from app_core import launch_app; app = launch_app("./")`
- セル 2: 空

すべての UI・ロジックは `app_core/ui.py` および `app_core/properties.py` に集約されている。

---

#### 主要な submit/save 関数の確認

| 画面名 | 関数名 | ファイルパス | ビジネスロジック有無 | 概要（在処のみ・仕様化は SP-004） | 信頼度 |
|-------|-------|-----------|-----------------|---------------------------|--------|
| Formulation > Resist | `App.save()` | `app_core/ui.py:940` | なし（データ収集・永続化のみ） | `_create_records_from_ui()` でUIの状態をレコードに変換し CSV 保存。計算・バリデーションなし | High |
| Formulation > Polymer/F-Polymer | `PolymericDefRowWidget.on_click_register()` | `app_core/ui.py:250` | **あり（軽微）** | `is_locked` フラグと `names` 非空チェックのみ。ロジック本体は `register_row()` に委譲 | High |
| Formulation > Polymer/F-Polymer | `PolymericDefBuilder.register_row()` | `app_core/ui.py:329` | **あり** | ①ポリマーシグネチャ生成（`polymer_signature(names, vals)`）②ID付与（`id_registry.assign()`）③各モノマーへのID付与（連番管理） | High |
| Formulation > Polymer | `PolymericDefBuilder.save_mw()` | `app_core/ui.py:343` | なし（差分追記のみ） | 登録済み行の Mw/Mw-Mn を `polymer_definitions.csv` に差分追記。業務判断なし | High |

---

#### UI 層に埋め込まれたビジネスロジック（submit 以外）

> ボタン操作ではなく observe/on_change で常時実行されているが、**業務上の計算ロジックが UI 層に直接実装されている**点で SP-004 仕様化対象。

| 画面名 | 関数名 | ファイルパス | 種別 | 概要 | 信頼度 |
|-------|-------|-----------|------|------|--------|
| Formulation > Resist（各行） | `ResistRowWidget._recalc_solvent()` | `app_core/ui.py:618` | 業務計算 | **溶剤 PHR 自動計算**: TSC% と固形分合計から総溶剤量を逆算し、各溶剤の比率（Rat 列）で配分。式: `total_sol = solid_mass × (100 - tsc) / tsc` | High |
| Formulation > Polymer（各行） | `_update_balance()` (クロージャ) | `app_core/ui.py:497` | 業務計算 | **ポリマー PHR 自動補完**: サブポリマー（スロット2・3）の PHR 合計を `polymer_total_phr` から引いて第1スロット（主成分）を自動決定。式: `rem = max(0, polymer_total_phr - sub_sum)` | High |
| Formulation > Resist（各行） | `ResistRowWidget.refresh_properties()` | `app_core/ui.py:638` | 物性計算の呼び出し | UI 状態を `compute_properties()`（`properties.py`）に渡して k/LogP/OP/TSC 等を取得・表示。計算ロジック自体は `properties.py` に分離済み | High |

---

#### 物性計算ロジックの在処（UI 層外）

> UI 層ではなく `properties.py` に分離されているが、SP-004 仕様化の主要対象。

| 関数名 | ファイルパス | 計算内容 |
|-------|-----------|---------|
| `compute_properties()` | `app_core/properties.py:146` | k（吸光係数）・LogP（疎水性）・OP/MOP（光学物性）・PDB/PAG モル比・TSC の計算。ポリマーをモノマーに分解してから重量加重平均・体積加重平均を計算 |
| `_resolve_composition()` | `app_core/properties.py:33` | UI状態（配合行）から全成分をフラットリストに展開。Polymer/FPolymer は定義から構成モノマーに分解し、mol比→重量比で PHR を配分 |

---

### SP-004 への引き継ぎリスト

| 関数名 | ファイルパス | 引き継ぎ内容（概要） |
|-------|-----------|-----------------|
| `ResistRowWidget._recalc_solvent()` | `ui.py:618` | Solvent PHR 自動計算ロジックの仕様化（TSC% 指定 → 各溶剤 PHR 配分） |
| `_update_balance()` | `ui.py:497` | Polymer PHR 補完ロジックの仕様化（主成分 = total_phr - サブ成分合計） |
| `compute_properties()` | `properties.py:146` | 全物性計算ロジックの仕様化（k/LogP/OP/MOP/PDB-PAG ratio/TSC） |
| `_resolve_composition()` | `properties.py:33` | ポリマー分解・重量比変換ロジックの仕様化 |
| `PolymericDefBuilder.register_row()` | `ui.py:329` | ID付与ロジック・シグネチャ生成ルールの仕様化 |

---

## DA 分析（このチケットのスコープ限定）

| # | 発見した問題・懸念 | 重要度 | 対応方針 |
|---|----------------|--------|---------|
| 1 | `_recalc_solvent()` と `refresh_properties()` は相互に呼び出す関係（`_recalc_solvent()` の末尾で `refresh_properties()` を呼ぶ）。無限ループに見えるが、`observe()` の `value` 変化がなければ再トリガーされない設計。ただし誤解を招きやすい | Medium | SP-004 でフロー図付きで仕様化する |
| 2 | `compute_properties()` の TSC 計算は **UI の `_recalc_solvent()` とは別の独立した計算**。UI で溶剤 PHR を自動計算した後、再度 `properties.py` 側で TSC を計算しており、入力値と表示値が同一になるか確認が必要 | Medium | SP-004 で突合確認する |

---

## コンテキスト回収

- [x] コンテキストにしか残っていない重要な情報がないか確認した

**回収した知見:**
- `properties.py` の PDB/PAG モル比計算は、化合物名の suffix（`_2pag`, `_1pdb` 等）からも PAG/PDB 係数を取得する命名規則依存のロジックが存在（`_SUFFIX_RE = re.compile(r'_(\d*)(pag|pdb)(?=[_\-\s]|$)')`）→ SP-004 で命名規則仕様として記録必要
- `_resolve_composition()` で Polymer PHR スケーリング（UI の PHR 合計を `polymer_total_phr` に正規化）が実施される → UI の PHR 入力値と実際の計算 PHR が異なる場合がある

---

## 発覚した追加タスク

| タスク内容 | 対応先 | 優先度 |
|----------|--------|--------|
| 化合物命名規則（`_2pag` 等の suffix）の仕様化 | SP-004 | High |
| `_recalc_solvent()` と `properties.py` TSC 計算の二重計算関係の整理 | SP-004 | Medium |
| Polymer PHR スケーリング（UI 入力値 vs 実計算値）の仕様化 | SP-004 | High |

---

## 完了時の確認

- [x] SP-003 の子チケット一覧の本チケットを「完了」に更新した
