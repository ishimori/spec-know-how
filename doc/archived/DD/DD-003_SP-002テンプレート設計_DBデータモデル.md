# DD-003: SP-002 テンプレート設計（DB・データモデル取得）

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-24 | 2026-02-27 | 完了 |

## 目的

SP-002（DB・データモデル取得）の親チケット・子チケット群テンプレートを設計・作成する。

## 背景・課題

`sample_prompts/02_DBデータモデル.md` は Gate 2 の DD 起票プロンプト形式で記述されている。
DD-002 で確立した SP 設計パターン（申し送り）に従い、SP-002 テンプレート群として再設計する。
SP-002 は SP-000 GroupC「DB あり」の場合のみ実行する条件付きフェーズであり、
実DB照合の可否（作業4）も実行時に判定する必要がある。

## 検討内容

`sample_prompts/02_DBデータモデル.md` の構成：
- 作業1: スキーマ取得（DDL/ERD/モデル定義）
- 作業2: テーブル詳細確認（論理削除・SP/View・マイグレ・インデックス）
- 作業3: マスタデータ確認（コード値・区分値テーブル）
- 作業4: 実DBアクセスによる照合（条件付き）
- テーブル数 30 以上で分割推奨

SP-002 子チケット分割案：
- SP-002-01: スキーマ取得 + テーブル詳細（作業1+2）→ 構造理解の担当
- SP-002-02: マスタデータ確認（作業3）→ 区分値・コード値の担当
- SP-002-03: 実DB照合（作業4）→ 条件付き、機械的検証の担当
- SP-002-context: DB仕様書ファイル構成の設計
- SP-002-gate: Gate 2チェック（6セクション構成）

## 決定事項

### 前提条件

- **SP-001 完了必須**（SP-001-01 で DB 有無を SP-000 から確認済みであるため）
- **SP-000 GroupC「DB あり」が前提**（「DB なし」なら SP-002 全体をスキップ）

### 子チケット分割設計

| チケット | 内容 | 実行条件 |
|---------|------|---------|
| SP-002-01 | スキーマ取得・テーブル詳細 | 常に実行 |
| SP-002-02 | マスタデータ確認 | 常に実行 |
| SP-002-03 | 実DB照合 | 実DBアクセス可能な場合のみ |
| SP-002-context | DB仕様書ファイル構成設計 | 常に実行（SP-002-01〜02完了後） |
| SP-002-gate | Gate 2チェック | 常に実行（最後に） |

### 動的追加の条件

- **テーブル数 30 以上**: SP-002-04 以降を動的追加（例: ドメイン別 / サブシステム別に分割）
- 判定タイミング: SP-002 親チケット #2（テーブル数概算計測）

### 実DB照合条件の扱い

- SP-000 に「実DBアクセス可否」の項目がない → SP-002 親チケット #3 でユーザーに確認
- アクセス不可の場合: SP-002-03 内で理由記録 + 後続フェーズで確認が必要な項目をリストアップ（別チケット不要）

### 成果物の登録

- DB仕様書ファイルを `CLAUDE.md` または `document_map.md` に追記
  → SP-002-01 の完了時チェックに含める

### GUIDE.md Step 2 との対応

完全対応（スキーマ取得・テーブル詳細・マスタデータ確認・実DB照合の全点が SP-002 の作業に対応）

## 成果物

| Phase | ファイル | 説明 |
|-------|---------|------|
| Phase 2 | [doc/SP/SP-002.md](doc/SP/SP-002.md) | SP-002 親チケットテンプレート |
| Phase 2 | [doc/SP/SP-002-01〜03.md, context, gate](doc/SP/) | SP-002 子チケット群 |
| Phase 3 | （本 DD 末尾の申し送りセクション） | SP-003〜007 設計基準 |

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各 Phase のタスク精査・詳細化**
- [x] `sample_prompts/02_DBデータモデル.md` を精読し SP 形式転換ポイントを整理した
- [x] DD-002 申し送りとの対応を確認した
- [x] 😈 **Devil's Advocate 調査**
  - DB なし・DUMP のみ・DDL のみ等、各ケースで正しく動くか？→ SP-000 GroupC で「DB なし」なら SP-002 全体スキップで対応
  - 実DBアクセス可否は SP-000 に含まれていないが問題ないか？→ SP-002 親チケット #3 で確認する設計で対応

### Phase 1: 設計
- [x] SP-002 の前提条件（SP-001 完了 + SP-000 GroupC）を定義した
- [x] 子チケット5種の分割設計を決定した
- [x] テーブル30以上での動的追加条件を定義した
- [x] SP-002-03 の実行条件（実DBアクセス可否）の扱いを設計した
- [x] GUIDE.md Step 2 との対応を確認した（完全対応）
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: 実装
- [x] SP-002.md（親チケット）を作成した
- [x] SP-002-01.md を作成した（スキーマ取得・テーブル詳細）
- [x] SP-002-02.md を作成した（マスタデータ確認）
- [x] SP-002-03.md を作成した（実DB照合）
- [x] SP-002-context.md を作成した
- [x] SP-002-gate.md を作成した
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 3: SP-002 設計パターンの SP-003 以降への申し送り
- [x] SP-002 設計で確立・更新したパターンを整理し、末尾「申し送り」に記録した

## ログ

### 2026-02-24
- DD 作成（DD-001 Phase 2 の切り出し・DD-002 申し送りに基づき起票）
- Phase 0 完了: `02_DBデータモデル.md` 精読、DD-002申し送り対応確認、DA批判レビュー実施
- Phase 1 完了: 前提条件・子チケット分割・動的追加条件・実DB照合条件を設計、GUIDE.md Step 2 対応確認
- Phase 2 完了: SP-002.md + 子チケット5ファイルを作成
- Phase 3 完了: 申し送りセクションを記録

---

## DA 批判レビュー記録

### Phase 0 DA 批判レビュー

**DA 観点:** SP 形式に転換する際に失われる情報・壊れる構造はないか？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | SP-000 に「実DBアクセス可否」がなく、SP-002-03 の実行判断ができない | Medium | 元の `02_DBデータモデル.md` の「実DBにアクセスできる場合」条件の判定材料がない | SP-002 親チケット #3 でユーザーに直接確認するステップを追加 |
| 2 | テーブル30以上で動的追加した場合、SP-002-context が全チケットを集約できるか不明 | Low | 動的追加チケット（SP-002-04〜）の存在を context が把握できるか | SP-002-context に「動的追加チケットを含む全子チケットを集約」と明記して対応 |

### Phase 1 DA 批判レビュー

**DA 観点:** 設計した子チケット構成で調査漏れが生じるケースはないか？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | SP-002-01 がスキーマ+テーブル詳細を担うため、テーブル数30以上のとき SP-002-01 自体が肥大化するリスク | Medium | 30テーブル分の記録が必要になった場合、SP-002-01 が実質分割相当の作業量になる | 親チケット #2 でテーブル数計測後、30以上なら SP-002-04 以降を追加する旨を SP-002-01 位置づけに明記 |

### Phase 2 DA 批判レビュー

**DA 観点:** 作成した SP-002 テンプレート群が実際のプロジェクトで機能するか？

| # | 発見した問題/改善点 | 重要度 | DA 観点 | 対応 |
|---|-------------------|--------|--------|------|
| 1 | SP-002-03（実DB照合）は scripts/analyze/ のスクリプトを前提とするが、SP-000 で作成されたか確認が必要 | Medium | DB照合スクリプトが存在しない場合、SP-002-03 の機械検証が実行できない | SP-002-03 Phase 1 冒頭に「scripts/analyze/ 存在確認」ステップを追加 |

---

## SP-002 設計パターン申し送り（DD-004〜007 向け）

> SP-003〜006 を設計する DD では、DD-002 申し送りに加えて以下のパターンを踏襲すること。
> SP-002 の設計過程で確立・追加した原則をまとめたもの。

### 追加1: 条件付きフェーズの設計パターン

SP-002 で確立した「SP 全体がスキップ対象になるケース」の処理パターン：

| 状況 | 設計方針 |
|------|---------|
| SP 全体がスキップ対象（例: DB なし） | 親チケット冒頭（#1）に「⚠️ 前提確認」を配置。条件不成立なら以降の作業を全スキップ |
| 子チケット内の特定 Phase のみスキップ | 子チケットの「位置づけ」セクション内「実行 Phase の判断」テーブルで明記 |
| SP-000 に判定材料がない場合 | 親チケットの該当 # に「ユーザーへの確認ステップ」を配置 |

### 追加2: 外部スクリプト依存の確認パターン

SP-002-03（実DB照合）で確立した「前提スクリプト存在確認」パターン：

- 機械処理チケットで外部スクリプト（`scripts/analyze/` 等）を使う場合、
  そのチケットの Phase 1 冒頭に「スクリプト存在確認」ステップを追加する
- スクリプトが存在しない場合の代替手順または「確認できない理由を記録」も明記する
