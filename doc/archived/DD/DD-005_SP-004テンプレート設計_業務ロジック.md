# DD-005: SP-004 テンプレート設計（業務ロジック）

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-24 | 2026-02-27 | 完了 |

## 目的

SP-004（業務ロジック）の親チケットテンプレートを設計・作成する。

## 背景・課題

既存の `sample_prompts/04_業務ロジック.md` は環境差異に対応できない。
また、業務ロジックは最も複雑で分割が難しいため、
環境に合わせた切り出し方を事前に決めることが重要。

GUIDE.md の教訓として「UI 層の submit/save 関数に埋まったバリデーション 12 条件が
丸ごと見落とされたケース」があり、SP-003 との連携も重要。

## 検討内容

`sample_prompts/04_業務ロジック.md` のポイント：
- 主要業務フロー、計算ロジック、バリデーションルール
- 状態遷移、外部システム連携の仕様書化
- 主要フロー5以上時に分割推奨（3〜4 DD）

SP-004 として再設計する際の論点：
- SP-003 で把握した UI 層ロジックを SP-004 に引き継ぐ連携方法
- 外部システム連携がある場合の追加タスク定義
- 信頼度ラベル（High/Medium/Low/Conflicting）の付与を明示的に要求するか

## 決定事項

- **子チケット構成**: SP-004-01（ロジック抽出）→ SP-004-02（フラグ/ステータス）→ SP-004-03（外部連携・条件付き）→ SP-004-context → SP-004-gate
- **信頼度ラベル**: 各子チケットの調査記録テーブルに列として統合（独立チケットにしない）
- **動的追加**: 主要フロー5以上 → SP-004-04〜（フロー別）、外部連携5件以上 → SP-004-03-xx（システム別）
- **SP-003スキップ時**: SP-004-01のフォールバック探索（バリデーター・サービス層等を独自洗い出し）を明示
- **状態遷移の分担**: SP-004-01は「ステータス値の一覧と業務的意味」のみ、書き込みパス詳細はSP-004-02に委譲

## Phase 0 調査記録

### SP形式への転換ポイント

既存 `sample_prompts/04_業務ロジック.md` はフラット構造（3〜4 DDに一括分割）。
SP形式では親チケット + 子チケット群に再設計する。

| 観点 | 既存プロンプト | SP-004 での設計方針 |
|------|-------------|-------------------|
| 前提確認 | なし | SP-003スキップ有無を確認し、UIなし時はフォールバックで独立探索 |
| スコープ計測 | 主要フロー5以上→DD分割を提案 | 5以上→SP-004-04〜を動的追加 |
| 子チケット構成 | 作業1〜3がフラット | 01（ロジック抽出）+ 02（フラグ/ステータス）+ 03（外部連携、条件付き）+ context + gate |
| 引き継ぎ機構 | なし | SP-003-03の引き継ぎリストをSP-004-01の起点に |
| 信頼度付与 | 作業3として独立 | 各子チケットの調査記録テーブルに信頼度列として統合 |

### DA 調査結果

**UI層引き継ぎが失敗するケース:**

| # | ケース | 問題 | 対策 |
|---|-------|------|------|
| 1 | SP-003をスキップした（UIなし） | 引き継ぎリストが存在しないのに SP-004 が参照しようとする | 前提確認で「SP-003スキップ済み」を確認し、フォールバック（独立探索）を明示 |
| 2 | SP-003-03の洗い出しが不完全 | 引き継ぎリストの見落としが SP-004 の見落としに連鎖 | SP-004-01で「submit/save以外にも業務条件がないか再確認」するステップを入れる |
| 3 | 引き継ぎリストが「概要のみ」 | 詳細が不足して SP-004 が抽出しきれない | SP-004-01の最初タスクを「引き継ぎリストの各行を詳細化する」にする |

**タスク爆発リスク:**

| # | ケース | 問題 | 対策 |
|---|-------|------|------|
| 1 | 外部API連携先が多い（目安5件以上） | SP-004-03 1チケットが巨大化 | システムごとに SP-004-03-xx を動的追加する条件を明示 |
| 2 | フロー分割と外部連携分割が重なる | チケット数が読めなくなる | フロー分割を優先し、各フロー内で外部連携を扱う設計にする |

## 成果物

| Phase | ファイル | 説明 |
|-------|---------|------|
| Phase 2 | [doc/SP/SP-004.md](doc/SP/SP-004.md) | SP-004 親チケットテンプレート |
| Phase 2 | [doc/SP/SP-004-01.md](doc/SP/SP-004-01.md) | 業務ロジック抽出（UI層引き継ぎ詳細化 + 追加探索） |
| Phase 2 | [doc/SP/SP-004-02.md](doc/SP/SP-004-02.md) | フラグ・ステータスのライフサイクル確認 |
| Phase 2 | [doc/SP/SP-004-03.md](doc/SP/SP-004-03.md) | 外部システム連携（条件付き） |
| Phase 2 | [doc/SP/SP-004-context.md](doc/SP/SP-004-context.md) | 業務ロジック仕様書ファイル構成設計 |
| Phase 2 | [doc/SP/SP-004-gate.md](doc/SP/SP-004-gate.md) | Gate 4 チェック |

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各 Phase のタスク精査・詳細化**
- [x] `sample_prompts/04_業務ロジック.md` を読んで SP 形式への転換ポイントを整理する
- [x] 😈 **Devil's Advocate 調査**
  - UI 層ロジックの引き継ぎが失敗するケースは？
  - 外部システム連携がある場合のタスク爆発リスクは？

### Phase 1: 設計
- [x] SP-004 の「環境確認フロー」を設計する（外部システム連携有無・主要フロー数）
- [x] SP-003 からの UI 層ロジック引き継ぎフローを定義する
- [x] 子チケット動的生成の条件・分割パターンを定義する（フロー数基準等）
- [x] 信頼度ラベル付与の指示をテンプレートに含めるか決める（各子チケットの調査記録テーブルに列として統合する方針に決定）
- [x] GUIDE.md Step 4 との対応を確認する
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: 実装
- [x] SP-004 テンプレートファイルを作成する（`doc/SP/SP-004.md`）
- [x] テンプレートで環境確認フロー・子チケット生成指示が機能するか確認する
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

## ログ

### 2026-02-24
- DD 作成（DD-001 Phase 2 の切り出し）

### 2026-02-27
- Phase 0 完了
  - `sample_prompts/04_業務ロジック.md` を読んで SP 形式への転換ポイントを整理
  - DA 調査実施（UI層引き継ぎ失敗ケース3件・タスク爆発リスク2件を発見）
  - 主要設計方針を確定：子チケット構成（01〜03 + context + gate）、フロー5以上で動的追加
- Phase 1・2 完了
  - SP-004.md、SP-004-01.md、SP-004-02.md、SP-004-03.md、SP-004-context.md、SP-004-gate.md を作成
  - DA発見：SP-004-01とSP-004-02の境界が曖昧 → SP-004-01に「値の一覧のみ・書き込みパスはSP-004-02に委譲」を明記して修正

---

## DA 批判レビュー記録

### Phase 1・2 DA 批判レビュー

**DA 観点:** 「このPhaseで何が壊れるか」— SP-004-01 と SP-004-02 の責務境界が実作業で曖昧になりロジックが漏れる

| # | 発見した問題/改善点 | 重要度 | 再現手順 | DA 観点 | 対応 |
|---|-------------------|--------|----------|--------|------|
| 1 | SP-004-01 Phase 2「状態遷移を概要のみ記録」の粒度が不明確。実作業で書き込みパス詳細まで記録してしまい SP-004-02 と重複・矛盾が発生する恐れ | 中 | 「遷移の概要のみ」という指示だけでは何を書くか判断できない | SP-004-01 と SP-004-02 の境界 | SP-004-01 の注記を「どのステータス値が存在するか（値の一覧と業務的意味）のみ記録し、書き込みパス・遷移条件詳細は SP-004-02 に委譲」と具体化した |
