# DD-009: SP 横断品質チェック（SP-004〜006）

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-27 | 2026-02-27 | 完了 |

## 目的

SP-004〜006（今セッションで新規作成した29ファイル）を5つの観点で横断的にチェックし、
個別設計では見えない問題（引き継ぎ漏れ・重複・スキップ条件の非対称性・構造の不統一・境界の曖昧さ）を発見・修正する。

## 背景・課題

DD-008（SP-000〜003 横断チェック）の申し送り（ルール1〜4）を受けて SP-004〜006 を設計したが、
設計時に申し送りルールを反映できていない箇所や、SP-004/005/006 間の新たな不整合が生じている可能性がある。
また、SP-001〜003 との整合性（命名・構造・フロー）の確認も必要。

## 対象ファイル

- `doc/SP/SP-004.md`（親）+ SP-004-01〜03, SP-004-context, SP-004-gate
- `doc/SP/SP-005.md`（親）+ SP-005-01〜04, SP-005-context, SP-005-gate
- `doc/SP/SP-006.md`（親）+ SP-006-01〜03, SP-006-gate

## 検討内容

DD-008 と同じ5観点で確認する：

| 観点 | 確認内容 |
|------|---------|
| 1 縦の情報フロー | SP-003→SP-004→SP-005→SP-006 の引き継ぎが繋がっているか |
| 2 横の責務分担 | SP-004/005/006 間で重複・空白がないか |
| 3 スキップ条件の対称性 | SP-000 回答・上流 SP スキップが下流に正しく伝わっているか |
| 4 構造統一性 | 親チケット・子チケット・Gate の形式が SP-001〜003 と揃っているか |
| 5 境界の明確性 | 隣接 SP 間の責務境界が両側から明示されているか |

## 決定事項

| # | 修正内容 | 対象ファイル | 優先度 |
|---|---------|------------|--------|
| 1 | SP-005 #1 に SP-004-context 成果物確認ステップを追加（DD-008 ルール1 遵守） | SP-005.md | Medium |
| 2 | SP-005-03・SP-005-04 のコンテキスト回収セクションに案内テキストを追加（他子チケットと統一） | SP-005-03.md, SP-005-04.md | Low |

## 成果物

| Phase | 内容 |
|-------|------|
| Phase 1 | 横断チェック記録（問題発見一覧）→ 下記「Phase 1: 横断チェック記録」参照 |
| Phase 2 | 修正した SP ファイル群（SP-005.md, SP-005-03.md, SP-005-04.md） |

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各 Phase のタスク精査・詳細化**
- [x] DD-008 の申し送りルール1〜4 を再確認した
- [x] 😈 **Devil's Advocate 調査**
  - 横断チェックが網羅的でなく重要な問題を見落とす可能性は？ → 観点を5つに絞り「実際に使う際に問題になるレベル」に限定。完全網羅より確実な修正を優先
  - 修正が多すぎてキリがなくなるリスクは？ → スタイルのみの差異は申し送り記録に留め、機能的な不整合を優先修正

### Phase 1: 横断チェック実施
- [x] 観点1〜5 の横断チェックを実施した（SP-004〜006 全ファイルを読む）
- [x] 発見した問題を記録した
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: 発見問題の修正
- [x] 優先度 High / Medium の問題を修正した
- [x] 修正内容を下の決定事項セクションに記録した
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

## ログ

### 2026-02-27
- DD 作成・Phase 0 完了
- Phase 1 横断チェック実施：5観点で SP-004〜006 全ファイルを確認
  - 問題1（Medium）発見：SP-005 #1 に SP-004-context 成果物確認がない（DD-008 ルール1 違反）
  - 問題2（Low）発見：SP-005-03・SP-005-04 のコンテキスト回収セクションに案内テキストがない
- Phase 2 修正実施：SP-005.md・SP-005-03.md・SP-005-04.md を修正

---

## DA 批判レビュー記録

### Phase 1・2 DA 批判レビュー

**DA 観点（Phase 1）:** 横断チェックの見落とし・修正スコープ膨張リスク
**DA 観点（Phase 2）:** 「修正が既存の動作を壊さないか」

| # | 発見した問題/改善点 | 重要度 | 再現手順 | DA 観点 | 対応 |
|---|-------------------|--------|----------|--------|------|
| 1 | SP-005 #1 に SP-004-context 成果物（業務ロジック仕様書ファイル）の確認ステップが存在しない。SP-004-context が未完了の場合に SP-005 を開始してもエラーが発生せず、仕様書なしで非機能要件チェックが進んでしまう | 中 | SP-004-context が未完了の状態で SP-005 を開始する | DD-008 ルール1（縦フロー）の遵守 | SP-005.md #1 に確認ステップを追加し、管理記録テーブルにも行を追加 |
| 2 | Phase 2 の修正で SP-005.md の管理記録テーブルに行を追加したが、#1 の箇条書きとテーブルの両方に反映が必要だった。片方だけ更新すると管理記録テーブルが古い状態のまま残り、参照整合性が崩れる | 低 | SP-005.md を参照してチケットを実行する際に、#1 の確認項目と管理記録テーブルの項目が一致していない場合 | 修正の一貫性確認 | 両方（#1 本文・管理記録テーブル）を同時に修正することで対応 |

---

## Phase 1: 横断チェック記録

### 観点1: 縦の情報フロー（SP-003→SP-004→SP-005→SP-006）

| チェック箇所 | 結果 | 備考 |
|------------|------|------|
| SP-003→SP-004: SP-003-03（画面フロー）引き継ぎ確認 | OK | SP-004 #1 で SP-003-03 引き継ぎリスト確認を明記 |
| SP-004→SP-005: SP-004-context 成果物確認 | **NG** | SP-005 #1 に SP-004-context ファイル確認ステップがない（問題1） |
| SP-005→SP-006: SP-005-gate 通過後に SP-006 開始 | OK | SP-006 #1 で SP-001〜005 全完了確認を一覧表で実施 |

### 観点2: 横の責務分担（SP-004/005/006 間の重複・空白）

| チェック箇所 | 結果 | 備考 |
|------------|------|------|
| 外部連携仕様の管轄 | OK | SP-004-03 が連携仕様を担当、SP-005-01/02 が認証・セキュリティ観点のみ追加確認 |
| 状態遷移の責務境界 | OK | SP-004-01 が値の一覧・業務的意味のみ、SP-004-02 が書き込みパス詳細 |
| 仕様書品質確認の管轄 | OK | SP-006-01 が SP-001〜005 の全仕様書を横断確認（重複なし） |

### 観点3: スキップ条件の対称性

| チェック箇所 | 結果 | 備考 |
|------------|------|------|
| SP-004-03 スキップ（外部連携なし） | OK | SP-004 #1 で外部連携有無を確認後、なければスキップを判断 |
| SP-005-01-xx 動的追加（認証方式複数混在） | OK | SP-005 #2 で判断条件を明記 |
| SP-006-02-xx 動的追加（仕様書10ファイル以上） | OK | SP-006 #3 で条件を明記 |

### 観点4: 構造統一性（SP-001〜003 との比較）

| チェック箇所 | 結果 | 備考 |
|------------|------|------|
| 子チケット：DA 分析セクション | OK | 全子チケットに統一形式で存在 |
| 子チケット：コンテキスト回収セクション | **部分的** | SP-005-03・SP-005-04 の案内テキストが欠落（問題2）|
| 子チケット：発覚した追加タスクセクション | OK | 全子チケットに存在 |
| Gate チケット：6フェーズ構成 | OK | SP-004〜006 の全 Gate が Phase 1〜6 で統一 |

### 観点5: 境界の明確性

| チェック箇所 | 結果 | 備考 |
|------------|------|------|
| SP-004-01 と SP-004-02 の境界 | OK | 「ステータス値の一覧と業務的意味のみ → SP-004-01、書き込みパス詳細 → SP-004-02」と明記 |
| SP-005-01 と SP-005-02 の境界 | OK | 認証・認可 vs セキュリティ（SQLi/XSS/CSRF 等）で明確に分離 |
| SP-005-03 と SP-005-04 の境界 | OK | ログ・監査・パフォーマンス vs 運用・保守で明確に分離 |

### 発見した問題一覧

| # | 問題 | 対象ファイル | 重要度 | 分類 |
|---|------|------------|--------|------|
| 1 | SP-005 #1 に SP-004-context 成果物（業務ロジック仕様書ファイル）の確認ステップがない（DD-008 ルール1 違反） | SP-005.md | Medium | 観点1 縦フロー |
| 2 | SP-005-03・SP-005-04 のコンテキスト回収セクションに案内テキストがない（他子チケットと不統一） | SP-005-03.md, SP-005-04.md | Low | 観点4 構造統一 |
