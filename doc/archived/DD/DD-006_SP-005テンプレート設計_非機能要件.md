# DD-006: SP-005 テンプレート設計（非機能要件）

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-24 | 2026-02-27 | 完了 |

## 目的

SP-005（非機能要件）の親チケットテンプレートを設計・作成する。

## 背景・課題

既存の `sample_prompts/05_非機能要件.md` は環境差異に対応できない。
認証方式・外部サービス連携の有無によって確認すべき内容が大きく変わるが、
環境を問わず同じチェックリストを実行しようとする問題がある。

GUIDE.md の教訓：「個別の機能 DD を追うと非機能要件が抜ける。
NFR は独立したトラックとして扱い、意識的に確認しないと漏れる。」

## 検討内容

`sample_prompts/05_非機能要件.md` のポイント：
- 認証・認可・セキュリティ確認（SQLi/XSS/CSRF 対策）
- 複数認証方式または外部サービス連携5以上時に分割推奨（2〜3 DD）

SP-005 として再設計する際の論点：
- SP-000 の環境プロファイルで「認証方式」「外部サービス数」を収集しておき、
  SP-005 がそれを参照して確認範囲を絞る
- セキュリティ要件は「ある場合」で流さず、具体的なコード確認まで求めるか

## 決定事項

- **子チケット構成**: SP-005-01（認証・認可）→ SP-005-02（セキュリティ）→ SP-005-03（ログ・パフォーマンス）→ SP-005-04（運用・保守）→ SP-005-context → SP-005-gate
- **SP-000 GroupE 参照**: 認証方式（Q13）・外部連携数（Q11〜12）を親チケットで読んで動的追加判断
- **認可の3層確認**: 画面・操作・データレベルを SP-005-01 に明示（データレベル漏れ防止）
- **セキュリティ確認はコード根拠必須**: 「確認した」のみの記録禁止。ファイルパス:行番号を必須フィールドに
- **動的追加**: 認証方式複数混在 → SP-005-01-xx 分割（外部連携5以上はSP-004-03参照でSP-005側の分割は不要）
- **SP-000 追加質問は不要**: GroupE の Q11〜Q13 で SP-005 に必要な情報は収集済み

## 成果物

| Phase | ファイル | 説明 |
|-------|---------|------|
| Phase 2 | [doc/SP/SP-005.md](doc/SP/SP-005.md) | SP-005 親チケットテンプレート |
| Phase 2 | [doc/SP/SP-005-01.md](doc/SP/SP-005-01.md) | 認証・認可（3層確認） |
| Phase 2 | [doc/SP/SP-005-02.md](doc/SP/SP-005-02.md) | セキュリティ（コード根拠必須） |
| Phase 2 | [doc/SP/SP-005-03.md](doc/SP/SP-005-03.md) | ログ・監査・パフォーマンス |
| Phase 2 | [doc/SP/SP-005-04.md](doc/SP/SP-005-04.md) | 運用・保守 |
| Phase 2 | [doc/SP/SP-005-context.md](doc/SP/SP-005-context.md) | NFR 仕様書ファイル構成設計 |
| Phase 2 | [doc/SP/SP-005-gate.md](doc/SP/SP-005-gate.md) | Gate 5 チェック |

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各 Phase のタスク精査・詳細化**
- [x] `sample_prompts/05_非機能要件.md` を読んで SP 形式への転換ポイントを整理する
- [x] 😈 **Devil's Advocate 調査**
  - SP-000 で収集すべき NFR 関連の質問項目は十分か？
  - 「認可はデータレベルも確認したか？」という観点を漏らさない仕組みは？

### Phase 1: 設計
- [x] SP-005 の「環境確認フロー」を設計する（認証方式・外部サービス数・セキュリティ要件）
- [x] SP-000 で収集すべき NFR 関連質問を洗い出し、SP-000 テンプレートへの反映を依頼する（→ GroupE Q11〜Q13 で十分、追加不要と判断）
- [x] 子チケット動的生成の条件・分割パターンを定義する
- [x] GUIDE.md Step 5 との対応を確認する
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

### Phase 2: 実装
- [x] SP-005 テンプレートファイルを作成する（`doc/SP/SP-005.md`）
- [x] テンプレートで環境確認フロー・子チケット生成指示が機能するか確認する
- [x] 😈 **DA 批判レビュー（「このPhaseで何が壊れるか」を最低1件発見）**

## ログ

### 2026-02-24
- DD 作成（DD-001 Phase 2 の切り出し）

### 2026-02-27
- Phase 0〜2 完了
  - `sample_prompts/05_非機能要件.md` を読んで SP 形式への転換ポイントを整理
  - DA 調査: 認可データレベル漏れ・セキュリティ確認のコード根拠欠如の2件を発見
  - SP-000 GroupE（Q11〜Q13）で必要情報は収集済みと判断（追加質問不要）
  - SP-005.md、SP-005-01〜04.md、SP-005-context.md、SP-005-gate.md を作成
  - DA発見を実装に反映: SP-005-01に認可3層確認・SP-005-02にコード根拠必須を明記

---

## DA 批判レビュー記録

### Phase 0 DA 調査 / Phase 1・2 DA 批判レビュー

**DA 観点（Phase 0）:** SP-000 で収集すべき NFR 関連の質問は十分か・認可のデータレベルを漏らさない仕組みは？
**DA 観点（Phase 1・2）:** 「このPhaseで何が壊れるか」— 設計・実装したテンプレートで何が抜けるか

| # | 発見した問題/改善点 | 重要度 | 再現手順 | DA 観点 | 対応 |
|---|-------------------|--------|----------|--------|------|
| 1 | 認可確認が画面レベルで止まり、データレベル（所属データのみアクセス可等）が未確認になる | 高 | SP-003-02 の認可マトリクスを「確認済み」として SP-005 で認可をスキップする場合 | 認可はデータレベルも確認したか？ | SP-005-01 に「認可の3層確認（画面・操作・データ）」を明示。SP-003-02 確認済みの場合もデータレベルは追加確認必須と明記 |
| 2 | セキュリティ確認が「フレームワークが処理しているはず」という推測で完了し、実際のコード確認が行われない | 高 | SP-005-02 の「確認した」チェックボックスだけを埋める場合 | 「ある場合」で流していないか？ | SP-005-02 の各確認項目でコード根拠（ファイルパス:行番号）を必須フィールドに設定。推測での記入を明示禁止 |
