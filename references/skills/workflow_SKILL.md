---
name: workflow
description: 9ステップ開発フロー・Phase管理・DA批判レビュー（オプショナル）
---

# 開発ワークフロー

DDを使った開発作業のフロー管理スキルです。
**このスキルはオプショナル**です。必要に応じて呼び出してください。

## 呼び出し例

- 「9ステップで進めて」「ワークフローに従って」
- 「Phase 1を始めて」「次のPhaseへ」
- 「DA批判レビューして」「Phase完了」
- 「現在のステータスは？」

---

## 9ステップ開発フロー

```
Step 1: DD作成          「〇〇機能を作りたい」
Step 2: 仕様確認        ユーザー承認を得る
Step 3: 実装前チェック  仕様書・既存コードを確認
Step 4: コーディング    規約に従って実装
Step 5: テスト作成      必要に応じてテスト作成
Step 6: コード検証      Lint + セルフチェック
Step 7: レビュー        コードレビュー
Step 8: 仕様書同期      DDの変更を doc/spec に反映
Step 9: コミット        git commit → /dd archive
```

### 進捗表示フォーマット

各ステップ開始時に表示：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 Step N/9: ステップ名
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 1. DD作成       ✅ 2. 仕様確認     ✅ 3. 実装前チェック
▶️ 4. コーディング  ⬜ 5. テスト作成   ⬜ 6. コード検証
⬜ 7. レビュー      ⬜ 8. 仕様書同期   ⬜ 9. コミット
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 対象DD: DD-XXX_機能名
```

---

## Phase 0: 事前精査（CRITICAL）

**DD作成後、実装前に必ず実施。**

### 目的

タスクが粗い粒度で書かれていることがある。実装前に精査：

1. **タスクの詳細化**: 曖昧なタスクがないか
2. **タスクの分解**: 大きすぎるタスクは2〜3個に
3. **不足タスクの追加**: 動作確認・ドキュメント更新など

### チェックリスト

| 項目 | 観点 |
|------|------|
| タスク粒度 | 1〜2時間で完了する粒度か |
| 具体性 | 何をすればよいか明確か |
| 順序 | 依存関係は明確か |
| 網羅性 | 必要なタスクがすべてあるか |

### 記録

```markdown
### YYYY-MM-DD
- Phase 0 完了
  - Phase 1: タスクを3個に分解
  - Phase 2: ファイル名を追記
```

---

## Phase完了時のDA批判レビュー（CRITICAL）

**各Phaseを完了とする前に必ず実行。**

### ⚠️ 重要: DA批判レビュー（Devil's Advocate視点）

**「確認したか？」ではなく「どこが壊れるか？」を問う。**

LLMは楽観バイアスで「問題なし」と言いがち。以下のDA手順で批判的視点を強制する:

1. **壊れる前提で探す**: 「完了した」ではなく「このPhaseの変更で何が壊れるか」と問う
2. **暗黙の前提を疑う**: 「今動いている」ではなく「前提が崩れるケースは？」と深掘りする
3. **将来の破壊を予測する**: 「今は問題ない」ではなく「半年後の変更で壊れないか？」と問う
4. **発見を記録**: 見つけた問題を必ず記録（何も見つからないのは疑わしい）

**DA観点チェックリスト（毎回確認）:**
- 矛盾・不整合はないか
- 暗黙の前提条件が崩れるケースはないか
- エッジケース・境界条件の漏れはないか
- 「正常系しか考えていない」箇所はないか
- 依存関係の見落としはないか
- 将来の変更で壊れやすい設計はないか

### DA品質フィルター（ノイズ削減）

DAレビューの精度を維持するため、以下のフィルターを適用する:

**1. 検証義務**: 指摘前にコード実行 or 仕様確認で事実を確認すること。
「〜かもしれない」だけの推測指摘は記録しない。
- ❌「この変数は falsy になる可能性がある」（未検証）
- ⭕「L42 で `parseInt(value)` に空文字を渡すと NaN になる。実際に input を空にして確認済み」

**2. 既知事項の除外**: 以下は指摘対象外とする。
- コード内の `TODO` / `FIXME` コメントで明示されている事項
- DD の「Phase X で対応」と記載されている事項
- 別 DD にスコープアウト済みの事項

**3. 深刻度の判定基準**:

| 深刻度 | 判定基準 | 例 |
|--------|---------|-----|
| 高 | 今のPhaseでテストが落ちる or ユーザー操作で壊れる | 関数の戻り値型が変わり呼び出し元でエラー |
| 中 | 特定条件下で壊れる（エッジケース・将来の変更時） | 空配列時にundefined参照、半年後のリファクタで破壊 |
| 低 | 壊れないが改善の余地がある | 命名の不統一、DRY違反、ドキュメント不足 |

**4. 再現手順の必須化**: 深刻度「高」「中」には以下を必ず記載:
- **操作**: 何をすると（例: servingsB に 0 を入力して送信）
- **結果**: 何が起きるか（例: cuisineBPanel が非表示にならない）

### 最低発見数ルール

| 変更規模 | 最低発見数 |
|---------|-----------|
| 小（1-2ファイル） | 1件以上 |
| 中（3-5ファイル） | 2件以上 |
| 大（6ファイル以上） | 3件以上 |

**発見数が最低ラインに満たない場合**: 変更ファイルを全行読み直してから再チェック

### 🔄 再チェック発動条件（どちらかを満たせば発動）

#### 条件A: 中レベル以上の発見がある場合（CRITICAL）

**重要度「中」または「高」が1件以上 → 🔄 別角度で再チェック必須**

- 中レベル以上 ＝ 設計判断の甘さや構造的な問題を示唆
- 同種の問題がまだ潜んでいる可能性が高い
- 「1件見つかったなら、似た問題がもう1件あるはず」の姿勢で探す

#### 条件B: 多数発見の場合

| 変更規模 | 発見数 | 追加アクション |
|---------|--------|--------------|
| 小（1-2ファイル） | 3件以上 | 🔄 別角度で再チェック必須 |
| 中（3-5ファイル） | 5件以上 | 🔄 別角度で再チェック必須 |
| 大（6ファイル以上） | 7件以上 | 🔄 別角度で再チェック必須 |

**🔄 別角度での再チェック方法:**

1. **視点を変える**: 実装者視点 → レビュアー視点 → ユーザー視点 → 将来の保守者視点
2. **チェック観点を変える**:
   - 1回目: 機能・ロジックの正しさ
   - 2回目: テストカバレッジ・境界値
   - 3回目: ドキュメント・仕様書との整合性
3. **関連ファイルを広げる**: 直接変更したファイル → importしているファイル → 同じディレクトリの関連ファイル

**記録例（中レベル発見 → 再チェック）:**
```markdown
### Phase N DA批判レビュー（2回目: 別角度チェック）

**発動理由:** 1回目で重要度「中」を2件発見
**切り替えた視点:** 実装者 → レビュアー（コードの一貫性・DRY原則）

**追加発見:**
| # | 発見した問題 | 視点 | 対応 |
|---|------------|------|------|
| 4 | 同じ定数が別ファイルにもある（DRY違反） | レビュアー | ⏭️別DD |
| 5 | READMEの使用例が古い | ユーザー | ✅修正済 |
```

### DA批判レビューチェックリスト（Phase種別ごと）

**【実装Phase】**
| チェック項目 | 具体的なアクション |
|-------------|-------------------|
| 関数網羅性 | 変更したファイルの全public関数をリストアップし、各関数がテストされているか確認 |
| 呼び出し元 | 変更した関数名でgrep。呼び出し元すべてに影響がないか確認 |
| エッジケース | null, 空配列, 0, 負値, 境界値を渡した場合の動作を確認 |
| 定数・マップ | 新規追加した定数/マップに漏れがないか（全パターン列挙して突合） |

**【テストPhase】**
| チェック項目 | 具体的なアクション |
|-------------|-------------------|
| 関数カバレッジ | 変更ファイルのexport一覧とテストファイルのdescribe一覧を突合 |
| 新規関数 | 今回追加した関数すべてにテストがあるか確認 |
| 異常系 | エラーケース・例外のテストを追加したか確認 |

**【ドキュメントPhase】**
| チェック項目 | 具体的なアクション |
|-------------|-------------------|
| 仕様書同期 | 変更したコードに対応する仕様書セクションを特定し、更新したか確認 |
| サンプル値 | ドキュメント内の例示値がコードと一致しているか確認 |

### 記録手順（必須: 発見形式）

**Step 1**: DDの「DA批判レビュー記録」セクションに**発見した問題**を記録

```markdown
### Phase N DA批判レビュー

**DA観点:** （このPhaseで最も壊れやすいポイントは何か？）

| # | 発見した問題/改善点 | 重要度 | 再現手順（高/中は必須） | DA観点 | 対応 |
|---|-------------------|--------|----------------------|--------|------|
| 1 | checker.test.jsにpasta/noodleテストがない | 高 | テスト実行→pastaケースが未検証 | エッジケース漏れ | ✅ 追加済 |
| 2 | validator.jsのパスタコード変更がpromptBuilder側に未反映 | 中 | パスタ選択→旧コードで生成 | 依存関係の見落とし | ✅ 修正済 |
| 3 | 仕様書11bの計算例が古い値のまま | 低 | - | 将来の保守性 | ⏭️ 別DD |

⚠️ 重要度「中」以上あり → 🔄 別角度で再チェック必須

**発見ゼロの場合（疑わしい）:**
以下を実施してから再チェック:
1. 変更ファイルを全行読み直す（Read tool使用）
2. 変更した関数名でgrepして呼び出し元を確認
3. テストカバレッジレポートを確認
```

**Step 2**: タスク一覧の「😈 DA批判レビュー」を完了に

**Step 3**: ログに完了を記録

### よくある見落としパターン

| パターン | 例 |
|---------|-----|
| テスト漏れ | 新規関数を追加したがテストを書いていない |
| 呼び出し元未確認 | 関数の戻り値を変更したが呼び出し元を確認していない |
| 定数マップ不完全 | 6種類あるはずが5種類しかマップに登録していない |
| 仕様書未更新 | コードは直したが仕様書に反映していない |
| export漏れ | 新関数を追加したがexportしていない（テスト不可） |

---

## Phase完了時のレビュー

Phase内容に応じたエージェントでレビュー：

| Phase内容 | エージェント |
|-----------|-------------|
| コード実装 | `code-reviewer` |
| 認証・API・決済 | `security-reviewer` |
| 設計 | `architect` |
| DB設計 | `database-reviewer` |

### 記録

```
- Phase N 完了レビュー（code-reviewer）: ✅ 問題なし
```

---

## 仕様書同期チェック

`/dd archive` 実行前に確認。

### スキップ条件

以下に該当する Phase は Step 8（仕様書同期）をスキップしてよい:

- **インフラ変更のみ**: Docker, CI/CD, デプロイ設定, 開発環境構築
- **UI/UX の PoC・プロトタイプ**: 仕様が確定していない探索的な実装
- **バグ修正**: 既存仕様の範囲内での修正（仕様自体は変わらない）
- **リファクタリング**: 振る舞いを変えないコード改善

**Step 8 が必要な Phase:**
- 業務ロジックの実装・変更（`doc/spec/business-logic/` の仕様書と突合）
- DB スキーマの変更（`doc/spec/database/` と突合）
- 画面仕様の確定（仕様書がある場合）

### チェック対象

| 変更種別 | 関連仕様書 |
|----------|-----------|
| 業務ロジック実装・変更 | `doc/spec/business-logic/` |
| テーブル・カラム変更 | `doc/spec/database/` |
| 画面の追加・変更 | `doc/spec/03_画面仕様/`（存在する場合） |
| 機能の追加・変更 | `doc/spec/02_機能一覧.md`（存在する場合） |

### 出力フォーマット

```markdown
## 仕様書同期チェック結果

| 変更内容 | 関連仕様書 | 反映状況 |
|----------|-----------|----------|
| ログイン画面を追加 | 03_画面仕様/login.md | ✅ 反映済 |
| usersテーブルにカラム追加 | 04_テーブル定義.md | ⚠️ 要確認 |
```

⚠️ がある場合は、仕様書を更新してからアーカイブ。

---

## 関連

- `/dd` - DD操作（作成、参照、一覧、アーカイブ）
- `doc/development-flow-full.md` - フロー詳細
