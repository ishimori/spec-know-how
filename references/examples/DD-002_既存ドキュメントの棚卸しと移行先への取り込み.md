# DD-002: 既存ドキュメントの棚卸しと移行先への取り込み

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-13 | 2026-02-13 | 完了 |

## 目的

移行元プロジェクト（`C:\repo\housing-e-kintai`）に存在する既存ドキュメント群を評価・整理し、移行先プロジェクト（`C:\repo\housing-e-kintai-next`）の `doc/catalog/` に**信頼度ラベル付き**で取り込む。これにより、移行計画策定と仕様書作成のための基盤を確立する。

## 背景・課題

### 発端

移行先プロジェクトで「まず画面一覧を作ろう」と計画したところ、移行元に**既に充実した仕様書群が存在する**ことが判明した。

### 既存ドキュメントの所在

| 場所 | 内容 | ファイル数 |
|------|------|-----------|
| `doc/spec/screens/` | 画面一覧 + 個別画面仕様書 | 50+ファイル |
| `doc/spec/database/` | テーブル・ビュー定義書 | 3ファイル |
| `doc/spec/` | アーキテクチャ、用語集 等 | 5ファイル |
| `doc/old/docs_analysis/` | システム概要〜デプロイ設計（7文書） | 7ファイル |
| `doc/DD/DD-002/` | テスト品質分析 | 3ファイル |
| `doc/DD/DD-003/` | コーディング規約（12分割） | 13ファイル |

### 課題

1. **これらはLLMが生成したもの**であり、80-89%は正確だが残りに「あるべき姿」が紛れ込んでいる
2. **信頼度にバラツキがある**（画面仕様89% vs DB制約40%）
3. そのまま鵜呑みにすると、ハルシネーションの連鎖リスクがある
4. 一方でゼロから作り直すのは非効率

### 方針

**「検証付きで取り込む」** — 既存ドキュメントを移行先にコピーし、信頼度評価を付記する。信頼度の低い部分は `/verify` やDDLとの突き合わせで段階的に補強する。

## 検討内容

### 信頼度評価結果（DD-002作成前の調査）

| 領域 | 信頼度 | 判定 | 根拠 |
|------|--------|------|------|
| 画面一覧（59画面） | 95% | ✅ そのまま使える | menu_def.yamlと一致、検証スクリプト付き |
| 個別画面仕様書 | 89% | ⚠️ ほぼ使える | 実コードのセッションキー・関数名と一致。計算ロジック部分は要検証 |
| テーブル一覧（37テーブル） | 95% | ✅ 名前・分類は使える | DDLと一致 |
| テーブルカラム定義 | 65% | ⚠️ 検証必須 | payslip系2テーブル未記載、監査カラム不統一、インデックス定義ゼロ |
| ビュー定義 | 90% | ✅ ほぼ使える | DDLと一致 |
| セキュリティ設計 | 80% | ⚠️ 選別必要 | 「推奨事項」が「現状」として書かれている部分あり |
| アーキテクチャ | 80% | ⚠️ 選別必要 | 70%コード由来、30%あるべき姿 |
| API設計 | 80% | ⚠️ 選別必要 | メソッド一覧は正確、実装vs計画の判別が必要 |
| 画面遷移図 | 70% | ⚠️ 簡易版のみ | 大枠は存在するが詳細パス・例外パスなし |
| 業務フロー | 75% | ⚠️ 部分的 | 承認ワークフローのみ。計算ロジックなし |

### 取り込み方針

| 信頼度 | ラベル | 扱い |
|--------|--------|------|
| 90%以上 | `[VERIFIED]` | そのまま参照可。ただし実装時に `/verify` で最終確認 |
| 70-89% | `[DRAFT]` | 参考にはなるが、実装前に必ず検証が必要 |
| 70%未満 | `[UNVERIFIED]` | 構造・目次としてのみ利用。内容は信用しない |

### 移行先での配置構造

```
doc/catalog/
├── README.md                    # カタログ全体の説明・信頼度凡例
├── screens/
│   ├── index.md                 # [VERIFIED] 画面一覧（59画面）
│   └── (個別画面仕様は Phase 2 以降で必要に応じて取り込み)
├── database/
│   ├── index.md                 # [VERIFIED] テーブル・ビュー一覧
│   ├── tables.md                # [UNVERIFIED] カラム定義（要DDL突き合わせ）
│   └── views.md                 # [DRAFT] ビュー定義
├── security.md                  # [DRAFT] セキュリティ設計
├── architecture.md              # [DRAFT] アーキテクチャ概要
├── system_overview.md           # [DRAFT] システム概要
└── glossary.md                  # [DRAFT] 用語集
```

## 決定事項

1. 既存ドキュメントを移行先の `doc/catalog/` に取り込む（コピーではなく、整理・信頼度ラベル付きで再構成）
2. 信頼度ラベル `[VERIFIED]` / `[DRAFT]` / `[UNVERIFIED]` を各文書の冒頭に付与
3. Phase 1 では**全体俯瞰に必要な文書のみ**取り込む（個別画面仕様50+ファイルは取り込まない）
4. DB定義の検証は `/verify sql` + DDL直接参照で行う（Phase 2）
5. 画面遷移図・業務フローは既存の簡易版を取り込み、不足分は別DDで対応

## タスク一覧

### Phase 0: 事前精査
- [x] 📋 **各Phaseのタスク精査・詳細化**
  - 移行元ドキュメントの最終確認（抜け漏れチェック）
  - Phase 1 で取り込むファイルの最終リスト確定
- [x] 😈 **Devil's Advocate調査** → DA批判レビュー記録に記載

### Phase 1: カタログ基盤の構築
- [x] `doc/catalog/README.md` 作成（信頼度凡例、利用ガイド）
- [x] 画面一覧の取り込み（`screens/index.md` — [VERIFIED]）
- [x] DB一覧の取り込み（`database/index.md` — [VERIFIED]、`tables.md` — [UNVERIFIED]、`views.md` — [DRAFT]）
- [x] セキュリティ設計の取り込み（`security.md` — [DRAFT]）
- [x] システム概要の取り込み（`system_overview.md` — [DRAFT]）
- [x] アーキテクチャの取り込み（`architecture.md` — [DRAFT]）
- [x] 用語集の取り込み（`glossary.md` — [DRAFT]）
- [x] 😈 **DA批判レビュー** → DA批判レビュー記録に記載

### Phase 2: DB定義の検証・補強
- [x] DDL（`docker_postgres/init/02_create_table.sql`）と `tables.md` の突き合わせ
- [x] 不足テーブル（payslip_header, payslip）の追記
- [x] 新規発見: `commission_adjustment` テーブルの追記（tables.mdに完全欠落していた）
- [x] インデックス定義の追記（10件）
- [x] 制約（UNIQUE 13件, FK/CASCADE 12件, 複合PK 1件）の追記
- [x] 監査カラム（created_at/by, updated_at/by）の型不統一を記録
- [x] salesテーブルの不足カラム（confirm_by, confirm_at）を追記
- [ ] `/verify sql` で移行元コードのSQL利用パターンとの整合確認（→ 別DDで実施）
- [x] `tables.md` のラベルを [UNVERIFIED] → [VERIFIED] に昇格
- [x] 😈 **DA批判レビュー** → DA批判レビュー記録に記載

### Phase 3: 不足ドキュメントの特定と次DD計画
- [x] カタログ全体を俯瞰し「移行計画策定に足りないもの」をリストアップ（下記参照）
- [x] 画面遷移図の詳細化が必要か判断 → **必要**（現在は簡易版のみ）
- [x] 業務フロー図の作成が必要か判断 → **必要**（承認WFのみ。計算ロジックなし）
- [x] 次のDD（DD-003以降）の方向性を決定（下記参照）
- [x] 😈 **DA批判レビュー** → DA批判レビュー記録に記載

## ログ

### 2026-02-13
- DD作成
- 背景: 移行元に既存ドキュメント群が存在することが判明。ゼロから作るのではなく、検証付きで取り込む方針を決定
- 信頼度評価を実施済み（画面仕様89%、DB定義65-75%、セキュリティ80%、アーキテクチャ80%）
- **Phase 0 完了**: 移行元ドキュメント8種を精査、取り込みリスト確定
- **Phase 1 完了**: カタログ8ファイルを `doc/catalog/` に作成（各ファイルに信頼度ラベル・元ファイル・要注意箇所を付記）
  - `README.md`, `screens/index.md`, `database/index.md`, `database/tables.md`, `database/views.md`, `security.md`, `system_overview.md`, `architecture.md`, `glossary.md`
- **Phase 0+1 DA批判レビュー完了**: 2件発見（下記記録参照）
- **Phase 2 完了**: DDLとtables.mdの突き合わせ実施
  - `commission_adjustment` テーブル（30+カラム）がtables.mdに完全欠落 → 追記
  - `payslip_header`（51カラム）, `payslip`（53カラム）の定義を追記
  - インデックス10件、UNIQUE制約13件、FK/CASCADE 12件、複合PK 1件を追記
  - sales テーブルの不足カラム（confirm_by, confirm_at）を追記
  - 監査カラムの型不統一（INTEGER vs VARCHAR）を記録
  - ラベル: [UNVERIFIED] 65% → [VERIFIED] 95% に昇格
- **Phase 2 DA批判レビュー完了**: 2件発見（DA-004, DA-005）
- **Phase 3 完了**: 不足ドキュメント分析・次DD計画策定

### Phase 3 分析結果: 移行計画策定に不足しているもの

| 不足ドキュメント | 重要度 | 理由 | 対応方針 |
|----------------|--------|------|---------|
| 画面遷移図（詳細版） | 中 | 現在は大枠のみ。例外パス・エラー遷移なし | 個別画面仕様書の取り込み時に段階的作成 |
| 業務フロー図（計算ロジック） | 高 | 承認WFのみ。歩合計算・残業計算のフローなし | 別DD（DD-003候補）で作成 |
| API設計書 | 中 | 移行元にはメソッド一覧が存在するが取り込んでいない | 新システムはFastAPIなので新規設計が必要 |
| データ移行計画 | 高 | 既存DB→新DBのマッピング・変換ルールが未定 | 別DD（DD-004候補）で作成 |
| 個別画面仕様書（50+） | 低〜中 | Phase 1で意図的に除外。必要時に移行元から直接参照 | 実装フェーズで必要な画面から順次取り込み |
| テスト仕様書 | 中 | 移行元にテスト品質分析（DD-002/）があるが未取り込み | 実装後のテスト工程で参照 |

### 次DD（DD-003以降）の方向性

| DD番号 | タイトル案 | 目的 | 依存 |
|--------|-----------|------|------|
| DD-003 | 業務ロジックの仕様抽出 | 歩合計算・残業計算・承認WFのロジックを仕様書化 | DD-002（カタログ） |
| DD-004 | 新システムDB設計 | PostgreSQL→PostgreSQL移行のスキーマ設計・型統一 | DD-002（テーブル定義） |
| DD-005 | 新システムアーキテクチャ設計 | React+FastAPIのレイヤー設計・認証方式決定 | DD-002（現行設計理解） |

---

## DA批判レビュー記録

<!-- DA批判レビューの手順・品質フィルター・再チェック条件は workflow/SKILL.md を参照 -->

### Phase 0: アプローチ全体への批判

**DA-001: database/index.md と tables.md のテーブル分類・名前が不一致**

- **問題**: index.md（元は概念レベルのER図ベース）と tables.md（DDL由来）でテーブルの分類・命名が異なる。例えば index.md は「歩合系」を `commission_header`, `commission_detail`, `emp_commission_summary` と記載するが、DDLの実テーブルは `commission_sheet`, `commission_point`, `commission_payment` 等。index.md の一部は「あるべき姿」のテーブル名が混入している
- **影響**: 将来、開発者がindex.mdのテーブル名を信じてコードを書くと、実テーブル名と合わず混乱する
- **対策**: Phase 2のDDL突き合わせ完了後に index.md のテーブル一覧もDDLベースに修正する。カタログの index.md には「tables.md が正（DDL由来）」と注記済み

**DA-002: 信頼度ラベルが「LLMの自己評価」に依存している**

- **問題**: 信頼度の数値（95%, 80%等）はDD-002作成時の定性的な推定であり、機械的に検証されたものではない。[VERIFIED]と書いてあるが、実際にはmenu_def.yamlとの突き合わせは目視レベル
- **影響**: [VERIFIED]ラベルを見て「検証済みだから安全」と過信するリスク
- **対策**: README.mdに「[VERIFIED]は突き合わせ済みだが実装時には必ず/verifyで最終確認」と明記済み。Phase 2ではDDLとの機械的突き合わせを実施予定

### Phase 1: カタログ基盤構築への批判

**DA-003: セキュリティ設計が「現行Streamlit前提」であり、新システムに誤用される可能性**

- **問題**: security.md は Streamlit の自動XSS対策・WebSocket前提のCSRF対策に言及しているが、新システム（React+FastAPI）ではこれらは適用されない。[DRAFT]ラベルがあるものの、実装時にStreamlit固有の記述を新システムの設計に持ち込むリスク
- **影響**: セキュリティ設計の根幹部分で誤った前提に基づく実装が生まれる
- **対策**: security.md に「新システムへの移行時の考慮事項」セクションを追加し、Streamlit固有の記述と汎用的な記述を明確に分離済み

### Phase 2: DB定義検証への批判

**DA-004: commission_adjustment テーブルがtables.mdに完全欠落していた**

- **問題**: DDLには`commission_adjustment`（歩合表の調整・残業代・手当を格納する30+カラムの重要テーブル）が定義されているが、元のtables.mdには**一切記載がなかった**。これは「LLM生成ドキュメントの信頼度65%」という評価が妥当だった証拠
- **影響**: もしPhase 2のDDL突き合わせを省略していたら、歩合計算の中核テーブルが仕様書から欠落したまま新システム設計に入るところだった
- **対策**: Phase 2でDDL全体を精査し追記完了。今後、tables.md以外のドキュメント（セキュリティ設計等）でも同様の欠落がないか注意が必要

**DA-005: 監査カラムの型不統一は新システム設計時のリスク**

- **問題**: DDL上、`created_by`/`updated_by` が一部テーブルではINTEGER（emp_id）、他ではVARCHAR（emp_no等）と混在。これは移行元の歴史的経緯だが、新システムでも踏襲すると型不統一が引き継がれる
- **影響**: 新システムのマイグレーション設計時に、どちらの型を標準にするか決めないとDB設計が一貫しない
- **対策**: tables.mdに型不統一の事実を記録済み。新システムDB設計時の決定事項として引き継ぐ

### Phase 3: 不足ドキュメント特定への批判

**DA-006: 「業務ロジックの仕様書」がカタログに存在せず、最もリスクが高い欠落**

- **問題**: カタログには画面一覧・DB定義・セキュリティ等の「構造」は揃ったが、「何をどう計算するか」の業務ロジック（歩合計算の歩合率テーブル、残業代の時間帯別割増計算、締め月の繰越ルール等）が一切ドキュメント化されていない。これらはコード中にしか存在しない
- **影響**: 新システムの実装で最も難しいのは画面やDB構造ではなく**計算ロジックの正確な再現**。カタログだけ見て移行計画を立てると、ロジック面の工数を大幅に過小評価するリスクがある
- **対策**: 次DD（DD-003候補）で「業務ロジックの仕様抽出」を最優先で実施する方向を提案。`/verify` を活用してコードから機械的にロジックを抽出する
