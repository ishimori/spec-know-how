# DD-003: 業務ロジックの仕様抽出

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2026-02-13 | 2026-02-13 | 完了 |

## 目的

移行元プロジェクト（`C:\repo\housing-e-kintai`）のソースコードから**業務ロジック**（計算式、ビジネスルール、ワークフロー）を抽出し、コード非依存の仕様書として `doc/spec/business-logic/` に文書化する。これにより、新システム（React + FastAPI）での再実装の根拠となる仕様基盤を確立する。

## 背景・課題

### 発端
- DD-002で構造的なカタログ（画面一覧、DB定義等）は整備済み
- しかし「何をどう計算するか」の業務ロジックが一切ドキュメント化されていない（DA-006で指摘）
- 業務ロジックはコード中にしか存在せず、新システムの移行で最も工数を過小評価するリスクが高い

### 課題
- 歩合計算が7ステージ（A〜L）・7パターンで最も複雑（約2,700行）
- 残業計算は60時間境界の日中/深夜分割で精密な仕様把握が必要
- 丸め方式（CEIL, ROUND_HALF_UP, FLOOR）が計算箇所により異なる
- 手入力フィールドのバックアップ/リストア等、暗黙の業務ルールが多い

## 検討内容

### アプローチ
1. ソースコードから機械的に関数・定数を抽出
2. ビジネスルール（BR-*）として形式化（コード依存の記述を排除）
3. テストシナリオで境界条件を網羅

### 並行処理戦略
- 依存関係のないモジュールは3並行スレッドで同時処理
- Phase 1（定数・残業・売上）→ Phase 2（歩合A-F, G-J, 承認/有休）→ Phase 3（K-L統合）

## 決定事項

1. 出力先: `doc/spec/business-logic/`（12ファイル）
2. 仕様書形式: ビジネスルール（BR-*）、入出力定義、定数参照、テストシナリオ
3. 信頼度ラベル: 初回作成時は [DRAFT]、コード突合後に [VERIFIED] 昇格
4. 並行処理: Phase 1で3スレッド、Phase 2で3スレッド

## タスク一覧

### Phase 0: 基盤準備
- [x] 📋 DD-003作成、`doc/spec/business-logic/` ディレクトリ作成
- [x] `README.md` + 仕様書テンプレート定義
- [x] 😈 **DA批判レビュー**

### Phase 1: 独立モジュール群（3並行スレッド）
- [x] **Thread A**: `00_constants.md` + `00_patterns.md`（定数・パターン）
- [x] **Thread B**: `01_overtime_payroll.md`（残業・給与計算）
- [x] **Thread C**: `02_sales_transaction.md`（売上・賃貸取引計算）
- [x] 😈 **DA批判レビュー**

### Phase 2: 歩合ステージ群（3並行スレッド）
- [x] **Thread D**: `03_commission_A_to_F.md`（ポイント給・管理系手当）
- [x] **Thread E**: `04_commission_G_to_J.md`（職種別歩合）
- [x] **Thread F**: `07_approval_workflow.md` + `08_paid_leave.md`（承認WF・有休管理）
- [x] 😈 **DA批判レビュー**

### Phase 3: 統合ステージ
- [x] `05_commission_K_to_L.md`（調整金・支給額合計）
- [x] `06_commission_orchestration.md`（歩合全体フロー・パターン統合）
- [x] 😈 **DA批判レビュー**

### Phase 4: 横断検証
- [x] 全仕様書の定数値一貫性チェック
- [x] `09_dependency_map.md`（依存マップ作成）
- [x] 最終DA批判レビュー
- [x] DD-003ログ更新・ステータス完了

## ログ

### 2026-02-13
- DD作成
- 移行元ソースコード全体の業務ロジック構造を調査済み
  - 歩合計算: 7ステージ(A-L), 6ファイル, 約2,700行
  - 残業計算: 489行のコア関数
  - 売上計算: 4つの純粋関数(79行)
  - 管理系: 物件取得、大規模修繕、緊急当番
  - 有休管理: 付与/消化/残日数
  - 承認WF: 勤怠承認、歩合承認
- Phase 0 完了: ディレクトリ構成、README.md、仕様書テンプレート作成
- **Phase 1 完了**: 3並行スレッドで4ファイル作成
  - Thread A: `00_constants.md`（全定数一覧）+ `00_patterns.md`（7パターン・給与パターン解決）
  - Thread B: `01_overtime_payroll.md`（残業計算 A,B1-B5,C,D,F,G）
  - Thread C: `02_sales_transaction.md`（売上計算4関数、白流れ、締め処理）
- **Phase 2 完了**: 3並行スレッドで4ファイル作成
  - Thread D: `03_commission_A_to_F.md`（ポイント給、緊急手当、管理ポイント、大規模修繕、管理取得、入金件数）
  - Thread E: `04_commission_G_to_J.md`（一般社員歩合、店舗責任者歩合、売買歩合、テナント歩合）
  - Thread F: `07_approval_workflow.md`（勤怠・歩合承認）+ `08_paid_leave.md`（有休付与・消化・残日数）
- **Phase 3 完了**: 2並行スレッドで2ファイル作成
  - `05_commission_K_to_L.md`（調整金K1-K15、支給額合計L1-L17、プレミアム残業L10-2）
  - `06_commission_orchestration.md`（再計算フロー、手入力バックアップ/リストア、パターン適用マトリクス）
- **Phase 4 完了**: 横断検証・DAレビュー
  - 定数値一貫性チェック: 全定数がファイル間で一致
  - 丸めルール一貫性チェック: CEIL/ROUND_HALF_UP/FLOOR の使い分けが整合
  - `09_dependency_map.md` 作成（データフロー図、カバレッジ表、未解決事項5件）
- **合計**: 12ファイル（README含む）、約4,331行のビジネスロジックを仕様化

### 2026-02-13（VERIFIED昇格）
- **全10仕様書を [DRAFT] → [VERIFIED] に昇格**（DA-005 対応）
- 検証ツール: ast_extractor, model_extractor, sql_extractor（`tools/verify/`）
- 検証フェーズ: A（基盤）→ B（独立4モジュール並行）→ C（歩合A-J並行）→ D（統合K-L並行）→ E（依存マップ更新）
- **検証結果**: 195+項目検証、全一致。差分26件（MEDIUM 8, LOW 11, MINOR 7）
  - MEDIUM差分のうち4件は仕様書修正済み、4件は注記として記録
  - **DA-004 L10-2（最高リスク項目）**: 全5係数・計算式・エッジケース3パス — 完全一致
- 仕様書修正4箇所:
  1. 01_overtime BR-001: is_off フラグの B1/B2 除外記述を実コードに合わせて修正
  2. 05_K-L BR-L-004: I5/J3 のラベル入れ替え（売買↔テナント）
  3. 07_approval BR-COM-003: 状態遷移 5→2 を 5→3 に修正
  4. 05_K-L BR-L-010: L16 合算の実行レイヤーを明記

---

## DA批判レビュー記録

<!-- DA批判レビューの手順・品質フィルター・再チェック条件は workflow/SKILL.md を参照 -->

### Phase 0 DA批判レビュー

**DA-001: 仕様書が「コードの翻訳」に陥るリスク**

- **問題**: ソースコードから仕様を抽出する作業は、無意識にコードの構造をそのまま仕様に転写しがち。例えば「for文で各行を処理」という記述は仕様ではなくコード翻訳
- **影響**: コード翻訳的な仕様書は新システムの設計自由度を制約し、Streamlit特有の実装パターンを引きずる
- **対策**: 各ビジネスルールは「BR-*: 〜である」の宣言的形式で記述。手続き的な記述（「まず〜し、次に〜する」）は計算手順セクションに限定する。レビュー時にコード用語（DataFrame, Session, Repository等）が混入していないか確認する

### Phase 1-2 DA批判レビュー

**DA-002: 並行スレッドで生成した仕様書間の用語・記法の不統一リスク**

- **問題**: 8つのスレッドが独立して仕様書を生成したため、同じ概念に対して異なる用語や記法を使う可能性がある。例えば「税抜金額」を「税抜合計」「税込前金額」「pre-tax amount」等と書き分けている可能性
- **影響**: 仕様書間で参照した際に同一概念か異なる概念か判断できず、実装時に混乱する
- **対策**: Phase 4の横断検証で主要用語の統一を確認。00_constants.md を正とし、他の仕様書が同一定数を異なる名称で参照していないかチェック済み

**DA-003: テストシナリオが仕様書ごとに閉じており、E2Eの連鎖テストが不足**

- **問題**: 各仕様書のテストシナリオは単体テスト的（Stage A単独、Stage G単独）。しかし実際の歩合計算はA→B-F→G-J→K→Lの連鎖であり、途中ステージの出力が次ステージの入力になる。この連鎖を通したテストシナリオが存在しない
- **影響**: 個々のステージは正しくても、連鎖時にデータ型の不一致や丸め誤差の蓄積で最終結果が現行システムと異なるリスク
- **対策**: 実装時にE2E統合テスト（パターン1〜7の各フルパス）を別途設計する。09_dependency_map.mdにデータフロー図を記載済みなので、テスト設計の参考になる

### Phase 3-4 DA批判レビュー

**DA-004: L10-2（プレミアム残業）の計算式が最も誤りやすい**

- **問題**: L10-2は「(歩合給+ポイント給+管理ポイント) / 総労働時間 × 加重係数付き残業時間」という複合計算で、分母（総労働時間）がゼロの場合の処理、加重係数（0.25/0.50/0.50/0.75/0.35）の正確性、FLOORの適用位置が全て正しくないと最終支給額が狂う
- **影響**: L10-2が間違うとL14（小計）→L17（最終支給額）が全て狂う。金額に直結するため最もリスクが高い
- **対策**: 05_commission_K_to_L.mdに加重係数の完全な一覧と計算手順を記載済み。実装時はdebug_L10_2.py（206行）も参照して検算する

**DA-005: 仕様書は全て [DRAFT] であり、機械的検証（/verify）は未実施**

- **問題**: 全11仕様書が [DRAFT] ステータスで、ソースコードとの機械的突合は実施していない。LLMによるコード読解に基づく抽出であり、読み落とし・誤解釈の可能性がある
- **影響**: 定数値の転記ミス、条件分岐の見落とし、マイナーなエッジケースの抜けがある可能性
- **対策**: 各仕様書を [VERIFIED] に昇格する際に `/verify functions` で関数シグネチャを機械的に抽出し、仕様書のビジネスルールとの1:1対応を確認する。→ **2026-02-13 実施済み**

### VERIFIED昇格プロセス DA批判レビュー

**DA-006: 構造検証のみで関数内部ロジックは未検証**

- **問題**: エクストラクタは関数シグネチャ、定数値、SQL操作を機械的に比較するが、関数内部の条件分岐・ループ・中間計算は検証対象外。例えば `compute_commission_adjust` の内部で「事務員判定後に K5-7 だけ計算」というロジックは、手動読解でしか確認できない
- **影響**: 条件分岐の記述ミスや閾値の誤記が VERIFIED でも見逃される可能性がある
- **軽減**: L10-2（最高リスク）は手動で全行読解して検証済み。他の関数内部ロジックは実装時のテスト仕様書（Spec to Test Spec）フェーズで検証する

**DA-007: UI層コードパスの検証が薄い**

- **問題**: 検証の主対象はバックエンドの計算関数とDB操作。UI層（Streamlit画面コード）での表示ロジック・入力変換・CANCEL マーカー処理等は一部のみ確認。02_sales の CANCEL 挙動（D-04）、07_approval のボタン制御はUI側のコードに依存
- **影響**: 新システムのフロントエンド設計時に、UI特有のルールが仕様から漏れる可能性
- **軽減**: 差分として記録済み。DD-005（アーキテクチャ設計）でフロントエンド仕様を別途整理

**DA-008: model_extractor の IntEnum 検出不可**

- **問題**: model_extractor は `@dataclass` と `get_pk_name()` を持つモデルクラスのみ検出する。`IntEnum`（ApprovalStatus, CommissionStatus）は自動検出されず、手動 Grep + Read で補完した
- **影響**: 今後の定数・Enum 追加時に同じ見落としリスクがある
- **軽減**: この制限は `tools/verify/` の既知制限として記録。必要に応じて model_extractor を IntEnum 対応に拡張する
