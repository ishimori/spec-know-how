# 気付きと教訓

> 実プロジェクトのリエンジニアリング経験から抽出したパターン集。固有の実装詳細は省き、他プロジェクトへの汎用的な適用を優先した。

---

## 早見表

| テーマ | 教訓 |
|-------|------|
| **仕様書の設計・品質** | AI が書き AI が読む / 信頼度ラベル / 差分は記録する / DRY 原則 / 正規化して書き逆引きで読む |
| **仕様抽出の落とし穴** | バリデーションは計算と同等 / 暗黙の業務ルール / Gate0 でスクリプト準備 / 認可マトリクスで記録 / 書き込みコードパスを追う |
| **AI 活用の効率化** | データ質がツール精度を決める / 最初の1画面でパターン確立 / AI に環境を自己診断させる / PoC は昇格設計で書く |
| **品質保証** | 仕様書の長期価値 / 機能仕様と UI パラダイムを分離 / 量産後に横断レビュー / DA 分析軸を変えて繰り返す |
| **うまくいかなかった点** | 画面仕様の定型化不足 / マスタデータの実値 / 識別子の日英不一致 |

---

## 仕様書の設計・品質

### AI が書き AI が読む — 一貫ループ

AI 自身が構造化ルールに従って書いた仕様書は、AI が正確に検索・引用できる。人間が書いた自然言語ドキュメントは AI にとって曖昧さの塊になりがちである。

**教訓**: AI に読ませるドキュメントは、AI に書かせるのが最も効率的かつ正確。

### 信頼度ラベルの重要性

「ドキュメントがある」と「信頼できるドキュメントがある」は全く異なる。ラベルなしでは使う前に毎回再検証が必要になる。

**教訓**: ドキュメントには必ず信頼度ラベルをつけよ。「ドキュメントがある」と「信頼できるドキュメントがある」は全く違う。

### 差分は消さずに記録する

仕様書とコードのズレを「修正して終わり」にすると、なぜズレが生まれたかの情報が失われ、将来の意思決定に使えなくなる。

**教訓**: 差分は消さずに記録せよ。「なぜ差分が生まれたか」の注記が、将来の意思決定を助ける。

### 仕様書でも DRY 原則

同じ定数値を複数の仕様書に書くと、変更時の修正漏れが不整合の温床になる。

**教訓**: 仕様書でも DRY 原則を守れ。同じ数値を複数の仕様書に書くと、不整合の温床になる。

### 正規化して書き、逆引きビューで読む

仕様書を正規化して書けば更新コストは低いが、「この計算の全体像は？」という問いには横断検索が必要になる。ER 図・業務フロー図・計算サマリーなどの逆引きビューがこのギャップを埋める。

**教訓**: 仕様書は正規化して書き、逆引きビューは非正規化して読む。DB 設計と同じ原則がドキュメント設計にも適用できる。

---

## 仕様抽出の落とし穴

### バリデーションは計算と同等に重要

バリデーションは UI 層（submit/save 関数）に混在しており、「計算関数を調査した」だけでは抽出できない。

**教訓**: バリデーションは「計算」ほど目立たないが、業務的には同等に重要なロジックである。画面実装時は移行元の submit/save 関数を全量精査し、「UI を作る」と「ルールを移植する」を明示的に分離すべき。

### コードに書かれていない暗黙の業務ルール

仕様書はコードを読んで業務ルールを抽出するが、「運用で暗黙に成立しているルール」はコードに書かれていないため抽出できない。

**教訓**: 仕様書は「コードに書かれた業務ルール」の抽出には優れるが、「運用で暗黙に成立しているルール」は守備範囲外。実装フェーズではドメインエキスパートへの確認工程を明示的に設けるべき。

### Gate0 で DB 解析スクリプトを用意する

LLM はコードを読んで「このフラグは 0/1 のみ」と推測するが、実データと乖離することがある。Gate0 でスクリプトがなければ後続 Gate で実測できない。

**教訓**: Gate0（初期設定）の時点で、後続 Gate で使う DB 解析スクリプト（Python）を用意しておけ。フラグ分布・テーブル統計・DB オブジェクト一覧の 3 本があれば、Gate2〜4 で推測を実測に置き換えられる。「後で実 DB アクセスしよう」と書くだけでは不十分。ツールがなければ実行できない。

### 認可マトリクスをマトリクスとして記録する

権限確認を「〇〇権限で表示制御あり」と書くだけでは、全ロール × 全画面の組み合わせが把握できず、後から再調査が必要になる。

**教訓**: Gate3 の権限確認では「認可マトリクスを旧システムの事実として記録する」を必須にせよ。記録する際は「旧システムの調査」であって「新システムの設計」ではないことを明示すること。

### 状態遷移の「書き込みコードパス」を追う

「どこに書き込まれるか」を確認しないと「書き込まれないバグ」が仕様書上で見えない。

**教訓**: Gate4 でフラグ・ステータスの状態遷移を仕様化する際は、各値への遷移を引き起こすコードパス（書き込み関数）もセットで確認せよ。特に「遷移しない場合」と「更新すべきだが更新されない場合」を批判的に検証すること。

---

## AI 活用の効率化

### AI ツールの精度はデータ質で決まる

QA スキルが高精度で機能するのは、スキル自体の複雑さではなく、仕様書の一意性・正確さ・検証記録によるものだ。

**教訓**: AI ツールの性能を引き出すのは、ツール自体の複雑さではなく、それが読むデータの質。

### 最初の1画面でパターンを確立する

最初の1画面で確立したパターンにバグがあれば全体に伝播し、パターンがなければ毎画面で同じ設計判断を繰り返す。

**教訓**: AI 主導開発では「最初の1画面」にパターン確立の時間をかけるべき。2画面目以降はパターン適用で桁違いに速くなる。パターンは暗黙知にせず、コード構造として定着させよ。

### AI に環境を自己診断させる

環境状態（DB の存在・マイグレーション適用済み等）が見えないと、AI は原因不明のエラーの前で時間を浪費する。

**教訓**: AI 主導開発では「AI が環境を自己診断できること」が生産性の前提条件。見えない環境で作業させると、原因不明のエラーに時間を浪費する。

### PoC は昇格できる構造で書く

PoC を「捨てる前提」で書くと、検証で得た設計知見がコードに残らず、本実装で同じ試行錯誤を繰り返す。

**教訓**: PoC は「動くか確認する」だけでなく「本実装に昇格できる構造」で書くべき。特にコンポーネント分割と型定義が昇格のしやすさを決める。

---

## 品質保証

### 仕様書は作った目的を超えた価値を持つ

業務ルールを構造化した仕様書は、移行後も仕様問い合わせ・オンボーディング・監査対応・影響範囲分析に使える。

**教訓**: コードの真実を構造化した仕様書は、作った目的を超えて長期的に価値を持つ。「移行のため」だけに作るのはもったいない。

### 機能仕様と UI パラダイムを分離する

移行元の画面構成はフレームワークの制約の産物であり、それを忠実に再現すると移行先の強みが死ぬ。

**教訓**: フレームワーク移行では、機能的な仕様（入力項目・計算ルール・業務フロー）は忠実に移植すべきだが、UI パラダイム（画面構成・操作動線）は移行先の強みに合わせて再設計すべき。「何ができるか」と「どう見せるか」を明確に分離せよ。

### 量産後に横断レビューを設ける

個別作業では「この画面は動く」で完了するが、同じ設計ミスが複数箇所に伝播していることは横断的に見ないと分からない。

**教訓**: 高速量産のあとには必ず横断レビューを設けよ。「完了」した個別作業の品質を信頼しすぎてはいけない。量産で生まれたパターンにバグがあれば、全体に伝播している。

### DA 批判レビューは分析軸を変えて繰り返す

表面的なチェックでバグが消えると「完了」に見えるが、動線・ビジネスフロー・リグレッションという軸で見ると深い問題が現れる。

**教訓**: DA 批判レビューは1回で終わらせず、分析軸を変えて繰り返すべき。特に修正を入れた後のリグレッション検証は必須。「もう問題ないだろう」という感覚は、表面的なバグが消えた時点で生まれやすい偽の安心感である。

---

## うまくいかなかった点・改善余地

### 画面仕様・権限マトリクスのカバー不足

業務ロジックの仕様書は高品質で作れたが、画面のアクセス制御や UI 仕様は仕様書化が不十分になりがちである。画面仕様はコードに散在しており、業務ロジックのような独立した関数として抽出しにくい。

**改善**: 画面 × 権限マトリクスの定型フォーマットを先に定義し、コードから埋めていく方式にする。

### マスタデータの具体値が不明

DB テーブル定義は抽出できても、マスタデータの具体値（各テーブルに実際に入っているコード値・名称）はコードからは取得できない。

**改善**: 本番 DB のマスタデータダンプ（個人情報除外）を仕様書に反映する工程を追加する。

### 識別子の日英不一致

DB の表示用ラベル（日本語）とコードの内部識別子（英語）が対応していないと、マッピングエラーが発生する。特権ロールでは問題が隠蔽され、一般ロールのみで顕在化する場合がある。

**改善**: 表示用ラベルと内部コードの分離を設計段階で強制する。マスタデータの具体値を仕様書に反映していれば、仕様抽出の時点で発見できることが多い。
