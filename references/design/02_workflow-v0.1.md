# spec-know-how 抽象化仕様抽出ワークフロー（v0.1）

## 1. 目的

特定プロジェクトから抽象化仕様情報を抽出するための標準フローを定義する。  
本フローは実作業を直接実装するものではなく、DDと抽出タスクを制御するオーケストレーターとして動作する。

---

## 2. 対象と非対象

## 対象
- 機能要件（FR）
- 非機能要件（NFR）
- QA向け根拠インデックス（回答・信頼度・参照行）

## 非対象
- 新システム実装DDの自動作成
- 実装計画の自動決定

---

## 3. 設計原則

1. FR/NFRの二軸で抽出する
2. ワークフローはオーケストレーターに徹する
3. 開始時に「移行元/移行先確認フェーズ」を必須化する
4. 機械抽出は可変戦略（プロジェクト適応型）にする
5. 生成物とQA回答は根拠と信頼度を必須にする

---

## 4. フェーズ定義

## Phase 0: システム確認ヒアリング（必須）

## 目的
抽出対象、抽出難易度、抽出方式、プロジェクト規模を確定する。

## 最低限の質問
1. 移行元: 言語/FW/DB/構成
2. 移行先: 言語/FW/DB/構成
3. 主対象ドメイン（勤怠/売上/給与など）
4. 重要NFR（ログ/セキュリティ/監査/性能/運用）
5. 既存ドキュメントの所在
6. コードアクセス範囲
7. 信頼性要件（どこまで機械裏付けが必要か）
8. 法務/機密/PII制約（持ち出し可否、匿名化要否、監査証跡要件）
9. **【新規】プロジェクト規模: 推定コード行数**
10. **【新規】ドメイン複雑性: シンプル / 複雑（複数ドメイン混在など）**

### 規模判定ロジック
上記 9-10 の回答に基づいて、下記のように進め方を分岐させる：

| コード規模 | ドメイン複雑性 | 推奨戦略 | 説明 |
|---------|------------|--------|------|
| <5K LOC | シンプル | **即座生成** | Phase 1 をスキップし、直接 Phase 2 以降に進む |
| 5K-50K LOC | シンプル | **標準進行** | Phase 1 で FR/NFR/UXM DD を起票し、段階実行 |
| 5K-50K LOC | 複雑 | **段階的実行** | Phase 1a で「全体構成 DD」を先に起票。その後ドメイン別に分割実行 |
| >50K LOC | 複雑 | **全体DD + 分割** | Phase 1a で全体 DD → ドメイン/機能領域別に分割 → 各領域の FR/NFR/UXM DD → 段階実行 |

## 成果物
- `project-profile`
- `extraction-scope`
- `extraction-strategy-draft`
- `compliance-constraints`

---

## Phase 1: 抽出計画の分割（FR/NFR/UXM）

## 目的
機能偏重を防ぎ、非機能要件を独立管理する。また、規模に応じた段階的実行体制を整える。

## Phase 0 の規模判定結果に応じた分岐

### **1a. 全体構成 DD の起票（規模判定で「段階的実行」または「全体DD+分割」の場合）**

**対象**: 中規模以上かつ複雑なプロジェクト
**成果物**:
- `DD-{ProjectName}-Architecture`: システム全体構成、ドメイン分割図
- この DD の成果をベースに Phase 1b で領域別に分割

### **1b. ドメイン/機能領域別の抽出 DD 起票**

規模に応じて以下のいずれかを実行：

#### **小規模（<5K LOC、シンプル）→ 統合 DD**
- `DD-FR-ALL`: 全機能要件を1つの DD で抽出
- `DD-NFR-ALL`: 全非機能要件を1つの DD で抽出
- `DD-UXM-ALL`: UI操作モデルを1つの DD で抽出（該当する場合）

#### **中～大規模（>5K LOC、複雑）→ 分割 DD**
1a で作成した「全体構成 DD」をベースに、領域ごとに分割：
- `DD-FR-Domain-A`: ドメイン A の機能要件
- `DD-NFR-Domain-A`: ドメイン A の非機能要件
- `DD-UXM-Domain-A`: ドメイン A の UI操作モデル
- `DD-FR-Domain-B`, ... （ドメイン数分繰り返し）

### **1c. 段階的実行のスケジュール確定**

複数 DD を起票した場合：
- **並行実行**: 領域 A と領域 B を同時進行可能
- **段階実行**: 優先度が高い領域から順次実行

オーケストレーターが実行順序を指定

---

## Phase 2: 機械抽出戦略の確定（可変型）

## 目的
移行元システムの構造差に応じた抽出方式を選定する。

## 選定観点
- 言語構造: AST / パターン / SQL
- データ層: ORM / SQL / migration
- UI層: 画面定義 / コンポーネント / イベント
- NFR層: ログ / 認可 / 例外経路

## オーケストレーター指示
- 候補モジュールを提示
- 人間に有効化モジュールを選択してもらう
- 選択を実行DDに落とす

---

## Phase 2.5: 抽出器妥当性検証（必須）

## 目的
抽出器の誤りを「High信頼度」に持ち込まないため、抽出器自体の品質を先に確認する。

## 実施内容
- サンプルケースでの期待値比較（ゴールデンケース）
- 既知パターンの回帰テスト
- 抽出対象外/失敗条件の明示
- **NFR項目の要件適合性サンプルチェック** — 「コードが存在する」と「要件を満たしている」は別。機械抽出がログ出力コードを発見しても監査要件を完全に満たすとは限らない。NFRに関しては人間が実装有無だけでなく要件適合性を確認する Gate を設ける

## 成果物
- `extractor-validation-report`
- `extractor-known-limitations`

---

## Phase 3: 機械抽出実行と証拠化

## 目的
LLM解釈と独立した事実データを得る。

## 実行内容（DD側）
- 関数/型/SQL/状態遷移/認可条件/ログポイント等の抽出
- 構造化出力（JSON等）
- 実行ログと再現手順の保存

## 成果物
- `machine-facts`
- `extraction-evidence`

---

## Phase 4: 抽象化仕様生成と突合

## 目的
抽象化仕様を生成し、機械抽出事実と突合する。

## 信頼度ルール（v1 — 4段階）

| 信頼度 | 定義 | 運用上のアクション |
|--------|------|-------------------|
| `High` | 妥当性検証済み抽出器で機械裏付けあり、参照明確 | そのまま利用可 |
| `Medium` | 一部裏付けあり、一部推論 | 注意付きで利用可、改善は任意 |
| `Low` | 根拠不足、未検証 | 利用前に調査が必要 |
| `Conflicting` | 根拠が存在するが相互に矛盾 | **解消するまで利用不可（ブロッキング）** |

> **設計根拠**: 旧3段階では `Low` が「未検証」と「矛盾あり」を混同していた。
> `Low` と `Not Verified` は実質同義（根拠不足≒未検証）だが、`Conflicting` は質的に異なる。
> 矛盾は「止まれ」を意味し、分離しないと既知の矛盾を無視して実装に進むリスクがある。

## 信頼度の降格ルール
- 根拠参照先のコードが変更された場合、当該仕様項目を `stale` にマークし再評価を要求する
- 一度 `High` と判定された項目も、根拠が無効化されれば降格対象となる
- 降格トリガーは Phase 5 の stale フラグ方式と共通の仕組みで運用する

## 最小出力
- 仕様項目
- 根拠参照（仕様書/コード行/抽出物）
- 信頼度（4段階）
- 未解消事項

---

## Phase 5: QAインデックス化

## 目的
仕様問い合わせに即答できる状態を作る。

## QA応答要件
1. 回答
2. 信頼度（4段階）
3. 根拠（該当ドキュメント/コード行）
4. 対象コミットSHA（短縮7桁）
5. 生成日時（UTC, ISO 8601）

## 信頼度の横断整合性ルール
- **QA回答の信頼度 ≦ 元仕様項目の信頼度** — 仕様項目が `Medium` なら QA回答も最大 `Medium`
- 仕様項目が `Conflicting` の場合、QA回答は矛盾を明示し断定しない

## 表示フォーマット

インライン回答時（コンパクトフッター）:
```
[回答本文]

---
信頼度: High | 根拠: backend/app/models/attendance.py:42-58 | 生成: 2025-01-15T10:30Z @ abc1234
```

監査レベルのメタ情報（フルSHA、抽出器バージョン、抽出手法名）は別ファイル/別セクションの監査ログに記録する。

## 追加要件
- 矛盾時は断定しない
- 必要時は追加質問を返す
- 根拠インデックスの鮮度情報を保持する

## QAインデックス鮮度管理（stale フラグ方式）

即時再生成ではなくマーキング優先で運用する。

| トリガー | 優先度 | アクション |
|---------|--------|-----------|
| 根拠参照先ファイルのコード変更 | 最高 | 該当QAエントリを `stale` にマーク |
| 仕様書の更新 | 高 | 関連QAエントリを `stale` にマーク |
| 抽出器の更新 | 中 | 全QAエントリを `potentially_stale` にマーク |
| リリース前チェック | 定期 | 全 `stale` エントリの再生成を強制 |

運用ルール:
- `stale` マークされたQAを参照する場合、回答に `stale（要再検証）` を自動付記
- リリース前Gate で `stale` が0件であることを完了条件とする
- 最終生成時刻と直近生成元コミットSHAを保持する

---

## Phase 6: 問題発見と継続ブラッシュアップ（反復）

## 目的
「既知の課題対応」だけでなく、生成AIにも問題発見を担わせ、解決条件を満たすまで改善を反復する。

## 実施内容
- 問題発見:
  - 仕様、抽出結果、QA応答を入力に blind spot を探索
  - 新規課題を問題発見バックログに記録
- 外部AI評価:
  - 複数LLMへ課題を投下し意見収集
  - 比較・統合して改善案を収束
- 収束管理:
  - 各課題に「解決条件（Acceptance Criteria）」を定義
  - 条件達成まで DD起票 -> 修正 -> 再評価をループ

## ポートフォリオ完了基準
個別課題ごとの解決条件とは別に、Phase 6 全体としての完了条件を定義する:
- `Conflicting` 信頼度の仕様項目が 0件
- 高重要度の未解決課題に全て対応方針（DD or 保留理由）がある
- 中重要度以下は未解決でも完了可（バックログに残す）

## 成果物
- 問題発見バックログ
- 外部AI評価記録
- 改善ログ（解決条件ベース）

---

## 5. 責務境界

## ワークフローが担うこと
- フェーズ制御
- 質問での前提確定
- DD起票指示
- 信頼度判定ルールの適用
- 鮮度判定と再生成トリガー管理
- 改善課題の収束管理（解決条件の達成確認）

## DD/抽出タスクが担うこと
- 抽出と解析の実行
- 証拠の記録
- 修正・再実行
