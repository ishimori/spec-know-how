# spec-know-how DD ポートフォリオワークフロー（v0.2）

## 1. 目的

レガシーコードベースから仕様を抽出するための標準フローを定義する。
v0.1 の「会話ベース Phase 進行」から、**DD ポートフォリオ一括作成モデル** に転換した。

---

## 2. v0.1 からの変更点

| 項目 | v0.1 | v0.2 |
|------|------|------|
| 進行モデル | 会話ベース Phase 0〜6 | DD ポートフォリオ一括作成 |
| 完了判定 | Gate 方式（Phase 間） | 依存関係ベース（DD 間） |
| ヒアリング | Phase 0 で質問 | Stage 1 DD で自動検出 |
| スキップ判断 | 会話で確認 | DD 内に記録 |
| DD 作成タイミング | Phase 進行に応じて逐次 | 起動時に全 12 DD を一括 |

---

## 3. 設計原則

1. **構造の中で判断する** — 会話で発見するのではなく、DD の中で考えさせる
2. **FR/NFR の二軸で抽出する** — 機能偏重を防ぐ
3. **機械検証で信頼度を裏付ける** — LLM 解釈のみで仕様化しない
4. **スキップも意思決定** — DD は削除せず、判断の痕跡を残す
5. **依存関係で実行順序を制御** — Gate 方式は廃止

---

## 4. DD ポートフォリオ

### 4.1 一覧

| DD | ステージ | 目的 | スキップ |
|----|----------|------|----------|
| ポートフォリオインデックス | 管理 | 全 DD の進捗・依存関係 | 不可 |
| 定量棚卸し | Stage 1 | コードベースの定量的把握 | 不可 |
| 分析スコープ | Stage 2 | 広さ・深さ・戦略の決定 | 不可 |
| FR 仕様抽出 | Stage 3 | 業務ロジック・ルール | 可 |
| データフロー抽出 | Stage 3 | データ経路・DB・外部連携 | 可 |
| 状態管理抽出 | Stage 3 | 画面状態・セッション・権限 | 可 |
| エラー処理抽出 | Stage 3 | バリデーション・例外処理 | 可 |
| 機械ツール設計 | Stage 4 | 自動抽出ツールの設計・作成 | 可 |
| 最終仕様 | Stage 5 | Stage 3 + 4 の突合・信頼度付与 | 可 |
| 移行先設計 | Post | アーキテクチャ設計 | 可 |
| NFR 総合レビュー | Post | 非機能要件の横断レビュー | 不可 |
| UI 要件 | Post | 業務アプリ UI パターン | 可 |

### 4.2 依存関係

```
Stage 1 → Stage 2 → Stage 3 群（並列可）
                   → Stage 4（Stage 3 と並列可）
                        ↓
                   Stage 5（Stage 3 + 4 完了後）
                        ↓
                   Post 群（並列可）
```

---

## 5. 起動プロトコル

1. ユーザーから対象コードベースのパスを受け取る
2. パスの存在確認と技術スタック自動検出
3. `templates/spec-know-how/` の全テンプレートから 12 DD を一括作成
4. ポートフォリオインデックス DD を初期化
5. Stage 1（定量棚卸し）を即座に実行開始

**会話による確認は行わない。** 不要な DD はスキップ判定で対応する。

---

## 6. DD 実行プロトコル

### 6.1 依存関係ベースの実行

- 各 DD の「前提 DD」が完了するまで実行しない
- 依存関係のない DD は並列実行可能

### 6.2 スキップ判定（2 パス方式）

**パス 1（作成時）**: 技術スタック自動検出で明らかなスキップ候補をマーク
**パス 2（実行時）**: 前提 DD 完了後にスキップ条件を再評価して最終判定

### 6.3 スキップの記録

- DD のステータスを「スキップ」に変更
- スキップ理由を「決定事項」セクションに記録
- ポートフォリオインデックス DD を更新
- **DD は削除しない**

---

## 7. 信頼度モデル

v0.1 から変更なし。4 段階（High/Medium/Low/Conflicting）。

### Stage 4 スキップ時の制約

機械裏付けがないため、全仕様項目の信頼度上限は Medium。

---

## 8. QA 応答要件

v0.1 から変更なし。回答 + 信頼度 + 根拠行 + コミット SHA + 生成日時。

---

## 9. 受入条件

1. ポートフォリオインデックス DD の全 DD が「完了」または「スキップ」
2. Conflicting 信頼度の仕様項目が 0 件
3. スキップされた DD に全てスキップ理由が記録されている
4. 実行された Stage 3 DD に信頼度サマリーが記入されている
5. QA 応答が根拠付きで再現可能（Stage 5 完了時）
6. 未解消事項が一覧化されている
