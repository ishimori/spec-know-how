# 02. 手法 — コード→仕様→QA パイプライン

---

## 全体像

```
┌─────────────────────────────────────────────────────────────────┐
│                     AI 駆動リエンジニアリング                      │
│                                                                   │
│  Phase 1: 知識基盤構築                                            │
│  ┌──────────┐    ┌───────────┐    ┌──────────┐    ┌──────────┐  │
│  │ 既存コード │ →  │ 機械的抽出 │ →  │ 仕様書化  │ →  │ 突合検証  │  │
│  │ (4,300行) │    │ AST/SQL   │    │ BR-xxx   │    │ VERIFIED │  │
│  └──────────┘    └───────────┘    └──────────┘    └──────────┘  │
│                                          │                        │
│                                          ▼                        │
│  Phase 2: 活用基盤                   ┌──────────┐                │
│  ┌──────────┐                       │ QA スキル │                │
│  │ 新規実装  │ ←── 仕様書を入力に ──│ 即時回答  │                │
│  └──────────┘                       └──────────┘                │
│                                          │                        │
│                                          ▼                        │
│  Phase 3: 継続運用                  ┌───────────┐               │
│                                     │ 知識基盤   │               │
│                                     │ 問い合わせ │               │
│                                     │ 保守引継ぎ │               │
│                                     └───────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: 知識基盤構築（5ステップ）

### Step 1: 機械的検証ツールの構築（DD-001）

コードから構造情報を自動抽出するツール群を最初に作る。

| ツール | 機能 | 出力 |
|--------|------|------|
| ast_extractor | Python AST を解析し、関数シグネチャ・定数・クラスを抽出 | JSON |
| sql_extractor | ソースコード中の SQL 文を抽出 | JSON |
| model_extractor | dataclass / Enum の定義を抽出 | JSON |

**ポイント**: 人間の「読解」ではなく**機械的な抽出**で始めることで、見落としを防ぐ。

### Step 2: 既存ドキュメントの棚卸し（DD-002）

既存ドキュメントを収集し、**信頼度ラベル**を付与する。

| ラベル | 意味 | 対応 |
|--------|------|------|
| [VERIFIED] | ソースコードと突合検証済み | そのまま使える |
| [DRAFT] | 未検証。参考程度 | 実装前に必ず検証が必要 |

**ポイント**: 「ドキュメントがある = 信頼できる」という思い込みを排除する。

### Step 3: 業務ロジックの仕様抽出（DD-003）

コードを読解し、以下の構造で仕様書を作成する。

```markdown
## ビジネスルール

**BR-001: ルール名**
ルールの説明。具体的な計算式・条件を含める。

## 定数参照
→ 00_constants.md を参照（定数は1箇所に集約）

## エッジケース
境界条件・異常系の挙動を明記

## 検証記録
| # | 検証項目 | 仕様書 | ソースコード | 判定 |
|---|---------|--------|------------|------|
| 1 | 関数シグネチャ | 3引数 | 一致 | OK |
```

**ポイント**: ビジネスルールに一意IDを振る（BR-xxx）。これにより QA で「根拠」を示せる。

### Step 4: ソースコードとの突合検証（VERIFIED 昇格）

Step 1 のツール出力と Step 3 の仕様書を突合し、差分を記録する。

```
仕様書の記述  ←→  ast_extractor の出力  →  一致 / 差分あり
```

差分があれば仕様書を修正し、修正内容を「差分・修正」セクションに記録する。全項目一致で [VERIFIED] に昇格。

### Step 5: QA スキルの構築

仕様書群の上に「質問→回答」のインターフェースを構築する。

```
ユーザーの質問
    ↓ キーワード抽出
関連する仕様書を特定（マッピング表）
    ↓ Read
該当ビジネスルール（BR-xxx）を抽出
    ↓ Grep + Read
移行元コードで裏取り
    ↓
突合レポート出力（根拠付き）
```

---

## 仕様書の設計原則

### 原則1: 機械可読性

AI が読んで正確に回答できる構造にする。

- ビジネスルールに一意ID（BR-xxx）を振る
- 計算式は曖昧さなく記述する: `B3 = min(B2, 3600)`
- 定数は散在させず `00_constants.md` に集約して参照する

### 原則2: 信頼度の明示

すべてのドキュメントに信頼度ラベルを付ける。「このドキュメントはどこまで信じていいのか」が一目でわかる状態にする。

### 原則3: 検証可能性

仕様書には必ず「検証記録」セクションを設ける。**誰が読んでも、同じ手順で再検証できる**状態を担保する。

### 原則4: 差分の記録

仕様書とコードの差分は消さずに記録する。なぜその差分が生まれたか（ドキュメントの陳腐化、コメントの不整合など）を注記することで、将来の判断材料になる。

---

## ツール・ファイル構成

```
project/
├── tools/verify/           # Step 1: 機械的検証ツール
│   ├── ast_extractor.py
│   ├── sql_extractor.py
│   └── model_extractor.py
│
├── doc/
│   ├── catalog/            # Step 2: 既存ドキュメント（信頼度ラベル付き）
│   │   ├── screens/
│   │   ├── database/
│   │   └── README.md       # ラベル運用ルール
│   │
│   ├── spec/               # Step 3-4: 検証済み仕様書
│   │   └── business-logic/
│   │       ├── 00_constants.md       # 定数基盤
│   │       ├── 00_patterns.md        # パターン定義
│   │       ├── 01_overtime_payroll.md # 残業計算 [VERIFIED]
│   │       ├── ...
│   │       └── 09_dependency_map.md  # 横断依存マップ
│   │
│   └── DD/                 # 設計判断の記録
│       ├── DD-001/         # 検証ツール設計
│       ├── DD-002/         # ドキュメント棚卸し
│       └── DD-003/         # 仕様抽出
│
├── .claude/
│   └── skills/
│       └── qa/             # Step 5: QA スキル
│
└── CLAUDE.md               # AI への指示書（ドキュメントマップ含む）
```

---

## CLAUDE.md の役割

`CLAUDE.md` はプロジェクトルートに置く AI への指示書であり、**ドキュメントマップ**の役割を果たす。

```markdown
## ドキュメントマップ
| DD | タイトル | 状態 | 主な成果物 |
| DD-003 | 業務ロジックの仕様抽出 | 完了 | doc/spec/business-logic/ 配下の10仕様書 |

## 利用可能なスキル
- /qa <質問> — 仕様書からの回答検索＋移行元コード突合検証
```

AI はこのファイルを**最初に読む**ため、どの仕様書がどこにあり、どのスキルが使えるかを即座に把握できる。これが QA スキルの精度を支える「インデックス」になっている。
