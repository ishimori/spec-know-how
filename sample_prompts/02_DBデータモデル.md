# サンプルプロンプト: Gate 2 — DB・データモデル

---

## DD 起票プロンプト

> コピーして Claude に貼り付けてください。`<コードベースのパス>` を実際のパスに置き換えてください。

```
以下の作業を DD に分割して起票・実行してください。
作業の粒度を判断し、適切な数の DD に分けてください（目安: 3〜4 DD）。
各 DD 完了時に DA 批判レビューを実施してください。

<コードベースのパス> のコードベースを分析し、DB・データモデルについて以下を行ってください。

> **事前スコープ確認**: テーブル数を概算で把握し、
> テーブル数が多い（目安: 30 以上）場合は、
> 調査範囲を分割した DD を提案してから作業を継続すること。
> 例: DD-A: スキーマ取得 / DD-B: テーブル詳細・ビュー / DD-C: マスタデータ確認

---

## 作業 1: スキーマの取得

- [ ] DDL または ERD を取得した（なければコードのモデル定義から読み取った）
- [ ] 主要テーブルの一覧を作成した（テーブル名と用途）
- [ ] 主要な外部キー関係（テーブル間の関連）を把握した

---

## 作業 2: テーブルの詳細確認

- [ ] 論理削除カラム（deleted_at、is_deleted 等）の有無を確認した
- [ ] ストアドプロシージャ・ビューを確認した（ある場合）
- [ ] マイグレーションファイルを確認した（ある場合）
- [ ] インデックス定義を確認した（パフォーマンスに影響する可能性）

---

## 作業 3: マスタデータの確認

- [ ] マスタテーブル（コード値・区分値を持つテーブル）を特定した
- [ ] マスタデータの具体値を確認した、または確認できない理由を記録した

---

## 作業 4: 実DBアクセスによる照合

> Gate0 で作成した `scripts/analyze/` のスクリプトをここで使う。
> コードからの推測だけでは見えない「実データの実態」を機械的に確認する。

- 実DBにアクセスできる場合:
  - [ ] `table_stats.py` を実行し、主要テーブルの件数をコード推測値と照合した
  - [ ] `flag_distribution.py` を実行し、フラグ・ステータス列の実際の値分布を確認した（予想外の値がないか）
  - [ ] `db_objects.py` を実行し、ストアドプロシージャ・ビューの実存在を DB レベルで確認した
- 実DBにアクセスできない場合:
  - [ ] その理由を記録した（環境なし・権限なし等）
  - [ ] 後続フェーズで実DB確認が必要な項目をこの DD 内にリストアップした（別 DD 不要）
- [ ] 作成した DB 仕様書ファイルを CLAUDE.md または document_map.md に追記した
```

---

## 完了前の確認プロンプト

> DD の作業がすべて完了したら、コピーして Claude に貼り付けてください。

```
以下のことを確認してください。

- [ ] 作成した DD にしか記録されていない情報がないこと
  DD は埋もれる可能性が高いため、DD だけが持っている情報は絶対に NG です。
  重要な情報は仕様書・コンテキストファイル等に必ず転記してください。
- [ ] 新たに作成したファイルが CLAUDE.md から辿れる構造になっていること
```

---

## 横断分析（Gate 宣言前に実施）

このフェーズで作成した全 DD を横断的に分析してください。

- [ ] 各 DD を横断し、個別調査では見えなかったパターン・矛盾・見落としを発見した
- [ ] 新たな課題が見つかった場合、新規 DD 起票または既存 DD 更新を行った

> 例：「複数の DD を組み合わせて初めて見えてくるパターン（例：テーブル構造 DD と区分値 DD を合わせると DB 制約なしの重大リスクが浮かぶ）を見逃さないこと。」

---

## Gate チェックリスト（人間が確認）

> コピー不要。各項目を目視確認してください。Gate 宣言 DD を起票する前に確認してください。

**確認タイミング**: Step 2（DB・データモデルを取得する）完了後

次のステップに進む前に、以下の項目を確認してください。

### スキーマの取得

- [ ] DDL または ERD を取得した（なければコードのモデル定義から読み取った）
- [ ] 主要テーブルの一覧を作成した（テーブル名と用途）
- [ ] 主要な外部キー関係（テーブル間の関連）を把握した

### テーブルの詳細確認

- [ ] 論理削除カラム（`deleted_at`、`is_deleted` 等）の有無を確認した
- [ ] ストアドプロシージャ・ビューを確認した（ある場合）
- [ ] マイグレーションファイルを確認した（ある場合）
- [ ] インデックス定義を確認した（パフォーマンスに影響する可能性）

### マスタデータの確認

- [ ] マスタテーブル（コード値・区分値を持つテーブル）を特定した
- [ ] マスタデータの具体値を確認した、または確認できない理由を記録した

> **なぜ重要か**: マスタデータの具体値が不明なまま進めると、識別子の不一致（日本語ラベル vs 英語コード等）が後から横断バグとして現れる。

### DA 批判レビュー（必須）

- [ ] このステップの成果物に対して DA 批判レビューを実施した（少なくとも1件の問題を発見・対応）

> DA 批判レビューの詳細は [manuals/01_仕様書作成マニュアル.md](../manuals/01_仕様書作成マニュアル.md) を参照。

---

### メモ欄

```
（例）
- テーブル数: 32個
- コアテーブル: users, orders, products, inventory
- マスタデータ: system_role テーブルに4種（一般社員/店舗責任者/総務部/役員）
  ※ コードの定数と日英が不一致している可能性あり → 要確認
- 本番DBへのアクセス不可のため、マスタデータは担当者へ確認中
```

---

## Gate 宣言 DD 起票プロンプト

> Gate チェックリストの確認が終わったら、コピーして Claude に貼り付けてください。`<確認結果の要約>` と `<未解決事項>` を実際の内容に置き換えてください。

```
以下の内容のDDを作ってください。

Gate 2（DB・データモデル）の通過を宣言します。

## 確認結果
- [ ] 上記の Gate チェックリストを確認した
- [ ] チェックリストの各項目の確認結果を記録した
- [ ] 作成した DB 仕様書ファイルを CLAUDE.md または document_map.md に追記した

## 判断
- 通過判定: 通過 / 条件付き通過 / 保留（いずれかを選択）
- 確認結果の要約: <確認結果の要約>
- 未解決事項（ある場合）: <未解決事項と解消計画>

## 次のステップ
- [ ] Step 4（業務ロジック抽出）に進む（Step 3 が完了している場合）
```
