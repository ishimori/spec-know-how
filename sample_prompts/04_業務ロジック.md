# サンプルプロンプト: Gate 4 — 業務ロジック

対応 Gate: [gates/04_business_logic.md](../gates/04_business_logic.md)

---

## DD 起票プロンプト

> `<コードベースのパス>` と `<仕様書の出力先>` を実際のパスに置き換えてください。

```
以下の内容のDDを作ってください。
各フェーズ完了時に DA 批判レビューを実施してください。

<コードベースのパス> のコードベースを分析し、業務ロジックを仕様書として抽出してください。
仕様書は <仕様書の出力先> に保存してください。

## 事前スコープ確認（必須）
- [ ] 主要な業務フロー・機能の数を概算で把握した
- 対象が多岐にわたる（目安: 主要フロー 5 以上、または処理系統が複数ある）場合は、
  機能・フロー単位で DD を分割することを提案してから作業を継続すること。
  例: DD-A: 申請・承認フロー / DD-B: 集計・レポートフロー

## 抽出の網羅性
- [ ] 主要な業務フロー（Happy Path）を仕様書に記述した
- [ ] 計算ロジック（料金計算・集計処理等）を仕様書に記述した
- [ ] バリデーションルール（入力制約・業務上の制約）を仕様書に記述した
- [ ] 状態遷移（ワークフロー・ステータス管理）を仕様書に記述した
- [ ] 外部システム連携（API 呼び出し・ファイル入出力）を仕様書に記述した

## フラグ・ステータスのライフサイクル確認

> 「複数の値が存在する」または「コードの複数箇所から書き込まれる」列を対象とする。
> LLM のコード読み取りは「想定値」であり、実際の書き込みパスと乖離する場合がある。

- [ ] 対象フラグ・ステータス列について以下を確認した（別 DD 不要・この DD 内に記録）:
  - 各値の業務的意味（0=○○、1=○○、2=○○ など）
  - その値になるコードパス（どの関数・メソッドが書き込むか）
  - 遷移条件（遷移しない場合・更新すべきだが更新されない設計バグを含む）
- [ ] Gate0 の `flag_distribution.py` を実行し、実データで想定外の値分布がないか確認した（実DBアクセス可能な場合）

## 信頼度の付与
- [ ] 仕様書の全項目に信頼度（High / Medium / Low / Conflicting）を付与した
- [ ] Conflicting（矛盾）の項目がある場合、解消計画を立てた

## コードとの突合
- [ ] High と記録した項目は、コードの該当箇所を確認済み
- [ ] Conflicting の項目が 0 件、または解消計画がある

## ドキュメントマップへの登録
- [ ] 作成した仕様書ファイルを CLAUDE.md または document_map.md に追記した

## DA 批判レビュー（必須）
- [ ] この DD の成果物に対して DA 批判レビューを実施した
- [ ] 少なくとも 1 件の問題・見落とし・不確実性を発見し、記録した
  視点例: 「UI レイヤーのバリデーションを見落としていないか」
       「Conflicting 項目の解消計画は十分か」
       「外部システム連携の境界条件が仕様化されているか」
```

---

## 横断分析（Gate 宣言前に実施）

このフェーズで作成した全 DD を横断的に分析してください。

- [ ] 各 DD を横断し、個別調査では見えなかったパターン・矛盾・見落としを発見した
- [ ] 新たな課題が見つかった場合、新規 DD 起票または既存 DD 更新を行った

> 例：「複数の DD を組み合わせて初めて見えてくるパターン（例：テーブル構造 DD と区分値 DD を合わせると DB 制約なしの重大リスクが浮かぶ）を見逃さないこと。」

---

## Gate 宣言 DD 起票プロンプト

> `<確認結果の要約>` と `<未解決事項>` を実際の内容に置き換えてください。

```
以下の内容のDDを作ってください。

Gate 4（業務ロジック抽出）の通過を宣言します。

## 確認結果
- [ ] gates/04_business_logic.md のチェックリストを確認した
- [ ] チェックリストの各項目の確認結果を記録した
- [ ] 作成した仕様書ファイルをすべて CLAUDE.md または document_map.md に追記した
- [ ] Conflicting 信頼度の項目が 0 件、または解消計画がある

## 判断
- 通過判定: 通過 / 条件付き通過 / 保留（いずれかを選択）
- 確認結果の要約: <確認結果の要約>
- 未解決事項（ある場合）: <未解決事項と解消計画>

## 次のステップ
- [ ] Step 5（非機能要件の確認）に進む
```
